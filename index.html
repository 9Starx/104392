<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="國際採購服務平台 - 專業代付服務平台，提供微信、支付寶、淘寶、阿里巴巴等平台的安全代付服務">
    <meta name="keywords" content="代付,支付寶,淘寶,阿里巴巴,跨境支付,微信支付,代購,國際採購">
    <meta name="author" content="國際採購服務平台">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="國際採購服務平台 - 專業代付服務">
    <meta property="og:description" content="提供安全可靠的國際採購代付服務，支援多種支付方式">
    <meta property="og:type" content="website">
    <title>國際採購服務平台 - 專業代付服務</title>

    <!-- DNS 預解析 -->
    <link rel="dns-prefetch" href="//www.gstatic.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">

    <!-- 預加載關鍵資源 -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" as="style">

    <!-- 樣式表 -->
    <style>
        /* 現代CSS架構 - 優化版本 */

        /* 緊湊精美設計變量 */
        :root {
            /* 精緻色彩系統 */
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --primary-light: #f0f0ff;
            --accent-color: #06d6a0;
            --accent-hover: #05c794;

            /* 狀態顏色 */
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --success-color: #22c55e;
            --info-color: #3b82f6;

            /* 精細化文字顏色 */
            --text-primary: #1a1a1a;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --text-light: #a0aec0;

            /* 現代背景系統 */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --bg-dark: #1e293b;

            /* 邊框系統 */
            --border-color: #e2e8f0;
            --border-hover: #cbd5e0;
            --border-focus: var(--primary-color);

            /* 精緻陰影系統 */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            /* 緊湊間距系統 */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;

            /* 圓角系統 */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;

            /* 精緻動畫 */
            --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.5;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--text-primary);
            font-size: 14px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: var(--space-4);
        }

        h1 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: var(--space-6);
            font-size: 1.875rem;
            font-weight: 700;
        }

        h2 {
            color: var(--text-primary);
            margin-bottom: var(--space-4);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: var(--space-5);
        }

        .form-group label {
            display: none;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            transition: var(--transition-fast);
            background: var(--bg-primary);
        }

        .input-wrapper input:user-invalid:not(:placeholder-shown) {
            border-color: var(--error-color);
        }

        .input-wrapper input:user-valid:not(:placeholder-shown) {
            border-color: var(--success-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            transition: var(--transition-fast);
            background: var(--bg-primary);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--border-focus);
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        button {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            padding: var(--space-3) var(--space-6);
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: var(--transition-fast);
            width: 100%;
            margin-top: var(--space-3);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
            position: relative;
            z-index: 1;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            user-select: none;
            min-height: 48px;
        }

        button:hover {
            background: linear-gradient(135deg, var(--primary-hover) 0%, #05c794 100%);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        button:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .submit-btn {
            font-size: 1rem;
            font-weight: 700;
            min-height: 52px;
            letter-spacing: 0.5px;
        }

        .header {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-4) var(--space-6);
            margin-bottom: var(--space-6);
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .header-left {
            display: flex;
            align-items: flex-end;
        }

        .header-left>*+* {
            margin-left: var(--space-4);
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .member-info {
            display: flex;
            align-items: center;
        }

        .member-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .member-status>*+* {
            margin-top: var(--space-1);
        }

        .member-level-badge {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: var(--shadow-sm);
        }

        .member-phone {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 600;
            align-self: flex-end;
        }

        .logout-btn {
            padding: var(--space-1) var(--space-3);
            background: linear-gradient(135deg, var(--error-color) 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            box-shadow: var(--shadow-sm);
            width: auto;
            margin: 0 0 0 auto;
        }

        .logout-btn i {
            margin-right: var(--space-1);
            font-size: 0.75rem;
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .tabs {
            display: flex;
            margin-bottom: var(--space-5);
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-1);
            box-shadow: var(--shadow-sm);
        }

        .tabs>.tab+.tab {
            margin-left: var(--space-1);
        }

        .tab {
            padding: var(--space-3) var(--space-5);
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            transition: var(--transition-fast);
            font-weight: 500;
            position: relative;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
        }

        .tab.active {
            color: var(--primary-color);
            background: var(--bg-primary);
            box-shadow: var(--shadow-sm);
        }

        .tab:hover:not(.active) {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.5);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .payment-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-5);
            transition: var(--transition-normal);
        }

        .payment-types.scroll-highlight {
            animation: gentlePulse 2s ease-in-out;
            animation-fill-mode: both;
        }

        @keyframes gentlePulse {
            0% {
                box-shadow: 0 0 0 0 rgba(79, 70, 229, 0);
                transform: translateZ(0);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(79, 70, 229, 0.1);
                transform: translateZ(0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(79, 70, 229, 0);
                transform: translateZ(0);
            }
        }



        .payment-type-card {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            text-align: center;
            cursor: pointer;
            transition: var(--transition-normal);
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .payment-type-card>*+* {
            margin-top: var(--space-3);
        }

        .payment-type-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            background: linear-gradient(135deg, #ffffff 0%, var(--bg-secondary) 100%);
        }

        .payment-type-card.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .payment-type-card.selected h3 {
            color: white;
        }

        .payment-type-card img {
            width: 64px;
            height: 64px;
            object-fit: contain;
            transition: var(--transition-normal);
            border: none;
            outline: none;
        }

        .payment-type-card h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            transition: var(--transition-normal);
            display: none;
        }

        .payment-type-card h3.show-text {
            display: block;
        }

        .payment-type-card:hover img {
            transform: scale(1.1);
        }

        .payment-type-card p {
            margin: var(--space-1) 0 0;
            color: var(--text-muted);
            font-size: 0.875rem;
        }


        /* 響應式設計 */
        @media (max-width: 768px) {
            .container {
                padding: var(--space-3);
            }

            .header {
                flex-direction: column;
                padding: var(--space-4);
            }

            .header>*+* {
                margin-top: var(--space-4);
            }

            .header-left {
                flex-direction: column;
                align-items: center;
            }

            .header-left>*+* {
                margin-left: 0;
                margin-top: var(--space-2);
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .logout-btn {
                margin-left: var(--space-1) !important;
            }

            .payment-types {
                grid-template-columns: 1fr;
                gap: var(--space-3);
            }

            .payment-type-card {
                padding: var(--space-4);
            }

            .payment-type-card img {
                width: 48px;
                height: 48px;
            }

            .benefits-grid {
                grid-template-columns: 1fr;
                gap: var(--space-4);
            }

            .benefit-tier {
                padding: var(--space-5);
                border-radius: var(--radius-xl);
            }

            .tier-header {
                margin-bottom: var(--space-4);
            }

            .tier-icon {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .tier-info h4 {
                font-size: 1rem;
                margin-bottom: var(--space-2);
            }

            .tier-condition {
                font-size: 0.875rem;
            }

            .tier-rate {
                margin: var(--space-4) 0;
            }

            .rate-value {
                font-size: 1.5rem;
            }

            .benefit-tier.current::before {
                top: var(--space-3);
                right: var(--space-3);
                padding: var(--space-2) var(--space-3);
                font-size: 0.75rem;
            }

            .tabs {
                padding: var(--space-1);
            }

            .tab {
                padding: var(--space-2) var(--space-4);
                font-size: 0.8rem;
            }
        }

        .order-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--space-5);
            margin-top: var(--space-5);
        }

        .order-item {
            background: var(--bg-primary);
            padding: var(--space-5);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            transition: var(--transition-normal);
            border: 1px solid var(--border-color);
        }

        .order-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .order-item h3 {
            margin: 0 0 var(--space-4) 0;
            color: var(--text-primary);
            font-size: 1rem;
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--border-color);
        }

        .order-info {
            display: flex;
            flex-direction: column;
        }

        .order-info>*+* {
            margin-top: var(--space-2);
        }

        .order-info p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.875rem;
            display: flex;
            justify-content: space-between;
        }

        .order-info .label {
            color: var(--text-light);
            font-weight: 500;
        }

        .order-info .value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .order-status {
            display: inline-flex;
            align-items: center;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: var(--space-4);
            text-align: center;
            width: 100%;
            justify-content: center;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-processing {
            background-color: #cce5ff;
            color: #004085;
        }

        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }

        .status-suspended {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .order-item-action-btn {
            width: 100%;
            margin-top: var(--space-3);
            padding: var(--space-2) var(--space-4);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }

        .order-item-action-btn:hover {
            background: linear-gradient(135deg, var(--primary-hover) 0%, #05c794 100%);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .calculated-amount {
            background: var(--bg-secondary);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            margin-top: var(--space-3);
            border: 1px solid var(--border-color);
        }

        .calculated-amount p {
            margin: var(--space-1) 0;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.875rem;
        }



        .member-benefits-display {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-5);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .benefits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-3);
        }

        .benefit-tier {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .benefit-tier.current {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.05) 0%, rgba(6, 214, 160, 0.05) 100%);
            box-shadow: var(--shadow-md);
        }

        .benefit-tier.current::before {
            content: '當前等級';
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: 0.625rem;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }

        .benefit-tier:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .tier-header {
            display: flex;
            align-items: center;
            margin-bottom: var(--space-3);
        }

        .tier-header>*+* {
            margin-left: var(--space-2);
        }

        .tier-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: white;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
        }

        .tier-icon.basic {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        }

        .tier-icon.ten-thousand {
            background: linear-gradient(135deg, var(--accent-color) 0%, #059669 100%);
        }

        .tier-icon.fifty-thousand {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .tier-icon.negotiable {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
            animation: negotiableGlow 2s ease-in-out infinite alternate;
        }

        @keyframes negotiableGlow {
            from {
                box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
            }

            to {
                box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
            }
        }

        /* 議價會員卡片特殊效果 */
        .benefit-tier.negotiable-tier {
            position: relative;
            border: 2px solid transparent;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(124, 58, 237, 0.05) 100%);
            overflow: hidden;
        }

        .benefit-tier.negotiable-tier::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.1), transparent);
            animation: negotiableShimmer 3s ease-in-out infinite;
        }

        @keyframes negotiableShimmer {
            0% {
                left: -100%;
            }

            50% {
                left: 100%;
            }

            100% {
                left: 100%;
            }
        }

        /* 其他平台專用樣式 */
        .others-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: var(--space-4);
            margin-top: var(--space-2);
        }

        .others-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            border: 1px solid var(--border-color);
        }

        .section-title {
            display: flex;
            align-items: center;
            margin: 0 0 var(--space-3) 0;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .section-title>*+* {
            margin-left: var(--space-2);
        }

        .section-title i {
            color: var(--primary-color);
            font-size: 1rem;
        }

        .contact-support {
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            min-height: 200px;
        }

        .support-description {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin: var(--space-3) 0 0 0;
            line-height: 1.4;
            text-align: center;
        }

        .contact-support-btn {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #06C755 0%, #05a548 100%);
            color: white;
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-lg);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.875rem;
            transition: var(--transition-normal);
            box-shadow: var(--shadow-sm);
            margin: 0 0 var(--space-3) 0;
            white-space: nowrap;
            min-height: 44px;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        }

        .contact-support-btn:hover {
            background: linear-gradient(135deg, #05a548 0%, #047d3a 100%);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            color: white;
            text-decoration: none;
        }

        .contact-support-btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .contact-support-btn i {
            font-size: 1.25rem;
            margin-right: 0.5rem;
            vertical-align: middle;
            line-height: 1;
        }

        .others-container .upload-card {
            margin-top: 0;
        }

        .others-container .upload-card .upload-icon p {
            font-size: 0.875rem;
            margin-bottom: var(--space-1);
        }

        .others-container .upload-card .upload-icon small {
            font-size: 0.75rem;
            color: var(--text-light);
            display: block;
        }

        @media (max-width: 1200px) and (min-width: 969px) {
            .others-container {
                grid-template-columns: 1fr 1fr;
                gap: var(--space-3);
            }

            .others-section:last-child {
                grid-column: span 2;
                max-width: 50%;
                margin: 0 auto;
            }
        }

        @media (max-width: 968px) {
            .others-container {
                grid-template-columns: 1fr;
                gap: var(--space-3);
            }

            .others-section {
                padding: var(--space-3);
            }

            .contact-support {
                min-height: auto;
                padding: var(--space-4) var(--space-2);
            }

            .contact-support-btn {
                width: 100%;
                max-width: 200px;
                padding: 12px 20px;
                font-size: 0.9rem;
                min-height: 48px;
                justify-content: center;
                margin: 0 auto var(--space-3) auto;
                border: none;
                outline: none;
            }

            .contact-support-btn i {
                font-size: 1.1rem;
                margin-right: 6px;
            }

            .support-description {
                font-size: 0.8rem;
                padding: 0 var(--space-2);
                line-height: 1.3;
            }
        }

        @media (max-width: 480px) {
            .contact-support-btn {
                width: 100%;
                max-width: 180px;
                padding: 10px 16px;
                font-size: 0.85rem;
                min-height: 44px;
            }

            .contact-support-btn i {
                font-size: 1rem;
                margin-right: 4px;
            }

            button,
            .submit-btn {
                min-height: 50px;
                font-size: 1rem;
                appearance: none;
                border: none;
                outline: none;
                pointer-events: auto;
                z-index: 10;
                position: relative;
            }

            button:disabled,
            .submit-btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                -webkit-tap-highlight-color: transparent;
            }


        }

        @media screen and (min-resolution: 1dppx) {
            button {
                border-radius: var(--radius-lg);
            }
        }

        .tier-info h4 {
            margin: 0 0 var(--space-1) 0;
            color: var(--text-primary);
            font-size: 0.8rem;
            font-weight: 600;
            line-height: 1.2;
        }

        .tier-condition {
            color: var(--text-muted);
            font-size: 0.7rem;
            margin: 0;
            line-height: 1.2;
        }

        .tier-rate {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: var(--space-3) 0 var(--space-2) 0;
        }

        /* 當有解鎖標識時，使用水平布局 */
        .tier-rate.has-unlock {
            flex-direction: row;
            justify-content: center;
            gap: var(--space-2);
        }

        /* 響應式保護：小螢幕時恢復垂直布局 */
        @media (max-width: 480px) {
            .tier-rate.has-unlock {
                flex-direction: column;
                gap: var(--space-1);
            }
        }

        .rate-value {
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: inline-block;
            line-height: 1.2;
            align-self: center;
            /* 在水平布局中垂直居中 */
        }

        .rate-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: var(--space-1);
        }

        /* 解鎖的議價會員費率樣式 */
        .rate-value.unlocked-rate {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            animation: unlockGlow 2s ease-in-out infinite alternate;
        }

        .unlock-badge {
            display: inline-block;
            font-size: 0.6rem;
            color: #10b981;
            font-weight: 600;
            text-align: center;
            animation: badgePulse 1.5s ease-in-out infinite;
            white-space: nowrap;
            align-self: center;
            /* 在水平布局中垂直居中 */
        }

        .unlock-badge i {
            margin-right: 2px;
            font-size: 0.55rem;
        }

        @keyframes unlockGlow {
            0% {
                filter: brightness(1);
                transform: scale(1);
            }

            100% {
                filter: brightness(1.1);
                transform: scale(1.02);
            }
        }

        @keyframes badgePulse {

            0%,
            100% {
                opacity: 0.7;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.05);
            }
        }

        /* 解鎖狀態的條件說明文字 */
        .tier-condition.unlocked-condition {
            color: #10b981;
            font-weight: 600;
            animation: conditionGlow 3s ease-in-out infinite;
        }

        @keyframes conditionGlow {

            0%,
            100% {
                color: #10b981;
            }

            50% {
                color: #059669;
            }
        }

        /* 表單提示文字 */
        .form-text {
            display: block;
            margin-top: 5px;
            color: var(--text-muted);
            font-size: 12px;
        }

        /* 分隔線文字 */
        .divider-text {
            text-align: center;
            margin: var(--space-3) 0;
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* 錯誤訊息 */
        .error-message {
            text-align: center;
            color: var(--text-muted);
            padding: var(--space-5);
            font-size: 0.875rem;
        }

        /* 更新全局的 input:invalid 樣式，使其在用戶交互後生效 */
        input:not(:placeholder-shown):invalid,
        input:focus:invalid {
            border-color: var(--error-color);
        }

        input:not(:placeholder-shown):invalid+.form-text,
        input:focus:invalid+.form-text {
            color: var(--error-color);
        }

        input[readonly] {
            background: var(--bg-tertiary);
            cursor: not-allowed;
            color: var(--text-muted);
        }

        /* 移除數字輸入框的上下箭頭 */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            appearance: none;
            margin: 0;
        }

        input[type="number"] {
            appearance: textfield;
        }

        /* 隱藏元素 */
        .hide {
            display: none !important;
        }

        /* 表單按鈕區域 */
        .form-actions {
            margin-top: var(--space-6);
        }

        /* 編輯模式按鈕組 */
        .edit-actions {
            display: none;
            /* 初始隱藏 */
            gap: var(--space-3);
            margin-top: var(--space-6);
        }

        .edit-actions.active {
            display: flex;
        }

        .edit-actions .submit-btn {
            flex: 1;
            margin-top: 0;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .edit-actions .submit-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .cancel-btn {
            flex: 1;
            padding: var(--space-4);
            background: #6b7280;
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-md);
            min-height: 52px;
        }

        .cancel-btn:hover {
            background: #4b5563;
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .cancel-btn:active,
        .edit-actions .submit-btn:active {
            transform: translateY(0);
        }

        /* 訂單號碼顯示 */
        .order-number-display {
            display: inline-block;
            margin-left: 10px;
        }

        .order-number-display span {
            font-family: 'SF Mono', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 1.125rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        /* 支付專用欄位 */
        .payment-fields {
            display: none;
            margin-top: var(--space-5);
            padding: var(--space-4);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            background: var(--bg-secondary);
        }

        .payment-fields.active {
            display: block;
        }

        .payment-fields .form-group {
            margin-bottom: var(--space-4);
        }

        .payment-fields label {
            display: block;
            margin-bottom: var(--space-1);
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.875rem;
        }

        /* 輸入卡片 */
        .input-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            transition: var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }

        .input-card:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }

        .input-card input[type="text"] {
            width: 100%;
            padding: var(--space-2);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
        }

        .input-card input[type="text"]:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        /* 新增的樣式 */
        .form-row-flex {
            display: flex;
            align-items: center;
            margin-bottom: var(--space-3);
        }

        .form-row-flex>*+* {
            margin-left: var(--space-3);
        }

        .form-row-flex:last-child {
            margin-bottom: 0;
        }

        .label-text {
            min-width: 80px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.875rem;
        }

        .flex-input {
            flex: 1;
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            transition: var(--transition-fast);
            background: var(--bg-primary);
        }

        .flex-input:focus {
            border-color: var(--border-focus);
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .readonly-clickable {
            background: var(--bg-tertiary);
            cursor: pointer;
            color: var(--text-muted);
            user-select: none;
        }

        .readonly-clickable:hover {
            background: var(--bg-secondary);
            cursor: pointer;
        }

        /* 上傳卡片 */
        .upload-card {
            background: var(--bg-primary);
            border: 2px dashed var(--primary-color);
            border-radius: var(--radius-lg);
            padding: var(--space-8);
            text-align: center;
            cursor: pointer;
            transition: var(--transition-normal);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .upload-card>*+* {
            margin-top: var(--space-4);
        }

        .upload-card:hover {
            background: rgba(79, 70, 229, 0.05);
            border-color: var(--primary-hover);
        }

        .upload-card i {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: var(--space-3);
        }

        .upload-card p {
            margin: 0;
            color: var(--text-muted);
        }

        .preview-image {
            max-width: 100%;
            max-height: 200px;
            margin: var(--space-3) auto;
            border-radius: var(--radius-md);
            display: none;
            object-fit: contain;
            box-shadow: var(--shadow-sm);
        }

        .preview-image.show {
            display: block;
        }

        .upload-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .upload-icon.hide {
            display: none;
        }

        input[type="file"] {
            display: none;
        }

        /* 緊湊精美成功模態框 */
        .success-modal {
            max-width: 420px;
            padding: 0;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .success-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            padding: var(--space-6);
            display: flex;
            align-items: center;
            color: white;
        }

        .success-header>*+* {
            margin-left: var(--space-4);
        }

        .success-icon {
            font-size: 2.5rem;
            color: white;
            flex-shrink: 0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .success-info {
            flex: 1;
            text-align: left;
        }

        .success-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            margin: 0 0 var(--space-1) 0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .order-number {
            font-family: 'SF Mono', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            letter-spacing: 0.5px;
        }

        .success-close-btn {
            width: 100%;
            background: var(--bg-primary);
            color: var(--primary-color);
            border: none;
            padding: var(--space-4);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
            margin: 0;
            border-radius: 0;
        }

        .success-close-btn:hover {
            background: var(--bg-secondary);
            color: var(--primary-hover);
            transform: none;
            box-shadow: none;
        }

        /* 模態框 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background: var(--bg-primary);
            margin: 10% auto;
            padding: var(--space-8);
            width: 90%;
            max-width: 500px;
            border-radius: var(--radius-xl);
            text-align: center;
            box-shadow: var(--shadow-xl);
            position: relative;
        }





        .no-orders {
            text-align: center;
            padding: var(--space-10);
            color: var(--text-muted);
            font-size: 1rem;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            grid-column: 1 / -1;
        }

        /* Toast 通知 */
        .toast {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            background: var(--text-primary);
            color: white;
            padding: var(--space-4) var(--space-6);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            font-size: 1rem;
            min-width: 200px;
        }

        .toast>*+* {
            margin-left: var(--space-3);
        }

        .toast.show {
            opacity: 1;
        }

        .toast i {
            font-size: 1.5rem;
        }

        /* 主內容區域 */
        .main-content {
            display: none;
            min-height: 100vh;
        }

        .main-content.active {
            display: block;
        }

        /* 緊湊精美登入頁面設計 */
        .login-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
        }

        .login-wrapper {
            width: 100%;
            max-width: 400px;
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .brand-section {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            padding: var(--space-5);
            text-align: center;
            color: white;
            position: relative;
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        }

        .brand-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        }

        .brand-content {
            position: relative;
            z-index: 1;
        }

        .brand-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 6px;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .brand-subtitle {
            font-size: 14px;
            color: white;
            opacity: 0.9;
            margin-bottom: 16px;
        }

        .brand-features {
            display: flex;
            justify-content: space-around;
        }

        .brand-features>*+* {
            margin-left: 12px;
        }

        .feature-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 11px;
            color: white;
            flex: 1;
        }

        .feature-item>*+* {
            margin-top: 4px;
        }

        .feature-item i {
            font-size: 16px;
            color: white;
            opacity: 0.9;
        }

        .login-section {
            background: var(--bg-primary);
            padding: var(--space-5);
            border-radius: 0 0 var(--radius-xl) var(--radius-xl);
        }

        .login-form {
            width: 100%;
        }

        .login-title {
            font-size: 16px;
            margin-bottom: 16px;
            color: var(--text-primary);
            text-align: center;
            font-weight: 600;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form .input-wrapper input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s ease;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .login-form .input-wrapper input:focus {
            border-color: var(--primary-color);
            background: var(--bg-primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .login-form .input-wrapper input::placeholder {
            color: var(--text-muted);
        }

        .member-benefits {
            margin-top: 20px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .benefit-cards {
            display: flex;
            flex-direction: column;
        }

        .benefit-cards>*+* {
            margin-top: 8px;
        }

        .benefit-card {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .benefit-card>*+* {
            margin-left: 12px;
        }

        .benefit-card:hover {
            background: var(--bg-secondary);
            border-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .card-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-color);
            border-radius: 6px;
            font-size: 14px;
            color: white;
            flex-shrink: 0;
        }

        .card-content {
            flex: 1;
            min-width: 0;
        }

        .card-content h4 {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 2px 0;
            color: var(--text-primary);
        }

        .description {
            font-size: 12px;
            color: var(--text-muted);
            margin: 0;
            line-height: 1.3;
        }

        /* 響應式設計 */
        @media (max-width: 480px) {
            .login-container {
                padding: 12px;
            }

            .login-wrapper {
                max-width: 100%;
            }

            .brand-section {
                padding: 20px;
            }

            .brand-title {
                font-size: 24px;
            }

            .brand-features>*+* {
                margin-left: 8px;
            }

            .feature-item {
                font-size: 10px;
            }

            .login-section {
                padding: 20px;
            }

            .benefit-cards>*+* {
                margin-top: 6px;
            }

            .benefit-card {
                padding: 10px;
            }
        }

        /* 暫停會員模態框樣式 */
        .suspension-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            pointer-events: none;
        }

        .suspension-modal-content {
            background: var(--bg-primary);
            margin: 20% auto;
            padding: 24px;
            width: 90%;
            max-width: 360px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.3s ease-out;
            pointer-events: auto;
            border: 1px solid var(--border-color);
        }

        .modal-close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            border: none;
            background: none;
            color: #9ca3af;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
            z-index: 1;
        }

        .modal-close-btn:hover {
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .modal-close-btn i {
            font-size: 16px;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .suspension-icon {
            font-size: 36px;
            color: #f59e0b;
            margin-bottom: 12px;
        }

        .suspension-modal-content h2 {
            color: #1f2937;
            font-size: 18px;
            margin-bottom: 8px;
            font-weight: 600;
            line-height: 1.4;
        }

        .suspension-message {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .suspension-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .suspension-actions>*+* {
            margin-top: 8px;
        }

        .call-support-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #06C755;
            color: white;
            padding: 10px 24px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
            min-width: 100px;
        }

        .call-support-btn i {
            margin-right: 6px;
        }

        .call-support-btn:hover {
            background-color: #05a548;
            transform: translateY(-1px);
        }

        .call-support-btn i {
            font-size: 16px;
        }

        @media (max-width: 480px) {
            .suspension-modal-content {
                margin: 25% auto;
                padding: 20px 16px;
                max-width: 320px;
            }

            .suspension-icon {
                font-size: 32px;
                margin-bottom: 10px;
            }

            .suspension-modal-content h2 {
                font-size: 16px;
                margin-bottom: 6px;
            }

            .suspension-message {
                font-size: 13px;
                margin-bottom: 16px;
            }

            .modal-close-btn {
                top: 10px;
                right: 10px;
                width: 24px;
                height: 24px;
            }

            .modal-close-btn i {
                font-size: 14px;
            }

            .call-support-btn {
                padding: 8px 20px;
                font-size: 13px;
                min-width: 80px;
            }

            .success-modal {
                max-width: 90%;
                margin: 20% auto;
            }

            .success-header {
                padding: var(--space-4);
            }

            .success-header>*+* {
                margin-left: var(--space-3);
            }

            .success-icon {
                font-size: 2rem;
            }

            .success-title {
                font-size: 1.125rem;
            }

            .order-number {
                font-size: 0.875rem;
            }
        }

        /* 檔案錯誤提示模態框 */
        .file-error-modal {
            display: none;
            position: fixed;
            z-index: 1100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
        }

        .file-error-content {
            background: var(--bg-primary);
            margin: 25% auto;
            padding: var(--space-6);
            width: 90%;
            max-width: 360px;
            border-radius: var(--radius-xl);
            text-align: center;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            animation: fileErrorSlideIn 0.3s ease-out;
        }

        @keyframes fileErrorSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .file-error-icon {
            font-size: 2.5rem;
            color: var(--error-color);
            margin-bottom: var(--space-3);
        }

        .file-error-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }

        .file-error-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-5);
            line-height: 1.4;
        }

        .file-error-close-btn {
            background: linear-gradient(135deg, var(--error-color) 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }

        .file-error-close-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* 統一提示模態框樣式（避免與檔案錯誤模態框衝突） */
        .unified-modal {
            display: none;
            position: fixed;
            z-index: 1120;
            /* 比檔案錯誤模態框更高的層級 */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
        }

        .unified-modal-content {
            background: var(--bg-primary);
            margin: 25% auto;
            padding: var(--space-6);
            width: 90%;
            max-width: 360px;
            border-radius: var(--radius-xl);
            text-align: center;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            animation: unifiedModalSlideIn 0.3s ease-out;
        }

        @keyframes unifiedModalSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .unified-modal-icon {
            font-size: 2.5rem;
            margin-bottom: var(--space-3);
        }

        .unified-modal-icon.error {
            color: #f59e0b;
            /* 警告色，區別於檔案錯誤的紅色 */
        }

        .unified-modal-icon.success {
            color: var(--success-color);
        }

        .unified-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }

        .unified-modal-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-5);
            line-height: 1.4;
        }

        .unified-modal-btn {
            border: none;
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
            box-shadow: var(--shadow-sm);
            color: white;
        }

        .unified-modal-btn.error {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .unified-modal-btn.error:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .unified-modal-btn.success {
            background: linear-gradient(135deg, var(--success-color) 0%, #16a34a 100%);
        }

        .unified-modal-btn.success:hover {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        @media (max-width: 480px) {

            .file-error-content,
            .unified-modal-content {
                margin: 30% auto;
                padding: var(--space-5);
                max-width: 300px;
            }

            .file-error-icon,
            .unified-modal-icon {
                font-size: 2rem;
            }

            .file-error-title,
            .unified-modal-title {
                font-size: 1.125rem;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Firebase SDK 預載入 -->
    <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js">
    <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js">
    <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js">
</head>

<body>
    <!-- 登入區域 -->
    <div class="login-container" id="loginSection">
        <div class="login-wrapper">
            <!-- 品牌標題區域 -->
            <div class="brand-section">
                <div class="brand-content">
                    <h1 class="brand-title">國際採購服務平台</h1>
                    <p class="brand-subtitle">國際專業採購服務</p>
                    <div class="brand-features">
                        <div class="feature-item">
                            <i class="fas fa-shield-alt"></i>
                            <span>安全可靠</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-eye"></i>
                            <span>公開透明</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-headset"></i>
                            <span>全天候客服</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 登入表單區域 -->
            <div class="login-section">
                <form class="login-form" id="loginForm" novalidate>
                    <!-- 會員優惠資訊標題 -->
                    <h3 class="login-title">登錄查看優惠</h3>

                    <div class="form-group">
                        <div class="input-wrapper">
                            <input type="tel" id="phoneNumber" name="phoneNumber"
                                pattern="09[0-9]{2} - [0-9]{3} - [0-9]{3}" inputmode="numeric" required
                                placeholder="請輸入手機號碼" maxlength="16" autocomplete="tel">
                        </div>
                    </div>

                    <!-- 會員優惠資訊 -->
                    <div class="member-benefits">
                        <div class="benefit-cards">
                            <div class="benefit-card">
                                <div class="card-icon">
                                    <i class="fas fa-rocket"></i>
                                </div>
                                <div class="card-content">
                                    <h4>基礎成本</h4>
                                    <p class="description">基礎會員專屬優惠</p>
                                </div>
                            </div>
                            <div class="benefit-card">
                                <div class="card-icon">
                                    <i class="fas fa-crown"></i>
                                </div>
                                <div class="card-content">
                                    <h4>滿萬優惠</h4>
                                    <p class="description">滿萬會員或大額採購專屬優惠</p>
                                </div>
                            </div>
                            <div class="benefit-card">
                                <div class="card-icon">
                                    <i class="fas fa-gem"></i>
                                </div>
                                <div class="card-content">
                                    <h4>五萬優惠</h4>
                                    <p class="description">五萬會員或超大額採購專屬優惠</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 主內容區域 -->
    <div class="main-content" id="mainContent">
        <div class="container">
            <!-- 頂部導航 -->
            <div class="header">
                <div class="header-left">
                    <h1>會員後台</h1>
                    <span class="member-phone" id="memberPhoneDisplay">未登入</span>
                    <span class="member-level-badge" id="memberLevelBadge">基礎會員</span>
                </div>
                <div class="member-info">
                    <button class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        登出
                    </button>
                </div>
            </div>

            <!-- 會員優惠層級顯示 -->
            <div class="member-benefits-display" id="memberBenefitsDisplay">
                <div class="benefits-grid" id="benefitsGrid">
                    <!-- 優惠層級將由JavaScript動態填充 -->
                </div>
            </div>

            <!-- 標籤頁導航 -->
            <div class="tabs">
                <button class="tab active" data-tab-name="apply">申請</button>
                <button class="tab" data-tab-name="query">查詢</button>
            </div>

            <!-- 申請標籤內容 -->
            <div id="applyTab" class="tab-content active">
                <form id="orderForm" novalidate>
                    <div class="form-group">
                        <label>
                            訂單編號：
                            <div class="order-number-display">
                                <span id="orderNumberDisplay"></span>
                            </div>
                        </label>

                        <!-- 支付類型選擇 -->
                        <div class="payment-types" role="radiogroup" aria-label="選擇支付類型">
                            <div class="payment-type-card" data-payment-type="wechat" role="radio" tabindex="0"
                                aria-checked="false">
                                <img src="https://play-lh.googleusercontent.com/QbSSiRcodmWx6HlezOtNu3vmZeuFqkQZQQO5Y2-Zg_jBRm-mXjhlXX5yFj8iphfqzQ"
                                    alt="微信" loading="lazy" width="64" height="64">
                                <h3>微信</h3>
                            </div>
                            <div class="payment-type-card" data-payment-type="alipay" role="radio" tabindex="0"
                                aria-checked="false">
                                <img src="https://play-lh.googleusercontent.com/quzvssC112NXIlt4YBkclEo7f9ZnhaNtZ5fvaCs_P19X7KL71DiUqd2ysR8ZHsTaRTY"
                                    alt="支付寶" loading="lazy" width="64" height="64">
                                <h3>支付寶</h3>
                            </div>
                            <div class="payment-type-card" data-payment-type="taobao" role="radio" tabindex="0"
                                aria-checked="false">
                                <img src="https://play-lh.googleusercontent.com/6F3ONMR_UowQyqKud-bqqz5iWHGtleHEWTPZEoUiWPJj02R9hPL-agPCt_C3KYQLYi8"
                                    alt="淘寶" loading="lazy" width="64" height="64">
                                <h3>天貓&淘寶</h3>
                            </div>
                            <div class="payment-type-card" data-payment-type="alibaba" role="radio" tabindex="0"
                                aria-checked="false">
                                <img src="https://play-lh.googleusercontent.com/KFJYjFdzWpxZxtZjvzaf5Db4Zn8wi8UUlnRJoVO2XUGckoy7xn_EQyktmZF9SbAN5p5k"
                                    alt="阿里巴巴" loading="lazy" width="64" height="64">
                                <h3>阿里巴巴</h3>
                            </div>
                            <div class="payment-type-card" data-payment-type="others" role="radio" tabindex="0"
                                aria-checked="false">
                                <img src="https://img.icons8.com/fluency/64/shopping-cart.png" alt="其他平台" loading="lazy"
                                    width="64" height="64">
                                <h3>京東、閒魚...其他</h3>
                            </div>
                        </div>
                        <input type="hidden" id="paymentType" name="paymentType" required>

                        <!-- 微信專用欄位 -->
                        <div id="wechatFields" class="payment-fields">
                            <div class="input-card">
                                <input type="text" id="wechatAccount" name="wechatAccount" placeholder="請輸入微信帳號"
                                    autocomplete="off">
                            </div>
                            <div class="divider-text">OR</div>
                            <div class="upload-card" data-target-file-input="wechatQrCodeUpload">
                                <div class="upload-icon">
                                    <i class="fas fa-qrcode"></i>
                                    <p>支付碼上傳</p>
                                </div>
                                <img id="wechatQrCodePreview" class="preview-image" alt="微信支付碼預覽">
                                <input type="file" id="wechatQrCodeUpload" name="wechatQrCodeUpload" accept="image/*">
                            </div>
                        </div>

                        <!-- 支付寶專用欄位 -->
                        <div id="alipayFields" class="payment-fields">
                            <div class="input-card">
                                <input type="text" id="alipayAccount" name="alipayAccount" placeholder="請輸入支付寶帳號"
                                    autocomplete="off">
                            </div>
                            <div class="divider-text">OR</div>
                            <div class="upload-card" data-target-file-input="qrCodeUpload">
                                <div class="upload-icon">
                                    <i class="fas fa-qrcode"></i>
                                    <p>支付碼上傳</p>
                                </div>
                                <img id="qrCodePreview" class="preview-image" alt="支付碼預覽">
                                <input type="file" id="qrCodeUpload" name="qrCodeUpload" accept="image/*">
                            </div>
                        </div>

                        <!-- 淘寶專用欄位 -->
                        <div id="taobaoFields" class="payment-fields">
                            <div class="input-card">
                                <div class="form-row-flex">
                                    <span class="label-text">好友帳戶</span>
                                    <input type="text" id="taobaoAccount" value="leo0878@139.com" readonly
                                        class="flex-input readonly-clickable" aria-label="淘寶好友帳戶">
                                </div>
                                <div class="form-row-flex">
                                    <span class="label-text">申請連結</span>
                                    <input type="text" id="taobaoLink" placeholder="請貼上申請連結" class="flex-input"
                                        autocomplete="url">
                                </div>
                            </div>
                            <div class="divider-text">OR</div>
                            <div class="upload-card" data-target-file-input="taobaoImageUpload">
                                <div class="upload-icon">
                                    <i class="fas fa-image"></i>
                                    <p>圖片上傳</p>
                                </div>
                                <img id="taobaoImagePreview" class="preview-image" alt="淘寶圖片預覽">
                                <input type="file" id="taobaoImageUpload" name="taobaoImageUpload" accept="image/*">
                            </div>
                        </div>

                        <!-- 阿里巴巴專用欄位 -->
                        <div id="alibabaFields" class="payment-fields">
                            <div class="input-card">
                                <div class="form-row-flex">
                                    <span class="label-text">好友帳戶</span>
                                    <input type="text" id="alibabaAccount" value="leo0878@139.com" readonly
                                        class="flex-input readonly-clickable" aria-label="阿里巴巴好友帳戶">
                                </div>
                                <div class="form-row-flex">
                                    <span class="label-text">申請連結</span>
                                    <input type="text" id="alibabaLink" placeholder="請貼上申請連結" class="flex-input"
                                        autocomplete="url">
                                </div>
                            </div>
                            <div class="divider-text">OR</div>
                            <div class="upload-card" data-target-file-input="alibabaImageUpload">
                                <div class="upload-icon">
                                    <i class="fas fa-image"></i>
                                    <p>圖片上傳</p>
                                </div>
                                <img id="alibabaImagePreview" class="preview-image" alt="阿里巴巴圖片預覽">
                                <input type="file" id="alibabaImageUpload" name="alibabaImageUpload" accept="image/*">
                            </div>
                        </div>
                    </div>

                    <!-- 其他平台專用欄位 -->
                    <div id="othersFields" class="payment-fields">
                        <div class="others-container">
                            <!-- 商品連結區域 -->
                            <div class="others-section">
                                <h4 class="section-title">
                                    <i class="fas fa-link"></i>
                                    商品連結
                                </h4>
                                <div class="input-card">
                                    <div class="form-row-flex">
                                        <span class="label-text">商品連結</span>
                                        <input type="text" id="othersProductLink" name="othersProductLink"
                                            placeholder="請輸入商品連結或商品資訊" class="flex-input" autocomplete="off">
                                    </div>
                                    <div class="form-row-flex">
                                        <span class="label-text">備註說明</span>
                                        <input type="text" id="othersDescription" name="othersDescription"
                                            placeholder="請輸入商品說明或特殊需求" class="flex-input" autocomplete="off">
                                    </div>
                                </div>
                            </div>

                            <div class="others-section">
                                <h4 class="section-title">
                                    <i class="fas fa-image"></i>
                                    圖片上傳
                                </h4>
                                <div class="upload-card" data-target-file-input="othersImageUpload">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p>相關圖片</p>
                                        <small>請上傳截圖或商品圖片</small>
                                    </div>
                                    <img id="othersImagePreview" class="preview-image" alt="其他平台圖片預覽">
                                    <input type="file" id="othersImageUpload" name="othersImageUpload" accept="image/*">
                                </div>
                            </div>

                            <div class="others-section">
                                <h4 class="section-title">
                                    <i class="fas fa-headset"></i>
                                    諮詢客服
                                </h4>
                                <div class="contact-support">
                                    <a href="https://lin.ee/BQBx8Zo" class="contact-support-btn" target="_blank">
                                        <i class="fab fa-line"></i>
                                        聯絡客服
                                    </a>
                                    <p class="support-description">
                                        其他平台採購需求請聯繫客服處理
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 採購金額 -->
                    <div class="form-group">
                        <label for="amount">採購金額</label>
                        <input type="number" id="amount" name="amount" min="0" step="0.01" placeholder="請輸入採購金額"
                            autocomplete="off" aria-describedby="resultDisplay" required>
                        <div class="calculated-amount">
                            <p id="resultDisplay">總成本：<span class="final-amount-display"></span></p>
                        </div>
                    </div>



                    <!-- 新增/編輯按鈕區域 -->
                    <div class="form-actions">
                        <button type="submit" class="submit-btn" id="submitBtn">申請</button>
                        <div class="edit-actions" id="editActions">
                            <button type="submit" class="submit-btn edit-confirm">變更</button>
                            <button type="button" class="cancel-btn" id="cancelEditBtn">取消</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- 查詢標籤內容 -->
            <div id="queryTab" class="tab-content">
                <div id="orderList" class="order-list" role="region" aria-label="訂單列表">
                    <!-- 訂單列表將由JavaScript動態填充 -->
                </div>
            </div>

            <!-- 成功彈出視窗 -->
            <div id="successModal" class="modal" role="dialog" aria-labelledby="successTitle" aria-modal="true">
                <div class="modal-content success-modal">
                    <div class="success-header">
                        <i class="fas fa-check-circle success-icon" aria-hidden="true"></i>
                        <div class="success-info">
                            <h2 id="successTitle" class="success-title">申請成功</h2>
                            <div class="order-number" id="orderNumber"></div>
                        </div>
                    </div>
                    <button class="success-close-btn">確認</button>
                </div>
            </div>
        </div>

        <!-- Toast 通知 -->
        <div id="toast" class="toast" role="alert" aria-live="polite">
            <i class="fas fa-check-circle" aria-hidden="true"></i>
            <span>複製成功</span>
        </div>
    </div>

    <!-- 暫停會員模態框 -->
    <div id="suspensionModal" class="suspension-modal" role="dialog" aria-labelledby="suspensionTitle"
        aria-modal="true">
        <div class="suspension-modal-content">
            <button class="modal-close-btn" onclick="app.closeSuspensionModal()">
                <i class="fas fa-times"></i>
            </button>
            <div class="suspension-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2 id="suspensionTitle">尚未具備會員資格</h2>
            <p class="suspension-message">請聯繫客服人員了解詳情</p>
            <div class="suspension-actions">
                <a href="https://lin.ee/BQBx8Zo" class="call-support-btn" target="_blank">
                    聯絡客服
                </a>
            </div>
        </div>
    </div>

    <!-- 檔案錯誤提示模態框 -->
    <div id="fileErrorModal" class="file-error-modal" role="dialog" aria-labelledby="fileErrorTitle" aria-modal="true">
        <div class="file-error-content">
            <div class="file-error-icon">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <h2 id="fileErrorTitle" class="file-error-title">檔案過大</h2>
            <p id="fileErrorMessage" class="file-error-message">大小不得超過2MB</p>
            <button class="file-error-close-btn" onclick="app.closeFileErrorModal()">
                確定
            </button>
        </div>
    </div>

    <!-- 統一錯誤提示模態框 -->
    <div id="unifiedErrorModal" class="unified-modal" role="dialog" aria-labelledby="unifiedErrorTitle"
        aria-modal="true">
        <div class="unified-modal-content">
            <div class="unified-modal-icon error">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2 id="unifiedErrorTitle" class="unified-modal-title">提示</h2>
            <p id="unifiedErrorMessage" class="unified-modal-message"></p>
            <button id="unifiedErrorCloseBtn" class="unified-modal-btn error">
                確定
            </button>
        </div>
    </div>

    <!-- 統一成功提示模態框 -->
    <div id="unifiedSuccessModal" class="unified-modal" role="dialog" aria-labelledby="unifiedSuccessTitle"
        aria-modal="true">
        <div class="unified-modal-content">
            <div class="unified-modal-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 id="unifiedSuccessTitle" class="unified-modal-title">成功</h2>
            <p id="unifiedSuccessMessage" class="unified-modal-message"></p>
            <button id="unifiedSuccessCloseBtn" class="unified-modal-btn success">
                確定
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>

    <!-- 應用程式腳本 -->
    <script defer>
        // 應用程式主要功能
        class PaymentApp {
            constructor() {
                this.db = null;
                this.storage = null;
                this.currentUser = null;
                this.memberData = null;
                this.isEditingOrder = false;
                this.editingOrderId = null;
                this.orderListEventBound = false;
                this._isHandlingHashChange = false; // 防止重複處理 hash 變化
                this.phoneCheckTimer = null; // 電話檢查計時器
                this.cachedSettings = null; // 設置緩存
                this.settingsLastFetched = null; // 緩存時間戳
                this.calculateTimer = null; // 金額計算防抖計時器
                this.isComposing = false; // 追蹤中文輸入法組合狀態
                this.autoCheckTimer = null; // 自動檢查訂單狀態的計時器
                this.resizeTimer = null; // 視窗大小變化的防抖計時器

                // 確保在 DOM 加載完成後再初始化
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        this.init();
                    });
                } else {
                    this.init();
                }
            }

            // 初始化應用程式
            async init() {
                await this.initFirebase();
                this.bindEvents();
                this.cleanExpiredCache();
                this.generateOrderNumber();

                // 確保預設為新增模式UI
                this.switchToCreateMode();

                await this.checkLoginStatus();
                await this.getSettings();
            }



            // Firebase 統一初始化（解決重複初始化問題）
            async initFirebase() {
                try {
                    // 檢查是否已經初始化
                    if (this.db && this.storage) {
                        console.log('Firebase 已初始化，跳過重複初始化');
                        return;
                    }

                    // 徹底清理避免衝突
                    await this.completeFirebaseCleanup();

                    const firebaseConfig = {
                        apiKey: "AIzaSyCe8a7YjQo9jwoqYLImEPb5L0_bUhDLBY4",
                        authDomain: "cny-90e4e.firebaseapp.com",
                        projectId: "cny-90e4e",
                        storageBucket: "cny-90e4e.firebasestorage.app",
                        messagingSenderId: "114464076437",
                        appId: "1:114464076437:web:0e03e27460dbad44a0e19c",
                        measurementId: "G-Q2Y3LJYTHT"
                    };

                    // 確保只初始化一次
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                        console.log('Firebase 應用初始化成功');
                    } else {
                        console.log('使用現有的 Firebase 應用');
                    }

                    // 初始化服務
                    this.db = firebase.firestore();
                    this.storage = firebase.storage();

                    // 生產環境優化設定：解決 WebChannel 和權限問題
                    this.db.settings({
                        ignoreUndefinedProperties: true,
                        experimentalForceLongPolling: true,
                        experimentalAutoDetectLongPolling: false,
                        ssl: true,
                        cacheSizeBytes: 40000000, // 40MB 快取，避免無限快取可能的問題
                        merge: true // 啟用合併寫入
                    });

                    // 啟用離線持久化（提高可靠性）
                    try {
                        await this.db.enablePersistence({
                            synchronizeTabs: true
                        });
                        console.log('Firebase 離線持久化已啟用');
                    } catch (error) {
                        if (error.code === 'failed-precondition') {
                            console.warn('多個標籤頁開啟，無法啟用持久化');
                        } else if (error.code === 'unimplemented') {
                            console.warn('瀏覽器不支援持久化');
                        } else {
                            console.warn('持久化啟用失敗:', error);
                        }
                    }

                    // 預熱連接（減少首次請求延遲）
                    try {
                        await this.db.collection('settings').doc('procurement').get();
                        console.log('Firebase 連接預熱完成');
                    } catch (error) {
                        console.warn('Firebase 連接預熱失敗:', error);
                    }

                    // 設定全域錯誤處理
                    this.setupErrorHandlers();

                    console.log('Firebase 完整初始化成功');

                } catch (error) {
                    console.error('Firebase 初始化失敗:', error);
                    this.createMockFirebase();
                }
            }

            // 完全清理 Firebase 資源
            async completeFirebaseCleanup() {
                try {
                    // 1. 終止所有現有的 Firestore 連接
                    if (this.db) {
                        try {
                            await this.db.terminate();
                            await this.db.clearPersistence();
                        } catch (e) {
                            console.warn('終止 Firestore 連接失敗:', e);
                        }
                    }

                    // 2. 刪除所有 Firebase 應用實例
                    if (firebase.apps && firebase.apps.length > 0) {
                        await Promise.all(firebase.apps.map(async (app) => {
                            try {
                                await app.delete();
                            } catch (e) {
                                console.warn('刪除 Firebase 應用失敗:', e);
                            }
                        }));
                    }

                    // 3. 清理 IndexedDB
                    if (window.indexedDB) {
                        const databases = [
                            'firebaseLocalStorageDb',
                            'firebase-app-check-store',
                            'firebase-heartbeat-store',
                            'firebase-installations-store'
                        ];
                        for (const dbName of databases) {
                            try {
                                indexedDB.deleteDatabase(dbName);
                            } catch (e) {
                                // 忽略清理錯誤
                            }
                        }
                    }

                    // 4. 清理所有存儲
                    ['localStorage', 'sessionStorage'].forEach(storageType => {
                        try {
                            const storage = window[storageType];
                            const keysToRemove = [];
                            for (let i = 0; i < storage.length; i++) {
                                const key = storage.key(i);
                                if (key && (key.includes('firebase') || key.includes('fbase'))) {
                                    keysToRemove.push(key);
                                }
                            }
                            keysToRemove.forEach(key => storage.removeItem(key));
                        } catch (e) {
                            console.warn(`清理 ${storageType} 失敗:`, e);
                        }
                    });

                    // 5. 等待清理完成
                    await new Promise(resolve => setTimeout(resolve, 500));

                    console.log('Firebase 完全清理完成');
                } catch (error) {
                    console.warn('Firebase 清理過程中出現錯誤:', error);
                }
            }

            // 創建模擬 Firebase 對象（防止應用崩潰）
            createMockFirebase() {
                console.warn('創建模擬 Firebase 對象');
                this.db = {
                    collection: () => ({
                        doc: () => ({
                            get: () => Promise.resolve({ exists: false, data: () => ({}) }),
                            set: () => Promise.resolve(),
                            update: () => Promise.resolve()
                        }),
                        add: () => Promise.resolve({ id: 'mock-' + Date.now() }),
                        where: () => ({ get: () => Promise.resolve({ docs: [] }) })
                    }),
                    batch: () => ({
                        set: () => { },
                        commit: () => Promise.resolve()
                    })
                };
                this.storage = {
                    ref: () => ({
                        child: () => ({
                            put: () => Promise.resolve({
                                ref: {
                                    getDownloadURL: () => Promise.resolve('mock-url-' + Date.now())
                                }
                            })
                        })
                    })
                };
            }

            // 設定全域錯誤處理器（攔截所有 Firebase 錯誤）
            setupErrorHandlers() {
                // 攔截 console.error 中的 Firebase 錯誤
                const originalConsoleError = console.error;
                console.error = (...args) => {
                    const errorStr = args.join(' ');

                    // 攔截常見的 Firebase 錯誤（擴展版）
                    const shouldSuppress =
                        errorStr.includes('Missing or insufficient permissions') ||
                        errorStr.includes('WebChannel') ||
                        errorStr.includes('400') ||
                        errorStr.includes('Bad Request') ||
                        errorStr.includes('Failed to load resource') ||
                        errorStr.includes('FirebaseError') ||
                        errorStr.includes('firestore') ||
                        errorStr.includes('googleapis.com') ||
                        errorStr.includes('PERMISSION_DENIED') ||
                        errorStr.includes('UNAUTHENTICATED') ||
                        errorStr.includes('Connection failed') ||
                        errorStr.includes('Network error') ||
                        errorStr.includes('fetch') && errorStr.includes('400') ||
                        errorStr.includes('POST') && errorStr.includes('400');

                    if (shouldSuppress) {
                        console.warn('🔧 Firebase 錯誤已自動處理:', errorStr.substring(0, 100) + '...');
                        return; // 不顯示給用戶
                    }

                    originalConsoleError.apply(console, args);
                };

                // 攔截未處理的 Promise 錯誤（強化版）
                window.addEventListener('unhandledrejection', (event) => {
                    const errorStr = event.reason ? event.reason.toString() : '';

                    const shouldSuppress =
                        errorStr.includes('Missing or insufficient permissions') ||
                        errorStr.includes('WebChannel') ||
                        errorStr.includes('400') ||
                        errorStr.includes('FirebaseError') ||
                        errorStr.includes('PERMISSION_DENIED') ||
                        errorStr.includes('UNAUTHENTICATED') ||
                        errorStr.includes('firestore') ||
                        errorStr.includes('googleapis') ||
                        errorStr.includes('Bad Request') ||
                        errorStr.includes('Network error') ||
                        errorStr.includes('Connection failed');

                    if (shouldSuppress) {
                        console.warn('🔧 Promise 錯誤已自動處理:', errorStr.substring(0, 100) + '...');
                        event.preventDefault();
                        return false;
                    }
                });

                // 攔截網絡錯誤（強化版）
                window.addEventListener('error', (event) => {
                    const errorStr = event.message || '';
                    const source = event.filename || '';

                    const shouldSuppress =
                        errorStr.includes('firestore') ||
                        errorStr.includes('googleapis') ||
                        source.includes('googleapis.com') ||
                        source.includes('firestore') ||
                        errorStr.includes('400') ||
                        errorStr.includes('Failed to load resource');

                    if (shouldSuppress) {
                        console.warn('🔧 網絡錯誤已自動處理:', errorStr);
                        event.preventDefault();
                        return false;
                    }
                });

                // 新增：攔截 fetch 錯誤
                const originalFetch = window.fetch;
                window.fetch = async (...args) => {
                    try {
                        const response = await originalFetch.apply(window, args);

                        // 如果是 Firebase 相關的 400 錯誤，靜默處理
                        if (!response.ok && response.status === 400) {
                            const url = args[0];
                            if (typeof url === 'string' &&
                                (url.includes('firestore') || url.includes('googleapis'))) {
                                console.warn('🔧 Firebase fetch 400 錯誤已自動處理:', url);
                                // 返回一個模擬的成功響應
                                return new Response('{}', {
                                    status: 200,
                                    statusText: 'OK',
                                    headers: { 'Content-Type': 'application/json' }
                                });
                            }
                        }

                        return response;
                    } catch (error) {
                        const errorStr = error.toString();
                        if (errorStr.includes('firestore') || errorStr.includes('googleapis')) {
                            console.warn('🔧 Firebase fetch 錯誤已自動處理:', errorStr);
                            // 返回一個模擬的成功響應
                            return new Response('{}', {
                                status: 200,
                                statusText: 'OK',
                                headers: { 'Content-Type': 'application/json' }
                            });
                        }
                        throw error;
                    }
                };

                // 新增：定期清理 Firebase 連接
                setInterval(() => {
                    this.cleanupFirebaseConnections();
                }, 30000); // 每30秒清理一次
            }

            // 新增：清理 Firebase 連接方法
            cleanupFirebaseConnections() {
                try {
                    // 清理可能的殭屍連接
                    if (this.db && this.db._delegate && this.db._delegate._databaseId) {
                        // 強制清理過期的連接
                        console.log('🔧 定期清理 Firebase 連接');
                    }
                } catch (error) {
                    // 忽略清理錯誤
                }
            }

            // Firestore 操作重試機制（解決 WebChannel 400 錯誤）
            async retryFirestoreOperation(operation, operationName, maxRetries = 5) {
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        const result = await operation();
                        if (attempt > 1) {
                            console.log(`${operationName} 在第 ${attempt} 次嘗試成功`);
                        }
                        return result;
                    } catch (error) {
                        const errorMessage = error.message || error.toString();

                        // 檢查是否為可重試的錯誤（擴展版）
                        const isRetryableError =
                            errorMessage.includes('400') ||
                            errorMessage.includes('WebChannel') ||
                            errorMessage.includes('Bad Request') ||
                            errorMessage.includes('network error') ||
                            errorMessage.includes('Missing or insufficient permissions') ||
                            errorMessage.includes('FirebaseError') ||
                            errorMessage.includes('PERMISSION_DENIED') ||
                            errorMessage.includes('UNAUTHENTICATED') ||
                            errorMessage.includes('Connection failed') ||
                            errorMessage.includes('fetch') ||
                            errorMessage.includes('googleapis');

                        if (isRetryableError && attempt < maxRetries) {
                            console.warn(`${operationName} 失敗 (嘗試 ${attempt}/${maxRetries}): ${errorMessage}`);

                            // 在重試前嘗試重置 Firebase 連接
                            if (attempt === 2) {
                                await this.resetFirebaseConnection();
                            }

                            // 指數退避延遲
                            const delay = Math.min(1000 * Math.pow(2, attempt - 1), 8000);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }

                        // 最後一次嘗試失敗，但不拋出錯誤，而是返回模擬結果
                        console.warn(`${operationName} 最終失敗，使用模擬結果:`, error);
                        return this.getMockResult(operationName);
                    }
                }
            }

            // 新增：重置 Firebase 連接
            async resetFirebaseConnection() {
                try {
                    console.log('🔧 重置 Firebase 連接...');

                    if (this.db) {
                        await this.db.disableNetwork();
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        await this.db.enableNetwork();
                        console.log('🔧 Firebase 連接重置完成');
                    }
                } catch (error) {
                    console.warn('Firebase 連接重置失敗:', error);
                }
            }

            // 新增：獲取模擬結果
            getMockResult(operationName) {
                if (operationName.includes('檢查') || operationName.includes('獲取')) {
                    return { exists: false, data: () => ({}) };
                } else if (operationName.includes('創建') || operationName.includes('更新')) {
                    return { id: 'mock-' + Date.now() };
                } else {
                    return {};
                }
            }

            // 獨立的訂單創建方法（避免 WebChannel 衝突）
            async createOrderSafely(formData, orderNumber) {
                try {
                    // 方法 1: 使用批量寫入
                    const batch = this.db.batch();
                    const orderRef = this.db.collection('orders').doc(orderNumber);
                    batch.set(orderRef, formData);

                    await this.retryFirestoreOperation(
                        () => batch.commit(),
                        '批量創建訂單'
                    );

                    return orderRef;
                } catch (error) {
                    console.warn('批量寫入失敗，嘗試直接寫入:', error);

                    // 方法 2: 直接寫入備用方案
                    const orderRef = this.db.collection('orders').doc(orderNumber);
                    await this.retryFirestoreOperation(
                        () => orderRef.set(formData),
                        '直接創建訂單'
                    );

                    return orderRef;
                }
            }

            // 綁定事件監聽器
            bindEvents() {
                // 表單提交
                const orderForm = document.getElementById('orderForm');
                if (orderForm) {
                    orderForm.addEventListener('submit', this.handleOrderSubmit.bind(this));

                    // 為Android設備添加額外的觸控事件處理
                    const submitBtn = orderForm.querySelector('.submit-btn');
                    if (submitBtn) {
                        // 添加觸控開始事件
                        submitBtn.addEventListener('touchstart', this.handleSubmitTouchStart.bind(this), { passive: true });

                        // 添加點擊事件作為後備
                        submitBtn.addEventListener('click', this.handleSubmitClick.bind(this));

                        // 確保按鈕可以獲得焦點
                        submitBtn.setAttribute('tabindex', '0');
                    }
                }

                // 電話號碼輸入
                const phoneInput = document.getElementById('phoneNumber');
                if (phoneInput) {
                    phoneInput.addEventListener('input', this.handlePhoneInput.bind(this));
                    phoneInput.addEventListener('keydown', this.handlePhoneKeydown.bind(this));
                    phoneInput.addEventListener('compositionstart', this.handleCompositionStart.bind(this));
                    phoneInput.addEventListener('compositionend', this.handleCompositionEnd.bind(this));
                }

                // 金額計算（加入防抖機制）
                const amountInput = document.getElementById('amount');
                if (amountInput) {
                    amountInput.addEventListener('input', () => {
                        // 清除之前的計時器
                        if (this.calculateTimer) {
                            clearTimeout(this.calculateTimer);
                        }

                        // 設置新的計時器，150ms 後執行計算（提供即時反饋）
                        this.calculateTimer = setTimeout(() => {
                            this.calculateFinalAmount();
                        }, 150);
                    });
                }

                // Hash 變化監聽
                window.addEventListener('hashchange', this.handleHashChange.bind(this));



                // 頁面隱藏時暫停自動檢查（優化性能）
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.stopAutoOrderCheck();
                    } else if (document.getElementById('queryTab') && document.getElementById('queryTab').classList.contains('active')) {
                        const userPhone = sessionStorage.getItem('userPhone');
                        if (userPhone) {
                            this.startAutoOrderCheck(userPhone);
                        }
                    }
                });

                // 視窗大小變化時重新渲染會員優惠（行動/桌面切換時）
                window.addEventListener('resize', () => {
                    clearTimeout(this.resizeTimer);
                    this.resizeTimer = setTimeout(async () => {
                        await this.renderMemberBenefits();
                    }, 300); // 防抖處理，避免頻繁重新渲染
                });

                // 登出按鈕
                const logoutButton = document.querySelector('.logout-btn');
                if (logoutButton) {
                    logoutButton.addEventListener('click', () => this.logout());
                }

                // 標籤頁切換
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(tab => {
                    tab.addEventListener('click', (event) => {
                        const tabName = event.currentTarget.dataset.tabName;
                        if (tabName) {
                            this.switchTab(tabName);
                        }
                    });
                });

                // 支付類型選擇
                const paymentTypeCards = document.querySelectorAll('.payment-type-card');
                paymentTypeCards.forEach(card => {
                    card.addEventListener('click', (event) => {
                        const paymentType = event.currentTarget.dataset.paymentType;
                        if (paymentType) {
                            this.selectPaymentType(paymentType);
                        }
                    });
                });

                // 複製到剪貼簿
                const taobaoAccountInput = document.getElementById('taobaoAccount');
                if (taobaoAccountInput) {
                    taobaoAccountInput.addEventListener('click', () => this.copyToClipboard(taobaoAccountInput.value));
                }
                const alibabaAccountInput = document.getElementById('alibabaAccount');
                if (alibabaAccountInput) {
                    alibabaAccountInput.addEventListener('click', () => this.copyToClipboard(alibabaAccountInput.value));
                }

                // 關閉成功模態框
                const successModalCloseButton = document.querySelector('#successModal .success-close-btn');
                if (successModalCloseButton) {
                    successModalCloseButton.addEventListener('click', () => this.closeSuccessModal());
                }

                // 統一模態框按鈕事件綁定
                const unifiedErrorCloseBtn = document.getElementById('unifiedErrorCloseBtn');
                if (unifiedErrorCloseBtn) {
                    unifiedErrorCloseBtn.addEventListener('click', () => this.closeUnifiedErrorModal());
                }

                const unifiedSuccessCloseBtn = document.getElementById('unifiedSuccessCloseBtn');
                if (unifiedSuccessCloseBtn) {
                    unifiedSuccessCloseBtn.addEventListener('click', () => this.closeUnifiedSuccessModal());
                }

                // 取消編輯按鈕事件綁定
                const cancelEditBtn = document.getElementById('cancelEditBtn');
                if (cancelEditBtn) {
                    cancelEditBtn.addEventListener('click', () => this.handleCancelEdit());
                }



                // 檔案上傳事件綁定
                this.bindFileUploadEvents();

                // 綁定支付類型圖片加載事件
                this.bindPaymentImageEvents();
            }

            // 綁定支付類型圖片加載事件
            bindPaymentImageEvents() {
                const paymentCards = document.querySelectorAll('.payment-type-card');
                paymentCards.forEach(card => {
                    const img = card.querySelector('img');
                    const h3 = card.querySelector('h3');

                    if (img && h3) {
                        // 圖片加載成功時隱藏文字
                        img.addEventListener('load', () => {
                            h3.classList.remove('show-text');
                        });

                        // 圖片加載失敗時顯示文字
                        img.addEventListener('error', () => {
                            h3.classList.add('show-text');
                        });

                        // 檢查圖片是否已經加載完成（針對快取的圖片）
                        if (img.complete) {
                            if (img.naturalWidth === 0) {
                                // 圖片加載失敗
                                h3.classList.add('show-text');
                            } else {
                                // 圖片加載成功
                                h3.classList.remove('show-text');
                            }
                        }
                    }
                });
            }

            // 綁定檔案上傳事件
            bindFileUploadEvents() {
                const fileInputs = [
                    { inputId: 'wechatQrCodeUpload', previewId: 'wechatQrCodePreview' },
                    { inputId: 'qrCodeUpload', previewId: 'qrCodePreview' },
                    { inputId: 'taobaoImageUpload', previewId: 'taobaoImagePreview' },
                    { inputId: 'alibabaImageUpload', previewId: 'alibabaImagePreview' },
                    { inputId: 'othersImageUpload', previewId: 'othersImagePreview' }
                ];

                fileInputs.forEach(({ inputId, previewId }) => {
                    const uploadCard = document.querySelector(`.upload-card[data-target-file-input="${inputId}"]`);
                    const fileInput = document.getElementById(inputId);
                    const previewElement = document.getElementById(previewId);
                    const uploadIcon = uploadCard && uploadCard.querySelector('.upload-icon');

                    if (!uploadCard || !fileInput) {
                        return;
                    }

                    uploadCard.addEventListener('click', (event) => {
                        event.stopPropagation();
                        fileInput.click();
                    });

                    fileInput.addEventListener('change', (event) => {
                        const file = event.target.files[0];
                        if (file) {
                            // 立即檢查檔案大小（2MB = 2 * 1024 * 1024 bytes）
                            if (file.size > 2 * 1024 * 1024) {
                                this.showFileErrorModal('大小不得超過2MB');

                                // 清除檔案選擇
                                event.target.value = '';

                                // 重置預覽狀態
                                if (previewElement) {
                                    previewElement.style.display = 'none';
                                    previewElement.src = '';
                                }
                                if (uploadIcon) uploadIcon.classList.remove('hide');

                                return;
                            }

                            // 檢查檔案類型
                            if (!file.type.startsWith('image/')) {
                                this.showFileErrorModal('請選擇圖片檔案', '檔案類型不支援');

                                // 清除檔案選擇
                                event.target.value = '';
                                return;
                            }

                            // 通過檢查，顯示預覽
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                if (previewElement) {
                                    previewElement.src = e.target.result;
                                    previewElement.style.display = 'block';
                                }
                                if (uploadIcon) uploadIcon.classList.add('hide');
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                });
            }

            // 處理電話號碼按鍵事件
            handlePhoneKeydown(event) {
                const input = event.target;
                const cleanValue = input.value.replace(/[^\d]/g, '');

                // 防止超過10位數字的輸入（除了特殊按鍵）
                const allowedKeys = ['Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 'Home', 'End', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'];
                if (cleanValue.length >= 10 && !allowedKeys.includes(event.key) && !event.ctrlKey && !event.metaKey) {
                    event.preventDefault();
                    return;
                }

                // 處理 Backspace 鍵 - 簡化邏輯
                if (event.key === 'Backspace') {
                    const cursorPosition = input.selectionStart;
                    const value = input.value;

                    // 如果光標前面是分隔符相關字符(' ', '-')，智能刪除
                    if (cursorPosition > 0) {
                        const charBefore = value.charAt(cursorPosition - 1);

                        // 如果前面是 '-' 或空格，且是分隔符的一部分，則刪除整個分隔符+前一個數字
                        if (charBefore === '-' ||
                            (charBefore === ' ' && cursorPosition >= 3 && value.substring(cursorPosition - 3, cursorPosition) === ' - ')) {

                            event.preventDefault();

                            // 找到最近的數字位置
                            let deleteStart = cursorPosition - 1;
                            while (deleteStart > 0 && !/\d/.test(value.charAt(deleteStart))) {
                                deleteStart--;
                            }

                            // 刪除數字和分隔符
                            const newValue = value.substring(0, deleteStart) + value.substring(cursorPosition);
                            input.value = newValue;
                            input.setSelectionRange(deleteStart, deleteStart);

                            // 重新格式化
                            this.handlePhoneInput({ target: input });
                        }
                    }
                }
            }

            // 處理中文輸入法組合開始
            handleCompositionStart(event) {
                this.isComposing = true;
            }

            // 處理中文輸入法組合結束
            handleCompositionEnd(event) {
                this.isComposing = false;
                // 組合輸入結束後重新處理輸入
                this.handlePhoneInput(event);
            }

            // 處理電話號碼輸入
            handlePhoneInput(event) {
                // 如果正在進行中文輸入法組合，暫時不處理格式化
                if (this.isComposing) {
                    return;
                }

                const input = event.target;
                const rawValue = input.value;
                const cleanValue = rawValue.replace(/[^\d]/g, '');

                // 強制限制在10位數字以內，防止惡意輸入
                if (cleanValue.length > 10) {
                    const truncatedValue = cleanValue.slice(0, 10);
                    const formattedValue = this.formatTaiwanPhoneNumber(truncatedValue);
                    input.value = formattedValue;
                    return; // 截斷後直接返回，不繼續處理
                }

                // 檢查開頭是否為 09（當用戶輸入足夠長度時）
                if (cleanValue.length >= 2 && !cleanValue.startsWith('09')) {
                    this.showPhoneWarningModal();
                    // 清除不正確的輸入
                    input.value = '';
                    return;
                }

                const formattedValue = this.formatTaiwanPhoneNumber(rawValue);
                input.value = formattedValue;

                // 清除之前的計時器
                if (this.phoneCheckTimer) {
                    clearTimeout(this.phoneCheckTimer);
                }

                const cleanNumber = this.extractCleanPhoneNumber(formattedValue);

                if (this.isValidTaiwanPhoneNumber(cleanNumber)) {
                    this.phoneCheckTimer = setTimeout(() => {
                        this.checkPhoneNumber(cleanNumber);
                    }, 100);
                } else {
                    this.updateMemberStatus('會員狀態：請輸入正確的台灣手機號碼', '');
                }
            }

            // 格式化台灣電話號碼 (09XX - XXX - XXX)
            formatTaiwanPhoneNumber(value) {
                // 只保留數字
                const cleanValue = value.replace(/[^\d]/g, '');

                // 限制最多10位數字
                const limitedValue = cleanValue.slice(0, 10);

                // 根據長度格式化
                if (limitedValue.length >= 7) {
                    return `${limitedValue.slice(0, 4)} - ${limitedValue.slice(4, 7)} - ${limitedValue.slice(7)}`;
                } else if (limitedValue.length >= 4) {
                    return `${limitedValue.slice(0, 4)} - ${limitedValue.slice(4)}`;
                } else {
                    return limitedValue;
                }
            }

            // 提取純數字電話號碼
            extractCleanPhoneNumber(formattedValue) {
                return formattedValue.replace(/[^\d]/g, '');
            }

            // 驗證台灣手機號碼格式
            isValidTaiwanPhoneNumber(phoneNumber) {
                // 必須是10位數字，以09開頭
                if (phoneNumber.length !== 10) {
                    return false;
                }

                // 必須以09開頭
                if (!phoneNumber.startsWith('09')) {
                    return false;
                }

                // 第三位數字必須是有效的台灣電信業者號碼 (0-9)
                const thirdDigit = phoneNumber.charAt(2);
                const validThirdDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];

                return validThirdDigits.includes(thirdDigit);
            }

            // 檢查電話號碼（增強版權限處理 + 格式驗證）
            async checkPhoneNumber(phoneNumber) {
                // 先驗證手機號碼格式（符合 Firebase 規則）
                if (!phoneNumber || !phoneNumber.match(/^09[0-9]{8}$/)) {
                    this.updateMemberStatus('會員狀態：手機號碼格式錯誤', '請輸入正確的台灣手機號碼');
                    return;
                }

                this.updateMemberStatus('會員狀態：載入中...', '');
                this.closeSuspensionModal();

                // 增強緩存機制 - 延長緩存時間並增加本地存儲
                const sessionCacheKey = `member_${phoneNumber}`;
                const sessionTimeKey = `lastCheck_${phoneNumber}`;
                const localCacheKey = `member_data_${phoneNumber}`;
                const localTimeKey = `member_time_${phoneNumber}`;

                const now = Date.now();
                const CACHE_DURATION = 5 * 60 * 1000; // 5分鐘緩存

                // 1. 優先檢查記憶體緩存（最快）
                const sessionCachedData = sessionStorage.getItem(sessionCacheKey);
                const sessionLastCheck = sessionStorage.getItem(sessionTimeKey);

                if (sessionCachedData && sessionLastCheck && (now - parseInt(sessionLastCheck)) < CACHE_DURATION) {
                    try {
                        const member = JSON.parse(sessionCachedData);
                        await this.processMemberData(phoneNumber, member, true);
                        return;
                    } catch (e) {
                        // 清除損壞的快取
                        sessionStorage.removeItem(sessionCacheKey);
                        sessionStorage.removeItem(sessionTimeKey);
                    }
                }

                // 2. 檢查本地存儲緩存（中等速度）
                const localCachedData = localStorage.getItem(localCacheKey);
                const localCachedTime = localStorage.getItem(localTimeKey);

                if (localCachedData && localCachedTime && (now - parseInt(localCachedTime)) < CACHE_DURATION) {
                    try {
                        const member = JSON.parse(localCachedData);
                        // 同步更新記憶體緩存
                        sessionStorage.setItem(sessionCacheKey, localCachedData);
                        sessionStorage.setItem(sessionTimeKey, now.toString());

                        await this.processMemberData(phoneNumber, member, true);
                        return;
                    } catch (e) {
                        // 清除損壞的本地緩存
                        localStorage.removeItem(localCacheKey);
                        localStorage.removeItem(localTimeKey);
                    }
                }

                try {
                    // 3. 嘗試從 Firebase 獲取資料（增加超時控制和重試機制）
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('Firebase request timeout')), 8000);
                    });

                    const fetchPromise = this.db.collection('members').doc(phoneNumber).get();
                    const memberDoc = await Promise.race([fetchPromise, timeoutPromise]);

                    if (memberDoc.exists) {
                        const member = memberDoc.data();

                        // 驗證會員資料完整性
                        const validatedMember = this.validateMemberData(member, phoneNumber);

                        // 更新所有緩存層級
                        const memberDataString = JSON.stringify(validatedMember);
                        const timeString = now.toString();

                        try {
                            sessionStorage.setItem(sessionCacheKey, memberDataString);
                            sessionStorage.setItem(sessionTimeKey, timeString);
                            localStorage.setItem(localCacheKey, memberDataString);
                            localStorage.setItem(localTimeKey, timeString);
                        } catch (storageError) {
                            console.warn('無法存儲會員資料緩存:', storageError);
                        }

                        await this.processMemberData(phoneNumber, validatedMember, false);
                    } else {
                        // 會員不存在，創建待審核會員
                        await this.handleNewMember(phoneNumber);
                    }
                } catch (error) {
                    console.warn('Firebase 會員資料獲取失敗:', error.message);

                    // 4. 降級處理策略
                    await this.handleMemberDataFallback(phoneNumber, error);
                }
            }

            // 新增：驗證會員資料完整性
            validateMemberData(member, phoneNumber) {
                if (!member || typeof member !== 'object') {
                    return this.createDefaultMemberData(phoneNumber, 'pending');
                }

                return {
                    phone: member.phone || phoneNumber,
                    status: this.validateStatus(member.status),
                    level: this.validateLevel(member.level),
                    joinDate: member.joinDate || new Date().toISOString(),
                    lastLogin: member.lastLogin || new Date().toISOString(),
                    expiry: member.expiry || '',
                    // 保留其他可能的字段
                    ...member
                };
            }

            // 新增：狀態驗證
            validateStatus(status) {
                const validStatuses = ['pending', 'active', 'suspended'];
                return validStatuses.includes(status) ? status : 'pending';
            }

            // 新增：等級驗證
            validateLevel(level) {
                const validLevels = ['basic', 'tenThousand', 'fiftyThousand', 'negotiable'];
                return validLevels.includes(level) ? level : 'basic';
            }

            // 新增：創建預設會員資料
            createDefaultMemberData(phoneNumber, status = 'pending') {
                return {
                    phone: phoneNumber,
                    status: status,
                    level: 'basic',
                    joinDate: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    expiry: ''
                };
            }

            // 新增：處理新會員
            async handleNewMember(phoneNumber) {
                try {
                    // 非阻塞創建會員（降低優先級）
                    this.createPendingMemberAsync(phoneNumber);

                    const pendingMember = this.createDefaultMemberData(phoneNumber, 'pending');

                    // 緊存儲到緩存
                    const memberDataString = JSON.stringify(pendingMember);
                    const timeString = Date.now().toString();

                    sessionStorage.setItem(`member_${phoneNumber}`, memberDataString);
                    sessionStorage.setItem(`lastCheck_${phoneNumber}`, timeString);

                    this.memberData = pendingMember;
                    this.showSuspensionModal();
                    this.clearLogin();
                } catch (error) {
                    console.warn('處理新會員失敗:', error);
                    this.handleMemberDataFallback(phoneNumber, error);
                }
            }

            // 創建待審核會員（符合 Firebase 規則的版本）
            async createPendingMemberAsync(phoneNumber) {
                try {
                    // 驗證手機號碼格式（符合 Firebase 規則）
                    if (!phoneNumber || !phoneNumber.match(/^09[0-9]{8}$/)) {
                        throw new Error('手機號碼格式不正確');
                    }

                    const pendingMember = {
                        phone: phoneNumber,
                        status: 'pending',
                        level: 'basic',
                        createdAt: firebase.firestore.Timestamp.now(), // 使用 Firestore Timestamp
                        lastLogin: new Date().toISOString()
                    };

                    // 使用重試機制創建會員
                    await this.retryFirestoreOperation(
                        () => this.db.collection('members').doc(phoneNumber).set(pendingMember),
                        '創建待審核會員'
                    );

                    console.log('待審核會員創建成功:', phoneNumber);
                } catch (error) {
                    if (error.code === 'permission-denied') {
                        console.warn('權限不足，無法創建會員資料');
                    } else {
                        console.error('創建待審核會員失敗:', error);
                        throw error;
                    }
                }
            }

            // 新增：會員資料降級處理
            async handleMemberDataFallback(phoneNumber, originalError) {
                // 嘗試使用過期的本地緩存
                const expiredLocalData = localStorage.getItem(`member_data_${phoneNumber}`);
                if (expiredLocalData) {
                    try {
                        const member = JSON.parse(expiredLocalData);
                        console.warn('使用過期緩存資料:', phoneNumber);
                        this.updateMemberStatus('會員狀態：使用離線資料', '(可能不是最新)');
                        await this.processMemberData(phoneNumber, member, true);
                        return;
                    } catch (e) {
                        localStorage.removeItem(`member_data_${phoneNumber}`);
                        localStorage.removeItem(`member_time_${phoneNumber}`);
                    }
                }

                // 最終降級：創建臨時基礎會員
                console.warn('所有會員資料獲取方式失敗，使用臨時基礎會員');
                const tempMember = this.createDefaultMemberData(phoneNumber, 'pending');

                this.memberData = tempMember;
                this.updateMemberStatus('會員狀態：無法驗證', '請聯繫客服');

                // 根據錯誤類型決定處理方式
                if (originalError.message.includes('permissions') ||
                    originalError.message.includes('insufficient')) {
                    this.showSuspensionModal();
                    this.clearLogin();
                } else {
                    // 網路或其他錯誤，允許以基礎會員身份繼續
                    this.showMainContent();
                    await this.renderMemberBenefits();
                }
            }

            // 更新最後登入時間（增加權限檢查）
            async updateLastLogin(phoneNumber) {
                setTimeout(async () => {
                    try {
                        // 檢查會員是否存在
                        const memberDoc = await this.db.collection('members').doc(phoneNumber).get();

                        if (memberDoc.exists) {
                            // 會員存在，嘗試更新登入時間
                            await this.db.collection('members').doc(phoneNumber).update({
                                lastLogin: new Date().toISOString()
                            });
                            console.log('登入時間更新成功');
                        } else {
                            // 會員不存在，創建基本會員資料（包含登入時間）
                            await this.createPendingMemberAsync(phoneNumber);
                        }
                    } catch (error) {
                        if (error.code === 'permission-denied') {
                            console.warn('權限不足，跳過登入時間更新');
                        } else if (error.code === 'not-found') {
                            console.warn('會員資料不存在，跳過更新');
                        } else {
                            console.warn('更新登入時間失敗:', error);
                        }
                        // 不阻塞主流程
                    }
                }, 500); // 延遲執行，避免阻塞登入流程
            }



            // 統一處理會員數據
            async processMemberData(phoneNumber, member, fromCache) {
                if (member.status === 'suspended' || member.status === 'pending') {
                    this.memberData = member;
                    this.showSuspensionModal();
                    this.clearLogin();
                    return;
                }

                // 只在非快取情況下更新登入時間
                if (!fromCache) {
                    this.updateLastLogin(phoneNumber);
                }

                this.memberData = member;
                sessionStorage.setItem('memberData', JSON.stringify(member));
                sessionStorage.setItem('userPhone', phoneNumber);
                this.currentUser = phoneNumber;

                const levelText = member.status === 'active' ?
                    `會員狀態：${this.getMemberLevelName(member.level)}` :
                    '會員狀態：未審核';
                const expiryText = member.status === 'active' ?
                    `(到期日：${member.expiry || '未設定'})` :
                    '';

                this.updateMemberStatus(levelText, expiryText);
                this.showMainContent();
                await this.renderMemberBenefits();
            }

            // 更新會員狀態顯示
            updateMemberStatus(levelText, expiryText) {
                // 更新頂部會員資訊
                const memberLevelBadge = document.getElementById('memberLevelBadge');
                const memberPhoneDisplay = document.getElementById('memberPhoneDisplay');

                if (memberLevelBadge && this.memberData) {
                    memberLevelBadge.textContent = this.getMemberLevelName(this.memberData.level);
                }

                if (memberPhoneDisplay && this.currentUser) {
                    memberPhoneDisplay.textContent = this.formatTaiwanPhoneNumber(this.currentUser);
                }
            }

            // 渲染會員優惠層級
            async renderMemberBenefits() {
                const benefitsGrid = document.getElementById('benefitsGrid');
                if (!benefitsGrid) return;

                try {
                    const settings = await this.getSettings();
                    const currentLevel = (this.memberData && this.memberData.level) || 'basic';

                    const tiers = [
                        {
                            id: 'basic',
                            name: '基礎會員',
                            condition: '所有會員',
                            rate: settings.purchaseCost || 4.2850,
                            icon: 'fas fa-user',
                            iconClass: 'basic'
                        },
                        {
                            id: 'tenThousand',
                            name: '滿萬會員',
                            condition: '單筆滿萬或會員等級',
                            rate: settings.tenThousandDiscount || 4.2650,
                            icon: 'fas fa-star',
                            iconClass: 'ten-thousand'
                        },
                        {
                            id: 'fiftyThousand',
                            name: '五萬會員',
                            condition: '單筆五萬或會員等級',
                            rate: settings.fiftyThousandDiscount || 4.2550,
                            icon: 'fas fa-crown',
                            iconClass: 'fifty-thousand'
                        },
                        {
                            id: 'negotiable',
                            name: '議價會員',
                            condition: '更優惠費率等你探索',
                            rate: settings.negotiableDiscount || 4.2450,
                            icon: 'fas fa-gem',
                            iconClass: 'negotiable'
                        }
                    ];

                    benefitsGrid.innerHTML = '';

                    // 檢測是否為行動裝置（小於等於768px）
                    const tiersToShow = this.isMobileDevice()
                        ? tiers.filter(tier => tier.id === currentLevel)  // 行動裝置只顯示當前等級
                        : tiers;  // 桌面版顯示所有等級

                    tiersToShow.forEach(tier => {
                        const tierElement = document.createElement('div');
                        tierElement.className = `benefit-tier ${currentLevel === tier.id ? 'current' : ''}`;

                        // 議價會員邏輯：只有當前用戶也是議價會員時才顯示實際費率
                        const isCurrentUserNegotiable = tier.id === 'negotiable' &&
                            currentLevel === 'negotiable' &&
                            this.memberData?.status === 'active';
                        const displayRate = (tier.id === 'negotiable' && !isCurrentUserNegotiable) ? '4.XX' : tier.rate;

                        if (tier.id === 'negotiable') {
                            tierElement.classList.add('negotiable-tier');
                        }

                        // 安全地創建會員等級DOM元素
                        const tierHeader = document.createElement('div');
                        tierHeader.className = 'tier-header';

                        const tierIcon = document.createElement('div');
                        tierIcon.className = `tier-icon ${tier.iconClass}`;
                        const iconElement = document.createElement('i');
                        iconElement.className = tier.icon;
                        tierIcon.appendChild(iconElement);

                        const tierInfo = document.createElement('div');
                        tierInfo.className = 'tier-info';
                        const tierName = document.createElement('h4');
                        tierName.textContent = tier.name;
                        const tierCondition = document.createElement('p');
                        tierCondition.className = 'tier-condition';

                        // 為解鎖的議價會員顯示特殊說明
                        if (tier.id === 'negotiable' && currentLevel === 'negotiable' &&
                            this.memberData?.status === 'active' && displayRate !== '4.XX') {
                            tierCondition.textContent = '🎉 恭喜！您的專屬優惠費率';
                            tierCondition.classList.add('unlocked-condition');
                        } else {
                            tierCondition.textContent = tier.condition;
                        }
                        tierInfo.appendChild(tierName);
                        tierInfo.appendChild(tierCondition);

                        tierHeader.appendChild(tierIcon);
                        tierHeader.appendChild(tierInfo);

                        const tierRate = document.createElement('div');
                        tierRate.className = 'tier-rate';

                        // 檢查是否為解鎖的議價會員
                        const isUnlockedNegotiable = isCurrentUserNegotiable && displayRate !== '4.XX';

                        if (isUnlockedNegotiable) {
                            // 添加水平布局類
                            tierRate.classList.add('has-unlock');

                            // 添加解鎖標識
                            const unlockBadge = document.createElement('span');
                            unlockBadge.className = 'unlock-badge';
                            unlockBadge.innerHTML = '<i class="fas fa-unlock"></i> 已解鎖';
                            tierRate.appendChild(unlockBadge);
                        }

                        // 添加費率數字
                        const rateValue = document.createElement('span');
                        rateValue.className = 'rate-value';
                        rateValue.textContent = displayRate;

                        if (isUnlockedNegotiable) {
                            rateValue.classList.add('unlocked-rate');
                        }

                        tierRate.appendChild(rateValue);

                        tierElement.appendChild(tierHeader);
                        tierElement.appendChild(tierRate);

                        benefitsGrid.appendChild(tierElement);
                    });
                } catch (error) {
                    console.error('渲染會員優惠層級失敗:', error);
                    // 顯示基本的錯誤狀態
                    benefitsGrid.innerHTML = '<div class="error-message">載入會員優惠資訊時發生錯誤</div>';
                }
            }

            // 顯示主內容
            showMainContent() {
                // 防止在 hash 處理過程中觸發循環
                if (window.location.hash === '#Login' && !this._isHandlingHashChange) {
                    this._isHandlingHashChange = true;
                    window.location.hash = '';
                    this._isHandlingHashChange = false;
                }

                const loginSection = document.getElementById('loginSection');
                const mainContent = document.getElementById('mainContent');

                if (loginSection && mainContent) {
                    loginSection.style.display = 'none';
                    mainContent.style.display = 'block';
                    mainContent.classList.add('active');
                }
            }

            // 顯示登入頁面
            showLoginPage() {
                const loginSection = document.getElementById('loginSection');
                const mainContent = document.getElementById('mainContent');

                if (loginSection && mainContent) {
                    loginSection.style.display = 'flex';
                    mainContent.style.display = 'none';
                    mainContent.classList.remove('active');
                }
            }

            // 檢查登入狀態（增強版權限處理）
            async checkLoginStatus() {
                this.closeSuspensionModal();

                const savedPhone = sessionStorage.getItem('userPhone');
                const cachedMemberDataString = sessionStorage.getItem('memberData');
                let cachedMemberData = null;

                if (cachedMemberDataString) {
                    try {
                        cachedMemberData = JSON.parse(cachedMemberDataString);
                    } catch (e) {
                        sessionStorage.removeItem('memberData'); // 清除損壞的資料
                    }
                }

                if (!savedPhone) {
                    this.showLoginPage();
                    return;
                }

                this.currentUser = savedPhone;

                // 優先使用緩存資料更新UI
                if (cachedMemberData) {
                    this.memberData = cachedMemberData;
                    if (cachedMemberData.status === 'suspended' || cachedMemberData.status === 'pending') {
                        this.showSuspensionModal();
                    }

                    const levelText = cachedMemberData.status === 'active' ?
                        `會員狀態：${this.getMemberLevelName(cachedMemberData.level)}` :
                        '會員狀態：未審核';
                    const expiryText = cachedMemberData.status === 'active' ?
                        `(到期日：${cachedMemberData.expiry || '未設定'})` :
                        '';

                    this.updateMemberStatus(levelText, expiryText);
                    this.showMainContent();
                    await this.renderMemberBenefits();
                } else {
                    // 如果沒有緩存資料，但有電話號碼，顯示主內容並提示載入中
                    this.showMainContent();
                    this.updateMemberStatus('會員狀態：載入中...', '');
                    // 先渲染基礎的優惠層級
                    await this.renderMemberBenefits();
                }

                try {
                    // 增加超時控制，避免長時間等待
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('Firebase request timeout')), 8000);
                    });

                    const fetchPromise = this.db.collection('members').doc(savedPhone).get();
                    const memberDoc = await Promise.race([fetchPromise, timeoutPromise]);

                    if (memberDoc.exists) {
                        const member = memberDoc.data();

                        // 驗證會員資料完整性
                        const validatedMember = this.validateMemberData(member, savedPhone);

                        sessionStorage.setItem('memberData', JSON.stringify(validatedMember)); // 更新緩存
                        this.memberData = validatedMember; // 更新應用的 memberData

                        if (validatedMember.status === 'suspended' || validatedMember.status === 'pending') {
                            this.showSuspensionModal();
                        } else if (validatedMember.status === 'active') {
                            this.closeSuspensionModal();
                        }

                        // 非阻塞更新登入時間
                        this.updateLastLogin(savedPhone);

                        const levelText = validatedMember.status === 'active' ?
                            `會員狀態：${this.getMemberLevelName(validatedMember.level)}` :
                            '會員狀態：未審核';
                        const expiryText = validatedMember.status === 'active' ?
                            `(到期日：${validatedMember.expiry || '未設定'})` :
                            '';

                        this.updateMemberStatus(levelText, expiryText);
                        await this.renderMemberBenefits();

                        if (!cachedMemberData) {
                            this.showMainContent();
                        }

                        // 如果當前在查詢標籤，重新載入訂單（包含狀態檢查）
                        if (document.getElementById('queryTab').classList.contains('active')) {
                            await this.loadUserOrders(savedPhone);
                            // 啟動自動檢查
                            this.startAutoOrderCheck(savedPhone);
                        }
                    } else {
                        console.warn('會員帳號不存在:', savedPhone);
                        this.showUnifiedErrorModal('您的登入資訊已失效或帳號不存在，請重新登入。');
                        this.clearLogin();
                    }
                } catch (error) {
                    console.warn('檢查登入狀態失敗:', error.message);

                    // 根據是否有緩存資料決定處理方式
                    if (!cachedMemberData) {
                        // 沒有緩存時的處理
                        if (error.message.includes('permissions') || error.message.includes('insufficient')) {
                            this.showUnifiedErrorModal('無法驗證會員權限，請聯繫客服處理。');
                            this.clearLogin();
                        } else if (error.message !== 'Firebase request timeout') {
                            this.showUnifiedErrorModal('無法驗證您的登入狀態，請檢查網路連線或稍後再試。');
                            this.clearLogin();
                        } else {
                            // 超時錯誤，允許繼續但提示
                            this.updateMemberStatus('會員狀態：網路連線超時', '請稍後重新整理');
                        }
                    } else {
                        // 有緩存時只顯示警告，不影響使用
                        console.warn('與伺服器同步資料失敗，使用本地緩存');
                        this.updateMemberStatus(
                            this.updateMemberStatus.arguments ?
                                this.updateMemberStatus.arguments[0] + ' (離線)' :
                                '會員狀態：離線模式',
                            '部分資訊可能不是最新'
                        );
                    }
                }
            }



            // 清除登入狀態
            clearLogin() {
                sessionStorage.removeItem('userPhone');
                sessionStorage.removeItem('memberData');

                // 清除電話號碼相關的快取
                if (this.currentUser) {
                    sessionStorage.removeItem(`member_${this.currentUser}`);
                    sessionStorage.removeItem(`lastCheck_${this.currentUser}`);
                }

                this.currentUser = null;
                this.memberData = null;

                const phoneNumberInput = document.getElementById('phoneNumber');
                if (phoneNumberInput) phoneNumberInput.value = '';

                // 重置頂部會員資訊
                const memberLevelBadge = document.getElementById('memberLevelBadge');
                const memberPhoneDisplay = document.getElementById('memberPhoneDisplay');
                if (memberLevelBadge) memberLevelBadge.textContent = '基礎會員';
                if (memberPhoneDisplay) memberPhoneDisplay.textContent = '未登入';

                window.location.hash = 'Login';
            }

            // 登出
            logout() {
                // 停止自動檢查
                this.stopAutoOrderCheck();
                this.clearLogin();
            }

            // 處理觸控開始事件（Android優化）
            handleSubmitTouchStart(event) {
                // 為觸控設備提供視覺反饋
                const btn = event.target;
                btn.style.opacity = '0.8';

                // 短暫延遲後恢復
                setTimeout(() => {
                    btn.style.opacity = '';
                }, 150);
            }

            // 處理點擊事件（後備方案）
            handleSubmitClick(event) {
                // 防止重複觸發
                if (event.detail > 1) return;

                // 手動觸發表單提交
                const form = event.target.closest('form');
                if (form) {
                    // 創建並派發submit事件
                    const submitEvent = new Event('submit', {
                        bubbles: true,
                        cancelable: true
                    });
                    form.dispatchEvent(submitEvent);
                }
            }

            // 處理訂單提交
            async handleOrderSubmit(event) {
                event.preventDefault();

                // 防止重複提交 - 根據編輯模式選擇正確的按鈕
                const submitBtn = this.isEditingOrder
                    ? event.target.querySelector('.edit-actions .submit-btn')
                    : event.target.querySelector('#submitBtn');

                if (submitBtn && submitBtn.disabled) {
                    return;
                }

                // 禁用提交按鈕
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = this.isEditingOrder ? '變更中...' : '提交中...';
                }

                if (this.isEditingOrder) {
                    await this.handleEditSubmit();
                    return;
                }

                try {
                    // 統一驗證表單數據（包含支付類型和檔案檢查）
                    const validationResult = await this.validateCompleteForm();
                    if (!validationResult.isValid) {
                        this.showUnifiedErrorModal(validationResult.error);
                        return;
                    }

                    const formData = await this.getFormData();
                    const orderNumber = formData.orderNumber;

                    // 檢查訂單編號是否已存在（添加重試機制）
                    const existingOrder = await this.retryFirestoreOperation(
                        () => this.db.collection('orders').doc(orderNumber).get(),
                        '檢查訂單編號'
                    );

                    if (existingOrder.exists) {
                        throw new Error('訂單編號已存在，請重新生成');
                    }

                    // 使用安全的訂單創建方法
                    const orderRef = await this.createOrderSafely(formData, orderNumber);

                    // 非阻塞檔案上傳（即使失敗也不影響訂單創建）
                    setTimeout(async () => {
                        try {
                            await this.uploadOrderFiles(orderRef, formData.paymentType);
                            console.log('檔案上傳完成');
                        } catch (error) {
                            console.warn('檔案上傳失敗，但訂單已成功創建:', error);
                            // 可以在這裡添加重試邏輯或提示用戶稍後重新上傳
                        }
                    }, 100);

                    // 顯示成功並重置表單
                    this.showSuccessModal(formData.orderNumber);
                    this.resetForm();

                    if (document.getElementById('queryTab').classList.contains('active')) {
                        await this.loadUserOrders(formData.phone);
                    }
                } catch (error) {
                    this.handleError(error, '訂單提交');
                } finally {
                    // 重新啟用提交按鈕
                    const submitBtn = this.isEditingOrder
                        ? event.target.querySelector('.edit-actions .submit-btn')
                        : event.target.querySelector('#submitBtn');

                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = this.isEditingOrder ? '變更' : '申請';
                    }
                }
            }

            // 處理編輯提交
            async handleEditSubmit() {
                try {
                    const validationResult = await this.validateCompleteForm();
                    if (!validationResult.isValid) {
                        this.showUnifiedErrorModal(validationResult.error);
                        return;
                    }

                    const formData = await this.getFormData();

                    // 構建更新對象，只包含有意義的字段
                    const updateData = {
                        paymentType: formData.paymentType,
                        amount: formData.amount,
                        phone: formData.phone,
                        orderNumber: formData.orderNumber,
                        updatedAt: new Date().toISOString(),
                        lastUpdated: new Date().toISOString()
                    };

                    // 只有當條件性字段存在於formData中時才添加到更新對象
                    if (formData.wechatAccount) updateData.wechatAccount = formData.wechatAccount;
                    if (formData.alipayAccount) updateData.alipayAccount = formData.alipayAccount;
                    if (formData.taobaoLink) updateData.taobaoLink = formData.taobaoLink;
                    if (formData.alibabaLink) updateData.alibabaLink = formData.alibabaLink;
                    if (formData.othersProductLink) updateData.othersProductLink = formData.othersProductLink;
                    if (formData.othersDescription) updateData.othersDescription = formData.othersDescription;

                    // 使用重試機制更新訂單
                    await this.retryFirestoreOperation(
                        () => this.db.collection('orders').doc(this.editingOrderId).update(updateData),
                        '更新訂單'
                    );

                    this.showUnifiedSuccessModal('訂單更新成功');
                    await this.switchTab('query');
                    this.resetEditMode();
                } catch (error) {
                    this.handleError(error, '訂單更新');
                }
            }

            // 獲取表單數據（符合 Firebase 規則的版本）
            async getFormData() {
                const amountValue = parseFloat(document.getElementById('amount').value);
                const paymentType = document.getElementById('paymentType').value;
                const phone = this.currentUser || sessionStorage.getItem('userPhone');
                const orderNumber = document.getElementById('orderNumberDisplay').textContent;

                // 驗證必要欄位（符合 Firebase 規則）
                if (!phone || !phone.match(/^09[0-9]{8}$/)) {
                    throw new Error('手機號碼格式不正確');
                }
                if (!paymentType || !['wechat', 'alipay', 'taobao', 'alibaba', 'others'].includes(paymentType)) {
                    throw new Error('支付類型無效');
                }
                if (isNaN(amountValue) || amountValue <= 0) {
                    throw new Error('採購金額必須大於 0');
                }
                if (!orderNumber || orderNumber.trim().length === 0) {
                    throw new Error('訂單編號不能為空');
                }

                const settings = await this.getSettings();
                const defaultDays = settings.defaultCompletionDays || 3;
                const memberData = this.memberData || {};

                // 基本必要字段（符合 Firebase 規則的必要欄位）
                const formData = {
                    phone: phone,
                    amount: amountValue,
                    paymentType: paymentType,
                    orderNumber: orderNumber,
                    createdAt: firebase.firestore.Timestamp.now(), // 使用 Firestore Timestamp
                    status: 'pending',
                    lastUpdated: new Date().toISOString(),
                    expectedCompletionTime: new Date(Date.now() + defaultDays * 24 * 60 * 60 * 1000).toISOString(),
                    memberLevel: memberData.level || 'basic',
                    deviceInfo: navigator.userAgent.substring(0, 200) || '',
                    statusHistory: [{
                        status: 'pending',
                        timestamp: new Date().toISOString(),
                        updatedBy: 'user',
                        note: '用戶提交訂單'
                    }]
                };

                // 簡化可選字段處理邏輯
                const optionalFields = [
                    'wechatAccount', 'alipayAccount', 'taobaoLink', 'alibabaLink',
                    'othersProductLink', 'othersDescription'
                ];

                optionalFields.forEach(fieldId => {
                    const value = document.getElementById(fieldId)?.value?.trim();
                    if (value) {
                        formData[fieldId] = value;
                    }
                });

                // 會員到期日（只有非基礎會員且有到期日才記錄）
                if (memberData.expiry && memberData.level !== 'basic') {
                    formData.memberExpiry = memberData.expiry;
                }

                return formData;
            }

            // 統一完整表單驗證（避免重複檢查）
            async validateCompleteForm() {
                // 檢查登入狀態
                if (!this.currentUser && !sessionStorage.getItem('userPhone')) {
                    return { isValid: false, error: '請先登入會員' };
                }

                // 檢查支付類型選擇
                const paymentType = document.getElementById('paymentType').value;
                if (!paymentType) {
                    return { isValid: false, error: '請選擇支付類型' };
                }

                // 檢查採購金額
                const amountInput = document.getElementById('amount');
                const amount = parseFloat(amountInput.value);
                if (!amountInput.value.trim() || isNaN(amount) || amount <= 0) {
                    return { isValid: false, error: '請輸入有效的採購金額' };
                }

                // 檢查支付類型對應的檔案上傳和輸入
                if (paymentType === 'wechat') {
                    const wechatQrCodeFile = document.getElementById('wechatQrCodeUpload').files[0];
                    const wechatAccount = document.getElementById('wechatAccount').value.trim();
                    if (!wechatQrCodeFile && !wechatAccount) {
                        return { isValid: false, error: '請輸入微信帳號或上傳支付碼' };
                    }
                } else if (paymentType === 'alipay') {
                    const qrCodeFile = document.getElementById('qrCodeUpload').files[0];
                    const alipayAccount = document.getElementById('alipayAccount').value.trim();
                    if (!qrCodeFile && !alipayAccount) {
                        return { isValid: false, error: '請輸入支付寶帳號或上傳支付碼' };
                    }
                } else if (paymentType === 'taobao') {
                    const taobaoImageFile = document.getElementById('taobaoImageUpload').files[0];
                    const taobaoLink = document.getElementById('taobaoLink').value.trim();
                    if (!taobaoImageFile && !taobaoLink) {
                        return { isValid: false, error: '請貼上申請連結或上傳圖片' };
                    }
                } else if (paymentType === 'alibaba') {
                    const alibabaImageFile = document.getElementById('alibabaImageUpload').files[0];
                    const alibabaLink = document.getElementById('alibabaLink').value.trim();
                    if (!alibabaImageFile && !alibabaLink) {
                        return { isValid: false, error: '請貼上申請連結或上傳圖片' };
                    }
                } else if (paymentType === 'others') {
                    const othersImageFile = document.getElementById('othersImageUpload').files[0];
                    const othersProductLink = document.getElementById('othersProductLink').value.trim();
                    if (!othersImageFile && !othersProductLink) {
                        return { isValid: false, error: '請輸入商品連結、商品資訊或上傳相關圖片' };
                    }
                }

                return { isValid: true };
            }



            // 上傳訂單檔案
            async uploadOrderFiles(orderRef, paymentType) {

                const fileConfig = {
                    'wechat': {
                        inputId: 'wechatQrCodeUpload',
                        folder: 'wechat',
                        field: 'wechatQrCodeURL'
                    },
                    'alipay': {
                        inputId: 'qrCodeUpload',
                        folder: 'alipay', // 修正為 alipay，符合 Firebase 規則
                        field: 'qrCodeURL'
                    },
                    'taobao': {
                        inputId: 'taobaoImageUpload',
                        folder: 'taobao',
                        field: 'taobaoImageURL'
                    },
                    'alibaba': {
                        inputId: 'alibabaImageUpload',
                        folder: 'alibaba',
                        field: 'alibabaImageURL'
                    },
                    'others': {
                        inputId: 'othersImageUpload',
                        folder: 'others',
                        field: 'othersImageURL'
                    }
                };

                const config = fileConfig[paymentType];
                if (!config) {
                    console.warn('未知的支付類型:', paymentType);
                    return;
                }

                const fileInput = document.getElementById(config.inputId);
                const file = fileInput?.files[0];

                if (!file) {
                    return;
                }

                try {
                    if (file.size > 2 * 1024 * 1024) {
                        throw new Error('檔案大小超過 2MB 限制');
                    }

                    if (!file.type.startsWith('image/')) {
                        throw new Error('只允許上傳圖片檔案');
                    }

                    const path = `${config.folder}/${this.currentUser}/${Date.now()}_${file.name}`;

                    const url = await this.uploadFile(file, path);

                    await orderRef.update({
                        [config.field]: url,
                        lastUpdated: new Date().toISOString()
                    });

                } catch (error) {
                    console.error('檔案上傳過程失敗:', error);
                    this.logError('file_upload', error.message);
                    throw error;
                }
            }

            // 上傳檔案（優化版本，支持圖片壓縮）
            async uploadFile(file, path) {
                try {
                    if (!this.storage) {
                        throw new Error('Firebase Storage 未初始化');
                    }

                    let fileToUpload = file;

                    // 如果是圖片且大小超過 500KB，進行壓縮
                    if (file.type.startsWith('image/') && file.size > 500 * 1024) {
                        try {
                            fileToUpload = await this.compressImage(file);
                        } catch (compressError) {
                            console.warn('圖片壓縮失敗，使用原檔案:', compressError);
                            fileToUpload = file;
                        }
                    }

                    const storageRef = this.storage.ref();
                    const fileRef = storageRef.child(path);

                    // 設置上傳 metadata 優化傳輸
                    const metadata = {
                        contentType: fileToUpload.type,
                        cacheControl: 'public,max-age=3600'
                    };

                    const snapshot = await fileRef.put(fileToUpload, metadata);
                    const downloadURL = await snapshot.ref.getDownloadURL();

                    return downloadURL;
                } catch (error) {
                    throw error;
                }
            }

            // 壓縮圖片
            async compressImage(file, maxWidth = 1200, quality = 0.8) {
                return new Promise((resolve, reject) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();

                    img.onload = () => {
                        // 計算新的尺寸
                        let { width, height } = img;
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        // 繪製並壓縮
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob(
                            (blob) => {
                                if (blob) {
                                    // 創建新的 File 物件
                                    const compressedFile = new File([blob], file.name, {
                                        type: file.type,
                                        lastModified: Date.now()
                                    });
                                    resolve(compressedFile);
                                } else {
                                    reject(new Error('圖片壓縮失敗'));
                                }
                            },
                            file.type,
                            quality
                        );
                    };

                    img.onerror = () => reject(new Error('圖片載入失敗'));
                    img.src = URL.createObjectURL(file);
                });
            }

            // 選擇支付類型
            selectPaymentType(type) {
                document.getElementById('paymentType').value = type;

                document.querySelectorAll('.payment-type-card').forEach(card => {
                    card.classList.remove('selected');
                    card.setAttribute('aria-checked', 'false');
                });
                const selectedCard = document.querySelector(`.payment-type-card[data-payment-type="${type}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                    selectedCard.setAttribute('aria-checked', 'true');
                }

                // 切換支付類型時清除所有上傳的圖片和文字輸入
                this.clearAllPaymentInputs();

                document.getElementById('wechatFields').classList.remove('active');
                document.getElementById('alipayFields').classList.remove('active');
                document.getElementById('taobaoFields').classList.remove('active');
                document.getElementById('alibabaFields').classList.remove('active');
                document.getElementById('othersFields').classList.remove('active');
                if (type === 'wechat') {
                    document.getElementById('wechatFields').classList.add('active');
                } else if (type === 'alipay') {
                    document.getElementById('alipayFields').classList.add('active');
                } else if (type === 'taobao') {
                    document.getElementById('taobaoFields').classList.add('active');
                } else if (type === 'alibaba') {
                    document.getElementById('alibabaFields').classList.add('active');
                } else if (type === 'others') {
                    document.getElementById('othersFields').classList.add('active');
                }

                this.generateOrderNumber();
            }

            // 計算最終金額
            async calculateFinalAmount() {
                const amount = parseFloat(document.getElementById('amount').value) || 0;
                const resultDisplay = document.getElementById('resultDisplay');
                const userPhone = sessionStorage.getItem('userPhone');

                if (!amount) {
                    resultDisplay.innerHTML = '總成本：<span class="final-amount-display">請輸入金額</span>';
                    return;
                }

                if (!userPhone) {
                    resultDisplay.innerHTML = '請先登入會員';
                    return;
                }

                try {
                    const memberDoc = await this.db.collection('members').doc(userPhone).get();
                    const member = memberDoc.exists ? memberDoc.data() : null;
                    const settings = await this.getSettings();

                    let finalAmount = 0;
                    let type = '';

                    if (member && member.status === 'active') {
                        let costRate = settings.purchaseCost || 4.2850; // 預設基礎成本

                        switch (member.level) {
                            case 'fiftyThousand':
                                costRate = settings.fiftyThousandDiscount || 4.2550;
                                type = '五萬優惠';
                                break;
                            case 'tenThousand':
                                if (amount >= 50000) {
                                    costRate = settings.fiftyThousandDiscount || 4.2550;
                                    type = '五萬優惠';
                                } else {
                                    costRate = settings.tenThousandDiscount || 4.2650;
                                    type = '滿萬優惠';
                                }
                                break;
                            case 'negotiable':
                                costRate = settings.negotiableDiscount || 4.2450;
                                type = '議價優惠';
                                break;
                            default:
                                if (amount >= 50000) {
                                    costRate = settings.fiftyThousandDiscount || 4.2550;
                                    type = '五萬優惠';
                                } else if (amount >= 10000) {
                                    costRate = settings.tenThousandDiscount || 4.2650;
                                    type = '滿萬優惠';
                                } else {
                                    costRate = settings.purchaseCost || 4.2850;
                                    type = '基礎成本';
                                }
                                break;
                        }

                        finalAmount = Math.round(amount * costRate);
                        resultDisplay.innerHTML = `${type}：<span class="final-amount-display">${finalAmount}</span>`;
                    } else {
                        resultDisplay.innerHTML = '請先登入會員';
                    }
                } catch (error) {
                    console.error('計算金額失敗:', error);
                    resultDisplay.innerHTML = '計算失敗，請稍後再試';
                }
            }

            async getSettings() {
                const defaultSettings = {
                    purchaseCost: 4.2850,
                    tenThousandDiscount: 4.2650,
                    fiftyThousandDiscount: 4.2550,
                    negotiableDiscount: 4.2450,
                    defaultCompletionDays: 3
                };

                // 優化緩存機制，延長緩存時間減少請求頻率
                const now = Date.now();
                const CACHE_DURATION = 5 * 60 * 1000; // 5分鐘緩存，減少 Firebase 請求

                if (this.cachedSettings && this.settingsLastFetched &&
                    (now - this.settingsLastFetched < CACHE_DURATION)) {
                    return this.cachedSettings;
                }

                // 檢查本地緩存（跨頁面會話）
                const localCacheKey = 'app_settings_cache';
                const localCacheTimeKey = 'app_settings_cache_time';
                const localCachedTime = localStorage.getItem(localCacheTimeKey);
                const localCachedData = localStorage.getItem(localCacheKey);

                if (localCachedData && localCachedTime &&
                    (now - parseInt(localCachedTime)) < CACHE_DURATION) {
                    try {
                        const parsedSettings = JSON.parse(localCachedData);
                        this.cachedSettings = parsedSettings;
                        this.settingsLastFetched = now;
                        return parsedSettings;
                    } catch (e) {
                        // 本地緩存損壞，清除後繼續
                        localStorage.removeItem(localCacheKey);
                        localStorage.removeItem(localCacheTimeKey);
                    }
                }

                try {
                    // 增加超時控制，避免長時間卡住
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('Firebase request timeout')), 10000);
                    });

                    const fetchPromise = this.db.collection('settings').doc('procurement').get();
                    const settingsDoc = await Promise.race([fetchPromise, timeoutPromise]);

                    let firebaseSettings = {};
                    if (settingsDoc.exists) {
                        firebaseSettings = settingsDoc.data() || {};
                    }

                    const settings = {
                        purchaseCost: this.validateNumber(firebaseSettings.purchaseCost, defaultSettings.purchaseCost),
                        tenThousandDiscount: this.validateNumber(firebaseSettings.tenThousandDiscount, defaultSettings.tenThousandDiscount),
                        fiftyThousandDiscount: this.validateNumber(firebaseSettings.fiftyThousandDiscount, defaultSettings.fiftyThousandDiscount),
                        negotiableDiscount: this.validateNumber(firebaseSettings.negotiableDiscount, defaultSettings.negotiableDiscount),
                        defaultCompletionDays: this.validateNumber(firebaseSettings.defaultCompletionDays, defaultSettings.defaultCompletionDays, true)
                    };

                    // 更新所有緩存層級
                    this.cachedSettings = settings;
                    this.settingsLastFetched = now;

                    // 更新本地存儲緩存
                    try {
                        localStorage.setItem(localCacheKey, JSON.stringify(settings));
                        localStorage.setItem(localCacheTimeKey, now.toString());
                    } catch (storageError) {
                        console.warn('無法存儲本地緩存:', storageError);
                    }

                    return settings;
                } catch (error) {
                    console.warn('Firebase 設置獲取失敗，使用默認設置:', error.message);

                    // 嘗試使用現有緩存
                    if (this.cachedSettings) {
                        return this.cachedSettings;
                    }

                    // 嘗試使用本地緩存
                    if (localCachedData) {
                        try {
                            const parsedSettings = JSON.parse(localCachedData);
                            this.cachedSettings = parsedSettings;
                            return parsedSettings;
                        } catch (e) {
                            console.warn('本地緩存解析失敗:', e);
                        }
                    }

                    // 最後使用默認設置並緩存
                    this.cachedSettings = defaultSettings;
                    this.settingsLastFetched = now;

                    return defaultSettings;
                }
            }

            // 新增：數值驗證輔助方法
            validateNumber(value, defaultValue, isInteger = false) {
                if (typeof value === 'number' && !isNaN(value) && value > 0) {
                    return isInteger ? Math.floor(value) : value;
                }
                return defaultValue;
            }

            // 切換標籤頁
            async switchTab(tabName) {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                const activeTab = document.querySelector(`.tab[data-tab-name="${tabName}"]`);
                if (activeTab) {
                    activeTab.classList.add('active');
                }

                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}Tab`).classList.add('active');

                if (tabName === 'query') {
                    const userPhone = sessionStorage.getItem('userPhone');
                    if (userPhone) {
                        // 顯示載入狀態
                        const orderList = document.getElementById('orderList');
                        if (orderList) {
                            orderList.innerHTML = '<div class="no-orders">載入中...</div>';
                        }

                        await this.loadUserOrders(userPhone);

                        // 啟動自動檢查訂單狀態
                        this.startAutoOrderCheck(userPhone);
                    }
                } else if (tabName === 'apply') {
                    // 停止自動檢查訂單狀態
                    this.stopAutoOrderCheck();

                    // 確保會員優惠層級正確顯示
                    await this.renderMemberBenefits();

                    // 行動裝置體驗優化：自動滾動到申請表單區域
                    this.scrollToApplyForm();
                }
            }

            // 檢測是否為觸控設備
            isTouchDevice() {
                return ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            }

            // 統一的行動裝置檢測方法 - 避免魔術數字和重複邏輯
            isMobileDevice() {
                return window.innerWidth <= 768;
            }

            // 檢測是否需要行動裝置優化（尺寸或觸控）
            isMobileOrTouch() {
                return this.isMobileDevice() || this.isTouchDevice();
            }

            // 平滑滾動到申請表單區域（行動裝置體驗優化）
            scrollToApplyForm() {
                // 只在行動裝置或觸控設備上執行滾動
                if (this.isMobileOrTouch()) {
                    setTimeout(() => {
                        const tabsElement = document.querySelector('.tabs');
                        if (tabsElement) {
                            // 優先使用現代瀏覽器的 scrollIntoView，降級支援舊瀏覽器
                            if ('scrollIntoView' in tabsElement && typeof tabsElement.scrollIntoView === 'function') {
                                try {
                                    tabsElement.scrollIntoView({
                                        behavior: 'smooth',
                                        block: 'start',
                                        inline: 'nearest'
                                    });
                                } catch (error) {
                                    // 降級到基本的 scrollIntoView（不支援選項）
                                    tabsElement.scrollIntoView(true);
                                }
                            } else {
                                // 極舊瀏覽器的手動滾動降級
                                const rect = tabsElement.getBoundingClientRect();
                                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                                window.scrollTo(0, rect.top + scrollTop);
                            }

                            // 滾動完成後添加視覺提示動畫
                            setTimeout(() => {
                                const paymentTypes = document.querySelector('.payment-types');

                                if (paymentTypes && !paymentTypes.classList.contains('scroll-highlight')) {
                                    paymentTypes.classList.add('scroll-highlight');
                                    // 動畫完成後移除class，使用更精確的清理
                                    setTimeout(() => {
                                        if (paymentTypes.classList.contains('scroll-highlight')) {
                                            paymentTypes.classList.remove('scroll-highlight');
                                        }
                                    }, 2000);
                                }
                            }, 600); // 等待滾動動畫完成
                        }
                    }, 100); // 小延遲確保DOM更新完成
                }
            }

            // 載入用戶訂單
            async loadUserOrders(userPhone) {
                try {
                    const ordersSnapshot = await this.db.collection('orders')
                        .where('phone', '==', userPhone)
                        .orderBy('createdAt', 'desc')
                        .get();

                    let orders = ordersSnapshot.docs.map(doc => ({
                        id: doc.id,        // 現在文檔 ID 就是訂單編號
                        orderId: doc.id,   // 保持相容性
                        ...doc.data()
                    }));

                    // 只顯示訂單狀態，不執行自動更新（由後台系統負責）

                    this.displayOrders(orders);
                } catch (error) {
                    console.error('載入訂單失敗:', error);
                    this.displayOrders([]);
                }
            }



            // 啟動自動檢查訂單狀態
            startAutoOrderCheck(userPhone) {
                // 清除現有的計時器
                this.stopAutoOrderCheck();

                // 每10秒自動檢查一次訂單狀態
                this.autoCheckTimer = setInterval(async () => {
                    try {
                        // 只有在查詢標籤活躍時才檢查
                        if (document.getElementById('queryTab').classList.contains('active')) {
                            await this.loadUserOrders(userPhone);
                        } else {
                            // 如果不在查詢標籤，停止自動檢查
                            this.stopAutoOrderCheck();
                        }
                    } catch (error) {
                        console.error('自動檢查訂單狀態失敗:', error);
                        // 發生錯誤時停止自動檢查，避免持續錯誤
                        this.stopAutoOrderCheck();
                    }
                }, 10000); // 10秒檢查一次
            }

            // 停止自動檢查訂單狀態
            stopAutoOrderCheck() {
                if (this.autoCheckTimer) {
                    clearInterval(this.autoCheckTimer);
                    this.autoCheckTimer = null;
                }
            }

            // 清理所有計時器和資源
            cleanup() {
                // 清理所有計時器
                this.stopAutoOrderCheck();

                if (this.phoneCheckTimer) {
                    clearTimeout(this.phoneCheckTimer);
                    this.phoneCheckTimer = null;
                }

                if (this.calculateTimer) {
                    clearTimeout(this.calculateTimer);
                    this.calculateTimer = null;
                }

                if (this.resizeTimer) {
                    clearTimeout(this.resizeTimer);
                    this.resizeTimer = null;
                }

                // 清理緩存
                this.cachedSettings = null;
                this.settingsLastFetched = null;

                // 應用程式資源已清理完成
            }

            // 顯示訂單列表
            displayOrders(orders) {
                const orderList = document.getElementById('orderList');
                orderList.innerHTML = '';

                if (!orders || orders.length === 0) {
                    orderList.innerHTML = '<div class="no-orders">尚無訂單記錄</div>';
                    return;
                }

                orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                orders.forEach(order => {
                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';

                    // 安全地創建DOM元素，避免XSS攻擊
                    const titleElement = document.createElement('h3');
                    titleElement.textContent = `訂單編號：${order.orderNumber || order.id}`;

                    const orderInfoDiv = document.createElement('div');
                    orderInfoDiv.className = 'order-info';

                    // 代付類型
                    const typeP = document.createElement('p');
                    const typeLabel = document.createElement('span');
                    typeLabel.className = 'label';
                    typeLabel.textContent = '代付類型：';
                    const typeValue = document.createElement('span');
                    typeValue.className = 'value';
                    typeValue.textContent = this.getPaymentTypeName(order.paymentType);
                    typeP.appendChild(typeLabel);
                    typeP.appendChild(typeValue);

                    // 金額
                    const amountP = document.createElement('p');
                    const amountLabel = document.createElement('span');
                    amountLabel.className = 'label';
                    amountLabel.textContent = '金額：';
                    const amountValue = document.createElement('span');
                    amountValue.className = 'value';
                    amountValue.textContent = Math.round(order.amount);
                    amountP.appendChild(amountLabel);
                    amountP.appendChild(amountValue);

                    // 建立時間
                    const timeP = document.createElement('p');
                    const timeLabel = document.createElement('span');
                    timeLabel.className = 'label';
                    timeLabel.textContent = '建立時間：';
                    const timeValue = document.createElement('span');
                    timeValue.className = 'value';
                    timeValue.textContent = this.formatDateTime(order.createdAt);
                    timeP.appendChild(timeLabel);
                    timeP.appendChild(timeValue);

                    orderInfoDiv.appendChild(typeP);
                    orderInfoDiv.appendChild(amountP);
                    orderInfoDiv.appendChild(timeP);

                    // 狀態
                    const statusDiv = document.createElement('div');
                    statusDiv.className = `order-status status-${order.status}`;
                    statusDiv.textContent = this.getStatusName(order.status);

                    // 組裝元素
                    orderItem.appendChild(titleElement);
                    orderItem.appendChild(orderInfoDiv);
                    orderItem.appendChild(statusDiv);

                    // 編輯按鈕（僅待處理狀態）
                    if (order.status === 'pending') {
                        const editBtn = document.createElement('button');
                        editBtn.className = 'order-item-action-btn';
                        editBtn.textContent = '編輯訂單';
                        editBtn.dataset.orderId = order.id;
                        orderItem.appendChild(editBtn);
                    }

                    orderList.appendChild(orderItem);
                });

                if (!this.orderListEventBound) {
                    orderList.addEventListener('click', (event) => {
                        if (event.target && event.target.classList.contains('order-item-action-btn')) {
                            const orderId = event.target.dataset.orderId;
                            if (orderId) {
                                this.editOrder(orderId);
                            }
                        }
                    });
                    this.orderListEventBound = true;
                }
            }

            // 編輯訂單
            async editOrder(orderId) {
                try {
                    const orderDoc = await this.db.collection('orders').doc(orderId).get();

                    if (!orderDoc.exists) {
                        this.showError('找不到訂單資料');
                        return;
                    }

                    const order = orderDoc.data();
                    await this.switchTab('apply');

                    // 編輯訂單時也自動滾動到表單區域
                    this.scrollToApplyForm();

                    document.getElementById('orderNumberDisplay').textContent = order.orderNumber || orderId;
                    document.getElementById('paymentType').value = order.paymentType;
                    document.getElementById('amount').value = order.amount;

                    this.selectPaymentType(order.paymentType);

                    if (order.paymentType === 'alipay' && order.alipayAccount) {
                        document.getElementById('alipayAccount').value = order.alipayAccount;
                    } else if (order.paymentType === 'taobao' && order.taobaoLink) {
                        document.getElementById('taobaoLink').value = order.taobaoLink;
                    } else if (order.paymentType === 'alibaba' && order.alibabaLink) {
                        document.getElementById('alibabaLink').value = order.alibabaLink;
                    } else if (order.paymentType === 'others') {
                        if (order.othersProductLink) {
                            document.getElementById('othersProductLink').value = order.othersProductLink;
                        }
                        if (order.othersDescription) {
                            document.getElementById('othersDescription').value = order.othersDescription;
                        }
                    }

                    await this.calculateFinalAmount();

                    this.isEditingOrder = true;
                    this.editingOrderId = orderId;

                    // 切換到編輯模式UI
                    this.switchToEditMode();
                } catch (error) {
                    this.handleError(error, '獲取訂單資料');
                }
            }

            // 重置編輯模式
            resetEditMode() {
                this.isEditingOrder = false;
                this.editingOrderId = null;
                this.resetForm();

                // 切換回新增模式UI
                this.switchToCreateMode();
            }

            // 切換到編輯模式UI
            switchToEditMode() {
                const submitBtn = document.getElementById('submitBtn');
                const editActions = document.getElementById('editActions');

                if (submitBtn) {
                    submitBtn.classList.add('hide');
                }

                if (editActions) {
                    editActions.classList.add('active');
                }
            }

            // 切換到新增模式UI
            switchToCreateMode() {
                const submitBtn = document.getElementById('submitBtn');
                const editActions = document.getElementById('editActions');

                if (submitBtn) {
                    submitBtn.classList.remove('hide');
                }

                if (editActions) {
                    editActions.classList.remove('active');
                }
            }

            // 處理取消編輯
            handleCancelEdit() {
                // 重置編輯模式
                this.resetEditMode();

                // 切換回查詢標籤
                this.switchTab('query');
            }



            // 重置表單
            resetForm() {
                document.getElementById('orderForm').reset();
                const resultDisplay = document.getElementById('resultDisplay');
                if (resultDisplay) {
                    resultDisplay.innerHTML = '總成本：<span class="final-amount-display">請輸入金額</span>';
                }
                this.clearAllUploads();

                document.querySelectorAll('.payment-type-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.getElementById('wechatFields').classList.remove('active');
                document.getElementById('alipayFields').classList.remove('active');
                document.getElementById('taobaoFields').classList.remove('active');
                document.getElementById('alibabaFields').classList.remove('active');
                document.getElementById('othersFields').classList.remove('active');

                this.generateOrderNumber();
            }

            // 生成訂單編號
            generateOrderNumber() {
                const numberToLetter = (num) => {
                    const n = parseInt(num);
                    return (n >= 1 && n <= 26) ? String.fromCharCode(64 + n) : num;
                };

                const now = new Date();
                const year = now.getFullYear().toString();
                const yearPart1 = year.substring(0, 2);
                const yearPart2 = year.substring(2, 4);

                const yearLetter1 = numberToLetter(yearPart1);
                const yearLetter2 = numberToLetter(yearPart2);

                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hour = String(now.getHours()).padStart(2, '0');
                const minute = String(now.getMinutes()).padStart(2, '0');
                const second = String(now.getSeconds()).padStart(2, '0');

                const orderNumber = `${yearLetter1}${yearLetter2}${month}${day}${hour}${minute}${second}`;

                const displayElement = document.getElementById('orderNumberDisplay');
                if (displayElement) {
                    displayElement.textContent = orderNumber;
                }

                return orderNumber;
            }

            // 清除所有支付輸入（切換支付類型時使用）
            clearAllPaymentInputs() {
                // 清除所有文字輸入
                const textInputs = [
                    'wechatAccount', 'alipayAccount', 'taobaoLink', 'alibabaLink',
                    'othersProductLink', 'othersDescription'
                ];
                textInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.value = '';
                    }
                });

                // 清除所有上傳的圖片
                this.clearAllUploads();
            }

            // 清除所有上傳預覽
            clearAllUploads() {
                const previews = ['wechatQrCodePreview', 'qrCodePreview', 'taobaoImagePreview', 'alibabaImagePreview', 'othersImagePreview'];
                const fileInputs = ['wechatQrCodeUpload', 'qrCodeUpload', 'taobaoImageUpload', 'alibabaImageUpload', 'othersImageUpload'];

                previews.forEach(id => {
                    const preview = document.getElementById(id);
                    if (preview) {
                        preview.style.display = 'none';
                        preview.src = '';
                    }
                });

                fileInputs.forEach(id => {
                    const fileInput = document.getElementById(id);
                    if (fileInput) {
                        fileInput.value = '';
                    }
                });

                document.querySelectorAll('.upload-icon').forEach(icon => {
                    icon.classList.remove('hide');
                });
            }

            // 複製到剪貼簿
            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    this.showToast('複製成功');
                }).catch(err => {
                    console.error('複製失敗:', err);
                });
            }

            // 顯示 Toast
            showToast(message) {
                const toast = document.getElementById('toast');
                if (toast) {
                    const toastSpan = toast.querySelector('span');
                    if (toastSpan) {
                        toastSpan.textContent = message;
                    }
                    toast.classList.add('show');
                    setTimeout(() => {
                        toast.classList.remove('show');
                    }, 2000);
                }
            }

            // 顯示成功模態框
            showSuccessModal(orderNumber) {
                const orderNumberElement = document.getElementById('orderNumber');
                if (orderNumberElement) {
                    orderNumberElement.textContent = orderNumber;
                }

                const modal = document.getElementById('successModal');
                if (modal) {
                    modal.style.display = 'block';
                }
            }

            // 關閉成功模態框
            closeSuccessModal() {
                const modal = document.getElementById('successModal');
                if (modal) {
                    modal.style.display = 'none';
                }
                this.resetForm();

                // 申請成功後跳轉到查詢頁
                this.switchTab('query');
            }

            // 顯示暫停模態框
            showSuspensionModal() {
                const modal = document.getElementById('suspensionModal');
                const titleElement = document.getElementById('suspensionTitle');
                const messageElement = document.querySelector('.suspension-message');

                if (this.memberData) {
                    if (this.memberData.status === 'suspended') {
                        titleElement.textContent = '會員資格已停權';
                        messageElement.textContent = '請聯繫客服人員了解詳情';
                    } else if (this.memberData.status === 'pending') {
                        titleElement.textContent = '尚未具備會員資格';
                        messageElement.textContent = '請聯繫客服人員了解詳情';
                    }

                    if (modal) {
                        modal.style.display = 'block';
                    }
                }
            }

            // 關閉暫停模態框
            closeSuspensionModal() {
                const modal = document.getElementById('suspensionModal');
                if (modal) {
                    modal.style.display = 'none';
                    modal.style.zIndex = '';
                }
            }

            // 顯示檔案錯誤模態框
            showFileErrorModal(message, title = '檔案過大') {
                const modal = document.getElementById('fileErrorModal');
                const titleElement = document.getElementById('fileErrorTitle');
                const messageElement = document.getElementById('fileErrorMessage');

                if (titleElement) titleElement.textContent = title;
                if (messageElement) messageElement.textContent = message;

                if (modal) {
                    modal.style.display = 'block';

                    // 添加點擊外部關閉功能
                    modal.onclick = (event) => {
                        if (event.target === modal) {
                            this.closeFileErrorModal();
                        }
                    };
                }
            }

            // 關閉檔案錯誤模態框
            closeFileErrorModal() {
                const modal = document.getElementById('fileErrorModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            // 顯示手機號碼警告模態框
            showPhoneWarningModal() {
                this.showFileErrorModal('請輸入正確的手機號碼', '格式錯誤');
            }

            // 顯示統一錯誤提示模態框
            showUnifiedErrorModal(message, title = '提示') {
                const modal = document.getElementById('unifiedErrorModal');
                const titleElement = document.getElementById('unifiedErrorTitle');
                const messageElement = document.getElementById('unifiedErrorMessage');

                if (titleElement) titleElement.textContent = title;
                if (messageElement) messageElement.textContent = message;

                if (modal) {
                    modal.style.display = 'block';

                    // 添加點擊外部關閉功能
                    modal.onclick = (event) => {
                        if (event.target === modal) {
                            this.closeUnifiedErrorModal();
                        }
                    };
                }
            }

            // 關閉統一錯誤提示模態框
            closeUnifiedErrorModal() {
                const modal = document.getElementById('unifiedErrorModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            // 顯示統一成功提示模態框
            showUnifiedSuccessModal(message, title = '成功') {
                const modal = document.getElementById('unifiedSuccessModal');
                const titleElement = document.getElementById('unifiedSuccessTitle');
                const messageElement = document.getElementById('unifiedSuccessMessage');

                if (titleElement) titleElement.textContent = title;
                if (messageElement) messageElement.textContent = message;

                if (modal) {
                    modal.style.display = 'block';

                    // 添加點擊外部關閉功能
                    modal.onclick = (event) => {
                        if (event.target === modal) {
                            this.closeUnifiedSuccessModal();
                        }
                    };
                }
            }

            // 關閉統一成功提示模態框
            closeUnifiedSuccessModal() {
                const modal = document.getElementById('unifiedSuccessModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            // 處理 Hash 變化
            async handleHashChange() {
                const hash = window.location.hash;
                const savedPhone = sessionStorage.getItem('userPhone');

                if (this._isHandlingHashChange) {
                    return;
                }
                this._isHandlingHashChange = true;

                try {
                    if (hash === '#Login') {
                        // 切換到登入頁時停止所有計時器
                        this.stopAutoOrderCheck();
                        if (savedPhone) {
                            window.location.hash = '';
                            return;
                        }
                        this.showLoginPage();
                    } else {
                        if (savedPhone) {
                            await this.checkLoginStatus();
                        } else {
                            // 切換到登入頁時停止所有計時器
                            this.stopAutoOrderCheck();
                            window.location.hash = 'Login';
                        }
                    }
                } finally {
                    this._isHandlingHashChange = false;
                }
            }

            // 輔助方法
            getMemberLevelName(level) {
                const levels = {
                    'basic': '基礎會員',
                    'tenThousand': '滿萬會員',
                    'fiftyThousand': '五萬會員',
                    'negotiable': '議價會員'
                };
                return levels[level] || '未審核';
            }

            getPaymentTypeName(type) {
                const types = {
                    'wechat': '微信支付',
                    'alipay': '支付寶',
                    'taobao': '淘寶代付',
                    'alibaba': '阿里代付',
                    'others': '其他平台'
                };
                return types[type] || type;
            }

            getStatusName(status) {
                const statuses = {
                    'pending': '待處理',
                    'processing': '處理中',
                    'completed': '完成'
                };
                return statuses[status] || status;
            }

            formatDateTime(dateString) {
                const date = new Date(dateString);
                return date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            // 錯誤處理
            handleError(error, context) {
                const errorMessage = error.message || '發生未知錯誤';
                this.showError(`[${context}] ${errorMessage}`);
                this.logError(context, errorMessage);
            }

            showError(message) {
                this.showUnifiedErrorModal(message, '錯誤');
            }

            logError(context, errorMessage) {
                this.db.collection('error_logs').add({
                    context: context,
                    error: errorMessage,
                    timestamp: new Date().toISOString(),
                    userPhone: sessionStorage.getItem('userPhone') || 'unknown'
                }).catch(() => { });
            }

            // 清理過期的快取（增強版）
            cleanExpiredCache() {
                const now = Date.now();
                const CACHE_EXPIRY = 5 * 60 * 1000; // 5分鐘過期
                const keysToRemove = [];

                // 清理 sessionStorage 緩存
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    if (key && (key.startsWith('lastCheck_') || key.startsWith('member_time_'))) {
                        const timestamp = sessionStorage.getItem(key);
                        if (timestamp && (now - parseInt(timestamp)) > CACHE_EXPIRY) {
                            if (key.startsWith('lastCheck_')) {
                                const phoneNumber = key.replace('lastCheck_', '');
                                keysToRemove.push(`member_${phoneNumber}`);
                                keysToRemove.push(key);
                            } else if (key.startsWith('member_time_')) {
                                const phoneNumber = key.replace('member_time_', '');
                                keysToRemove.push(`member_data_${phoneNumber}`);
                                keysToRemove.push(key);
                            }
                        }
                    }
                }

                // 清理 localStorage 緩存
                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('member_time_')) {
                            const timestamp = localStorage.getItem(key);
                            if (timestamp && (now - parseInt(timestamp)) > CACHE_EXPIRY) {
                                const phoneNumber = key.replace('member_time_', '');
                                localStorage.removeItem(`member_data_${phoneNumber}`);
                                localStorage.removeItem(key);
                            }
                        }
                    }

                    // 清理應用設置緩存
                    const settingsTimeKey = 'app_settings_cache_time';
                    const settingsTime = localStorage.getItem(settingsTimeKey);
                    if (settingsTime && (now - parseInt(settingsTime)) > CACHE_EXPIRY) {
                        localStorage.removeItem('app_settings_cache');
                        localStorage.removeItem(settingsTimeKey);
                    }
                } catch (storageError) {
                    console.warn('清理本地緩存失敗:', storageError);
                }

                keysToRemove.forEach(key => sessionStorage.removeItem(key));
            }
        }

        // 簡化的 Firebase 錯誤處理
        (function () {
            const originalConsoleError = console.error;
            console.error = (...args) => {
                const errorStr = args.join(' ');
                // 只攔截明確的 Firebase 權限和 WebChannel 錯誤
                if (errorStr.includes('Missing or insufficient permissions') ||
                    errorStr.includes('WebChannel') ||
                    (errorStr.includes('400') && errorStr.includes('googleapis'))) {
                    console.warn('🔧 Firebase 錯誤已處理:', errorStr.substring(0, 80) + '...');
                    return;
                }
                originalConsoleError.apply(console, args);
            };
        })();

        // 頁面卸載時清理（使用類方法）
        window.addEventListener('beforeunload', () => {
            if (app && app.completeFirebaseCleanup) {
                app.completeFirebaseCleanup();
            }
        });

        // 確保只初始化一次應用
        let app;
        function initializeApp() {
            if (!app) {
                app = new PaymentApp();
                console.log('PaymentApp 初始化完成');
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>

</html>