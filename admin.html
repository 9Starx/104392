<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>後台管理系統</title>
    <!-- 高性能資源預載入 -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    
    <!-- 預載入關鍵 Firebase 模組 -->
    <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js">
    <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js">
    <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js">
    
    <!-- 延遲載入非關鍵 Chart.js -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js" as="script">
    
    <!-- 關鍵CSS內聯 -->
    <style id="critical-css">
        /* Flatpickr 精簡CSS */
        .flatpickr-calendar {
            background: #fff;
            opacity: 0;
            display: none;
            text-align: center;
            visibility: hidden;
            padding: 0;
            direction: ltr;
            border: 0;
            font-size: 14px;
            line-height: 24px;
            border-radius: 5px;
            position: absolute;
            width: 307.875px;
            box-sizing: border-box;
            touch-action: manipulation;
            box-shadow: 1px 0 0 #e6e6e6, -1px 0 0 #e6e6e6, 0 1px 0 #e6e6e6, 0 -1px 0 #e6e6e6, 0 3px 13px rgba(0,0,0,0.08);
        }
        
        .flatpickr-calendar.open,
        .flatpickr-calendar.inline {
            opacity: 1;
            max-height: 640px;
            visibility: visible;
        }
        
        .flatpickr-calendar.open {
            display: inline-block;
            z-index: 99999;
        }
    </style>
    
    <!-- 延遲載入完整CSS -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"></noscript>
    
    <!-- 資源載入器 -->
    <script>
        const SuperLazyLoader = {
            queue: [],
            loaded: new Set(),
            processing: false,
            
            // 載入腳本
            loadScript(src, priority = 1000) {
                return new Promise((resolve, reject) => {
                    if (this.loaded.has(src)) {
                        resolve();
                        return;
                    }
                    this.queue.push({ src, priority, resolve, reject, type: 'script' });
                    this.processQueue();
                });
            },
            
            processQueue() {
                if (this.processing) return;
                this.processing = true;
                
                this.queue.sort((a, b) => a.priority - b.priority);
                
                const processNext = () => {
                    if (this.queue.length === 0) {
                        this.processing = false;
                        return;
                    }
                    
                    const item = this.queue.shift();
                    if (this.loaded.has(item.src)) {
                        item.resolve();
                        setTimeout(processNext, 0);
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = item.src;
                    script.onload = () => {
                        this.loaded.add(item.src);
                        item.resolve();
                        setTimeout(processNext, 10);
                    };
                    script.onerror = item.reject;
                    document.head.appendChild(script);
                };
                
                setTimeout(processNext, 0);
            },
            
            async loadFirebase() {
                try {
                    // 並行載入所有 Firebase 模組（重大性能提升）
                    const firebasePromises = [
                        this.loadScript('https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js', 1),
                        this.loadScript('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js', 1),
                        this.loadScript('https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js', 1)
                    ];
                    
                    await Promise.all(firebasePromises);
                    
                    // 更快的可用性檢查
                    let attempts = 0;
                    while (attempts < 15) {
                        if (typeof firebase !== 'undefined' && 
                            typeof firebase.firestore !== 'undefined' && 
                            typeof firebase.storage !== 'undefined') {
                            console.info('✅ Firebase 並行載入完成 (' + attempts * 25 + 'ms)');
                            return true;
                        }
                        await new Promise(resolve => setTimeout(resolve, 25));
                        attempts++;
                    }
                    
                    throw new Error('Firebase 載入超時');
                } catch (error) {
                    console.error('❌ Firebase 載入失敗:', error);
                    throw error;
                }
            },
            

            
            async loadDatePicker() {
                await this.loadScript('https://cdn.jsdelivr.net/npm/flatpickr', 200);
            },
            
            // 延遲載入非關鍵資源
            loadNonCritical() {
                requestIdleCallback(() => {
                    this.loadScript('https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js', 500);
                }, { timeout: 2000 });
            }
        };
    </script>
    <!-- Flatpickr 中文本地化設置 -->
    <script>
        (function() {
            const zhTWConfig = {
                weekdays: {
                    shorthand: ['日', '一', '二', '三', '四', '五', '六'],
                    longhand: ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六']
                },
                months: {
                    shorthand: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                    longhand: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月']
                },
                daysInMonth: [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31],
                firstDayOfWeek: 1,
                ordinal: function() {
                    return '';
                },
                rangeSeparator: ' 至 ',
                weekAbbreviation: '週',
                scrollTitle: '滾動切換',
                toggleTitle: '點擊切換 12/24 小時時制',
                amPM: ['上午', '下午'],
                yearAriaLabel: '年',
                time_24hr: true
            };

            function initializeFlatpickrLocale() {
                if (typeof flatpickr !== 'undefined') {
                    try {
                        if (!flatpickr.l10ns) {
                            flatpickr.l10ns = {};
                        }
                        flatpickr.l10ns.zh_tw = zhTWConfig;
                        flatpickr.localize(zhTWConfig);
                    } catch (error) {
                        console.error('❌ Flatpickr 本地化設置錯誤:', error);
                    }
                } else {
                    setTimeout(initializeFlatpickrLocale, 50);
                }
            }
        })();
    </script>
    <style>
        /* 企業級樣式系統 v3.0 */

        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --success-color: #10b981;
            --info-color: #3b82f6;
            --text-color: #1f2937;
            --text-muted: #6b7280;
            --text-light: #9ca3af;
            --border-color: #e5e7eb;
            --bg-light: #f9fafb;
            --bg-lighter: #f3f4f6;
            --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-hover: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            --border-radius: 12px;
            --border-radius-small: 8px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--bg-light);
            color: var(--text-color);
            font-display: swap;
            will-change: scroll-position;
        }
        
        /* 載入畫面 */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-light);
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.2s ease-out;
            display: flex;
            flex-direction: column;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        /* 骨架屏動畫 */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* 首屏關鍵樣式 - 僅必需元素 */
        .navbar { background: #fff; border-bottom: 1px solid #e5e7eb; padding: 0.75rem 0; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow); }
        .nav-container { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
        .nav-brand { font-size: 1.25rem; font-weight: 700; color: var(--primary-color); }
        .nav-menu { display: flex; gap: 2rem; list-style: none; }
        .nav-item { cursor: pointer; padding: 0.5rem 1rem; border-radius: var(--border-radius-small); transition: var(--transition); }
        .nav-item:hover, .nav-item.active { background: var(--primary-color); color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
        .main-content { min-height: calc(100vh - 80px); padding: 2rem 0; }
        .content-section { background: #fff; border-radius: var(--border-radius); padding: 1.5rem; margin-bottom: 1rem; box-shadow: var(--shadow); }
        
        /* 延遲載入指示器 */
        .lazy-loading { opacity: 0.6; pointer-events: none; }
        .lazy-loaded { opacity: 1; transition: opacity 0.3s ease; }
        
        /* 數據載入狀態樣式 */
        .data-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            color: transparent;
        }
        
        .data-loaded {
            animation: dataFadeIn 0.5s ease-out;
            color: var(--text-color);
        }
        
        @keyframes dataFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 統計卡片樣式優化 */
        .stat-card {
            background: #fff;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .stat-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        /* 即時更新指示器 */
        .realtime-indicator {
            position: relative;
        }
        
        .realtime-indicator::after {
            content: '';
            position: absolute;
            top: -4px;
            right: -4px;
            width: 8px;
            height: 8px;
            background: var(--success-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-header {
            height: 60px;
            margin: 20px;
            border-radius: 8px;
        }
        
        .skeleton-nav {
            height: 50px;
            margin: 20px;
            border-radius: 8px;
        }
        
        .skeleton-content {
            flex: 1;
            margin: 20px;
            border-radius: 8px;
        }
        
        .loading-text {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--primary-color);
            font-weight: 500;
            font-size: 14px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 600;
            position: relative;
            padding-bottom: 15px;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 2px;
        }

        h2 {
            color: var(--text-color);
            margin-bottom: 20px;
            font-size: 22px;
            font-weight: 600;
        }

        .nav-menu {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            padding: 12px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .nav-item {
            padding: 10px 20px;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-muted);
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
        }

        .nav-item:hover {
            background-color: var(--bg-lighter);
            color: var(--text-color);
            transform: translateY(-1px);
        }

        .nav-item.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-hover);
        }

        .function-section {
            display: none;
        }

        .function-section.active {
            display: block;
        }

        /* 管理頁面佈局 */
        .members-header,
        .orders-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .members-header h2,
        .orders-header h2 {
            margin-bottom: 0;
        }

        .members-controls,
        .filters {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .admin-input,
        #memberSearch,
        #statusFilter {
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            font-size: 14px;
            transition: var(--transition);
        }

        .admin-input:focus,
        #memberSearch:focus,
        #statusFilter:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .admin-input:focus-visible,
        #memberSearch:focus-visible,
        #statusFilter:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        #memberSearch {
            width: 250px;
        }

        #memberSearch::placeholder {
            color: var(--text-light);
        }

        #statusFilter {
            background-color: white;
            cursor: pointer;
            min-width: 120px;
        }

        #statusFilter:hover {
            border-color: var(--primary-color);
        }

        /* 響應式設計 */
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .nav-menu {
                flex-direction: column;
            }

            .nav-item {
                width: 100%;
                text-align: center;
            }
            .members-header,
            .orders-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .members-controls,
            .filters {
                justify-content: center;
            }
            
            #memberSearch {
                width: 100%;
                max-width: 300px;
            }
            
            #statusFilter {
                min-width: 100%;
                max-width: 200px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                grid-template-columns: 1fr;
            }
            .modal-content {
                padding: 15px !important;
            }

            #orderModal .modal-content {
                padding: 20px !important;
            }

            .order-header {
                flex-direction: column;
                text-align: center;
            }

            .order-header > * + * {
                margin-top: 15px;
            }

            .order-info-grid {
                grid-template-columns: 1fr;
            }
            #memberDetailsModal .modal-content {
                padding: 15px !important;
            }
            
            .history-list {
                max-height: 250px;
                padding-right: 6px;
            }
            
            .history-list::-webkit-scrollbar {
                width: 6px;
            }

            .image-gallery {
                margin: 0 -7.5px;
            }
            
            .image-gallery > * + * {
                margin-left: 0;
                margin-bottom: 15px;
            }
            
            .image-gallery > * {
                margin: 0 7.5px 15px;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .button-group > * + * {
                margin-left: 0;
                margin-top: 15px;
            }
            .delete-button-container {
                position: static;
                margin-top: 20px;
                text-align: center;
            }
            
            .delete-member-btn {
                width: 100%;
                justify-content: center;
                gap: 0;
            }
        }
        @media (max-width: 480px) {
            .members-header h2,
            .orders-header h2 {
                font-size: 20px;
                text-align: center;
            }

            .modal-content {
                width: 98vw !important;
                max-height: 95vh !important;
            }

            .settings-title {
                padding: 15px 20px;
                font-size: 18px;
            }

            #procurementContent {
                padding: 20px 15px;
            }

            .rate-calculator-section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .calculator-title {
                font-size: 14px;
            }

            .rate-inputs {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .settings-container {
                padding: 15px;
            }

            .settings-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .button-group {
                grid-template-columns: 1fr;
                gap: 8px;
                margin-top: 20px;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0,0,0,0.4), rgba(0,0,0,0.6));
            backdrop-filter: blur(6px);
            align-items: center;
            justify-content: center;
            user-select: none;
        }
        
        .modal.show {
            display: flex !important;
        }

        @supports not (backdrop-filter: blur()) {
            .modal {
                background-color: rgba(0,0,0,0.7);
            }
        }

        .modal-content {
            margin: 0 !important;
            padding: 0;
            border-radius: var(--border-radius);
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.5);
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
        }

        #settingsModal .modal-content.settings-modal {
            width: 85vw !important;
            max-width: 520px !important;
            max-height: 85vh !important;
        }

        #orderModal .modal-content {
            width: 90vw !important;
            max-width: 800px !important;
            max-height: 85vh !important;
        }

        #editMemberModal .modal-content {
            width: 90vw !important;
            max-width: 580px !important;
            max-height: 85vh !important;
        }

        #memberDetailsModal .modal-content {
            width: 90vw !important;
            max-width: 450px !important;
            max-height: 80vh !important;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95vw !important;
                max-width: none !important;
                max-height: 90vh !important;
            }
            
            #memberDetailsModal .modal-content {
                max-height: 85vh !important;
            }
            
            .confirm-modal .modal-content {
                width: 90vw !important;
                max-width: 320px !important;
            }
            
            .modal-content::-webkit-scrollbar {
                width: 4px;
            }
            .member-form {
                padding: 16px !important;
            }

            .delete-button-container {
                margin-top: 20px !important;
                padding: 14px !important;
            }

            .delete-button-container::before {
                font-size: 11px !important;
                margin-bottom: 10px !important;
            }

            .delete-member-btn {
                padding: 10px 16px !important;
                font-size: 13px !important;
                min-width: 120px !important;
                gap: 0 !important;
            }

            /* 移動設備關閉按鈕優化 */
            .modal .close,
            .modal .close-btn {
                width: 32px !important;
                height: 32px !important;
                font-size: 18px !important;
                right: 12px !important;
                top: 12px !important;
                border-width: 1.5px !important;
            }
            
            .modal .close:hover,
            .modal .close-btn:hover {
                transform: scale(1.1) rotate(90deg) !important;
            }


        }

        /* 統一關閉按鈕樣式 */
        .modal .close,
        .modal .close-btn {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 20px;
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0.25));
            z-index: 1001;
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-weight: 400;
            line-height: 1;
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .modal .close:hover,
        .modal .close-btn:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.95));
            color: white;
            transform: scale(1.15) rotate(90deg);
            backdrop-filter: blur(16px);
            box-shadow: 
                0 8px 25px rgba(239, 68, 68, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .modal .close:active,
        .modal .close-btn:active {
            transform: scale(1.05) rotate(90deg);
            box-shadow: 
                0 4px 15px rgba(239, 68, 68, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        /* 時間選擇模態框 */
        #timeSelectionModal .modal-content.time-selection-content {
            width: 90vw !important;
            max-width: 480px !important;
            max-height: 85vh !important;
            overflow: visible;
        }

        /* 模態框頭部 */
        .time-selection-modal .modal-header {
            background: linear-gradient(135deg, #a855f7 0%, #8b5cf6 100%);
            color: white;
            padding: 20px 24px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            position: relative;
            text-align: center;
        }

        .time-selection-modal .modal-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* 模態框主體 */
        .time-selection-modal .modal-body {
            padding: 24px;
            background: #ffffff;
        }

        .time-selection-wrapper {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .date-time-group {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        .input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }

        .input-label i.icon-calendar,
        .input-label i.icon-clock {
            font-size: 16px;
            filter: grayscale(0.2);
        }

        .date-time-input {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: var(--border-radius-small);
            font-size: 14px;
            background: #ffffff;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .date-time-input:focus,
        .date-time-input:hover {
            border-color: #a855f7;
            outline: none;
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }

        .date-time-input::placeholder {
            color: #9ca3af;
        }

        /* 選擇顯示區域 */
        .selected-datetime-display {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px dashed #cbd5e1;
            border-radius: var(--border-radius-small);
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .selected-datetime-display.has-value {
            background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
            border-color: #10b981;
            border-style: solid;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
        }

        .display-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            display: block;
            margin-bottom: 4px;
        }

        .display-value {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .selected-datetime-display.has-value .display-value {
            color: #059669;
        }

        /* 模態框底部 */
        .time-selection-modal .modal-footer {
            background: #f9fafb;
            padding: 16px 24px;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-confirm {
            background: linear-gradient(135deg, #a855f7 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius-small);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 120px;
            justify-content: center;
        }

        .btn-confirm:hover {
            background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
        }

        .btn-confirm:active {
            transform: translateY(0);
        }

        .btn-confirm:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-cancel {
            background: #ffffff;
            color: #6b7280;
            border: 1px solid #d1d5db;
            padding: 10px 20px;
            border-radius: var(--border-radius-small);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
        }

        .btn-cancel:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
            color: #374151;
        }

        .btn-cancel:active {
            background: #e5e7eb;
        }

        /* 移動設備優化 */
        @media (max-width: 768px) {
            #timeSelectionModal .modal-content.time-selection-content {
                width: 95vw !important;
                max-width: none !important;
                margin: 0 auto;
            }

            .time-selection-modal .modal-header {
                padding: 16px 20px;
            }

            .time-selection-modal .modal-title {
                font-size: 16px;
            }

            .time-selection-modal .modal-body {
                padding: 20px;
            }

            .date-time-group {
                flex-direction: column;
                gap: 12px;
            }

            .time-selection-modal .modal-footer {
                padding: 14px 20px;
                flex-direction: column-reverse;
            }

            .btn-confirm,
            .btn-cancel {
                width: 100%;
                justify-content: center;
            }

            #timeSelectionModal .close-btn {
                width: 28px !important;
                height: 28px !important;
                font-size: 18px !important;
                right: 12px !important;
                top: 12px !important;
            }
        }

        button, .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
            background-color: var(--primary-color);
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        button > * + *, .btn > * + * {
            margin-left: 8px;
        }

        button:hover:not(:disabled), .btn:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-lg {
            padding: 16px 32px;
            font-size: 16px;
        }

        .btn-xs {
            padding: 4px 8px;
            font-size: 12px;
            min-width: 28px;
            height: 28px;
            margin: 0 2px;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #0da271;
        }

        .btn-danger {
            background-color: var(--error-color);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            background-color: #2563eb;
        }

        .member-action-btn {
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: var(--transition);
        }

        .member-action-btn:hover {
            transform: scale(1.1);
        }

        .order-action-btn {
            border-radius: var(--border-radius-small);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            transition: var(--transition);
        }

        .order-action-btn:hover {
            transform: translateY(-1px);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        th:last-child, td:last-child {
            width: 100px;
            text-align: center;
        }

        th {
            background-color: var(--bg-lighter);
            font-weight: 600;
            color: var(--text-color);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        tr:hover {
            background-color: var(--bg-lighter);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-small);
            font-size: 14px;
            transition: var(--transition);
            background-color: white;
            color: var(--text-color);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        input::placeholder, textarea::placeholder {
            color: var(--text-light);
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8.825L1.175 4 2.05 3.125 6 7.075 9.95 3.125 10.825 4z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 30px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }



        .dashboard-section {
            padding: 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .stats-grid {
            display: -ms-grid;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            grid-gap: 20px;
            gap: 20px;
            margin: 20px 0;
        }

        @supports not (display: grid) {
            .stats-grid {
                display: flex;
                flex-wrap: wrap;
                margin: 20px -10px 0;
            }
            
            .stat-card {
                flex: 1 1 200px;
                margin: 0 10px 20px;
            }
        }

        .stat-card {
            background: var(--bg-lighter);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            color: var(--text-muted);
            font-size: 16px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 14px;
        }

        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            grid-gap: 20px;
            gap: 20px;
            margin-top: 30px;
        }

        @supports not (display: grid) {
            .chart-container {
                display: flex;
                flex-wrap: wrap;
                margin: 30px -10px 0;
            }
            
            .chart-section {
                flex: 1 1 400px;
                margin: 0 10px 20px;
            }
        }

        .chart-section {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            height: 400px;
            position: relative;
        }

        .chart-section h3 {
            margin: 0 0 20px 0;
            color: var(--text-color);
            font-size: 18px;
            text-align: center;
            position: relative;
            padding-bottom: 10px;
        }

        .chart-section h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 2px;
            background-color: var(--primary-color);
            border-radius: 2px;
        }

        .chart-canvas-container {
            position: relative;
            width: 100%;
            height: calc(100% - 50px);
        }

        .member-status {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            text-align: center;
            min-width: 60px;
            height: 22px;
            transition: var(--transition);
        }

        .status-pending {
            background: var(--warning-color);
            color: white;
        }

        .status-active {
            background: var(--success-color);
            color: white;
        }

        .status-suspended {
            background: var(--error-color);
            color: white;
        }


        /* 響應式設計已合併到統一區塊，此處移除重複定義 */

        /* 訂單詳情模態框 */

        #orderModal h2 {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            text-align: center;
            margin: 0;
            padding: 18px 24px;
            font-size: 20px;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.2);
        }

        #orderModal h2::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }

        /* 訂單模態框內容區域 */
        .order-modal-content {
            padding: 20px;
            min-height: fit-content;
            position: relative;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            background: var(--bg-lighter);
            border-radius: var(--border-radius);
        }

        .order-status {
            display: flex;
            align-items: center;
        }

        .order-status > * + * {
            margin-left: 10px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            background-color: var(--primary-color);
            color: white;
        }

        .order-number {
            font-size: 16px;
            color: var(--text-muted);
        }

        .order-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            grid-gap: 20px;
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Fallback for older browsers */
        @supports not (display: grid) {
            .order-info-grid {
                display: flex;
                flex-wrap: wrap;
                margin: 0 -10px 30px;
            }
            
            .info-card {
                flex: 1 1 200px;
                margin: 0 10px 20px;
            }
        }

        .info-card {
            background: var(--bg-lighter);
            padding: 20px;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .info-label {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .info-value {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-color);
            line-height: 1.4;
        }

        .info-value.highlight {
            color: var(--primary-color);
            font-size: 24px;
            font-weight: 600;
        }

        /* 訂單操作區域樣式 */
        .order-actions-section {
            margin: 25px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: var(--border-radius);
            border: 2px dashed var(--border-color);
            text-align: center;
        }

        .order-actions-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60px; /* 確保按鈕切換時容器高度穩定 */
        }

        .order-actions-buttons > * + * {
            margin-left: 15px;
        }

        #acceptOrderBtn {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border: 1px solid rgba(37, 99, 235, 0.3);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.25), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            font-weight: 600;
        }

        #acceptOrderBtn:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
        }

        #completeOrderBtn {
            background: linear-gradient(135deg, #10b981, #059669);
            border: 1px solid rgba(16, 185, 129, 0.3);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            font-weight: 600;
        }

        #completeOrderBtn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.35);
        }

        .order-info-section {
            margin: 25px 0;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .order-info-section h3 {
            margin: 0 0 15px 0;
            color: #2d3748;
            font-size: 16px;
            font-weight: 600;
        }

        .info-grid {
            display: grid;
            gap: 12px;
        }

        .info-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .info-item .info-label {
            min-width: 80px;
            font-weight: 500;
            color: #4a5568;
            margin-right: 12px;
            font-size: 14px;
        }

        .info-item .info-value {
            flex: 1;
            color: #2d3748;
            font-size: 14px;
            word-break: break-all;
        }

        .link-display {
            color: #4f46e5;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .link-display:hover {
            color: #4338ca;
            border-bottom-color: #4338ca;
        }

        .order-images-section {
            margin: 25px 0;
        }

        .order-images-section h3 {
            font-size: 18px;
            color: var(--text-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .image-gallery {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 15px;
            background: var(--bg-lighter);
            border-radius: var(--border-radius);
        }

        .image-gallery > * + * {
            margin-left: 15px;
        }

        /* 圖片畫廊響應式設計已合併到統一區塊 */

        .image-gallery img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .image-gallery img:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-hover);
        }

        /* 響應式設計已合併到統一區塊 */

        /* 會員詳情模態框 */
        #memberDetailsModal .modal-content {
            max-width: 520px;
            width: 90%;
            max-height: 80vh;
            margin: 3% auto;
            padding: 0;
            border-radius: var(--border-radius);
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.5);
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            scrollbar-width: thin;
            scrollbar-color: rgba(139, 69, 19, 0.3) transparent;
            display: flex;
            flex-direction: column;
        }

        #memberDetailsModal h2 {
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
            color: white;
            text-align: center;
            margin: 0;
            padding: 16px 20px;
            font-size: 18px;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(139, 69, 19, 0.2);
            flex-shrink: 0;
        }

        #memberDetailsModal h2::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }

        /* 會員詳情模態框滾動條樣式 */
        #memberDetailsModal .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        #memberDetailsModal .modal-content::-webkit-scrollbar-track {
            background: rgba(148, 163, 184, 0.1);
            border-radius: 4px;
            margin: 8px 0;
        }

        #memberDetailsModal .modal-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.4), rgba(139, 69, 19, 0.6));
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
        }

        #memberDetailsModal .modal-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.6), rgba(139, 69, 19, 0.8));
            transform: scaleX(1.1);
        }

        #memberDetailsModal .modal-content::-webkit-scrollbar-thumb:active {
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.8), rgba(139, 69, 19, 0.9));
        }

        /* 會員詳情內容區域 */
        .member-details-content {
            padding: 18px;
            flex: 1;
            min-height: 0;
        }

        /* 編輯會員模態框標題樣式 */
        #editMemberModal h2 {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            text-align: center;
            margin: 0;
            padding: 16px 20px;
            font-size: 18px;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.2);
        }

        #editMemberModal h2::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }

        /* 編輯會員內容區域 */
        .edit-member-content {
            padding: 20px;
            min-height: fit-content;
            position: relative;
        }

        /* 編輯會員表單樣式 */
        .member-form {
            background: white;
            border-radius: var(--border-radius-small);
            padding: 18px;
            border: 1px solid rgba(148, 163, 184, 0.15);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .member-form .form-group {
            margin-bottom: 18px;
        }

        .member-form .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .member-form input,
        .member-form select,
        .member-form textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: var(--border-radius-small);
            font-size: 14px;
            font-weight: 500;
            background: white;
            transition: var(--transition);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .member-form input:focus,
        .member-form select:focus,
        .member-form textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), 0 1px 3px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        /* 會員表單按鈕組 */
        .member-form .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
            padding-top: 18px;
            border-top: 1px solid rgba(148, 163, 184, 0.2);
        }

        .member-form .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: var(--border-radius-small);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .member-form .btn-primary:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.4);
        }

        .member-form button[type="button"] {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: var(--border-radius-small);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 4px rgba(100, 116, 139, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .member-form button[type="button"]:hover {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(100, 116, 139, 0.4);
        }

        .member-header {
            margin-bottom: 15px;
            padding: 10px 15px;
            background: rgba(37, 99, 235, 0.05);
            border-radius: var(--border-radius-small);
            border-left: 3px solid var(--primary-color);
        }

        .member-phone {
            font-size: 14px;
            color: var(--text-color);
            font-weight: 500;
        }

        /* 會員詳情響應式設計已合併到統一區塊 */

        /* 圖片預覽樣式 */
        .image-preview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .image-preview img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        /* 圖片預覽專用關閉按鈕樣式 */
        .image-preview .close {
            position: absolute;
            right: 30px;
            top: 30px;
            font-size: 30px;
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.6));
            z-index: 2001;
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-weight: 300;
            line-height: 1;
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            user-select: none;
        }

        .image-preview .close:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.95));
            color: white;
            transform: scale(1.2) rotate(90deg);
            backdrop-filter: blur(16px);
            box-shadow: 
                0 10px 30px rgba(239, 68, 68, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .image-preview .close:active {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 
                0 6px 20px rgba(239, 68, 68, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        /* 移動設備適配 */
        @media (max-width: 768px) {
            .image-preview .close {
                right: 20px;
                top: 20px;
                width: 44px;
                height: 44px;
                font-size: 26px;
            }
            
            .image-preview img {
                max-width: 95%;
                max-height: 95%;
            }
        }

        /* 增強的圖片容器樣式 */
        .enhanced-image-container {
            position: relative;
            background: white;
            border-radius: var(--border-radius-small);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            width: 200px;
            height: 150px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .enhanced-image-container:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .enhanced-image-container img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            min-width: 50px;
            min-height: 50px;
            object-fit: contain;
            object-position: center;
            transition: var(--transition);
            border-radius: 4px;
        }

        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.7) 100%);
            opacity: 0;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding: 8px;
            pointer-events: none;
        }

        .enhanced-image-container:hover .image-overlay {
            opacity: 1;
        }

        /* 錯誤狀態樣式 */
        .enhanced-image-container.error-state {
            background: var(--bg-lighter);
            border: 2px dashed var(--border-color);
            opacity: 0.6;
        }

        .enhanced-image-container.error-state:hover {
            transform: none;
            box-shadow: var(--shadow);
        }



        .image-info {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            text-align: center;
            max-width: 90%;
            word-break: break-word;
        }



        /* 載入指示器樣式 */
        .loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 14px;
            background: var(--bg-lighter);
            border-radius: var(--border-radius-small);
            margin: 10px 0;
        }

        .loading-indicator::before {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        .image-metadata {
            position: absolute;
            top: 4px;
            left: 4px;
            background: rgba(37, 99, 235, 0.9);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
        }

        .image-size-info {
            position: absolute;
            bottom: 4px;
            left: 4px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
        }

        /* 移除數字輸入框的上下箭頭 */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
            appearance: textfield;
        }

        /* 密碼輸入框樣式優化 */
        input[type="password"] {
            font-family: monospace; /* 確保字符間距一致 */
            letter-spacing: 2px; /* 增加字符間距提升可讀性 */
        }

        /* 確保 login-input 的 password 類型優先級 */
        .login-input[type="password"] {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, monospace;
            letter-spacing: 1px;
            text-align: center;
        }

        /* 添加日期時間選擇器的樣式 */
        .datetime-picker {
            color: var(--text-color);
            font-size: 18px;
            font-weight: 500;
            white-space: pre-line;
            text-align: center;
            line-height: 1.3;
        }

        .datetime-picker:hover {
            color: var(--primary-color);
        }

        .datetime-display {
            color: var(--text-color);
            font-size: 18px;
            font-weight: 500;
            line-height: 1.4;
            cursor: pointer;
            transition: var(--transition);
        }

        .datetime-display:hover {
            color: var(--primary-color);
        }

        .date-picker, .time-picker {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-small);
            font-size: 14px;
            transition: var(--transition);
            background-color: white;
            color: var(--text-color);
            cursor: pointer;
        }

        .date-picker:focus, .time-picker:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .flatpickr-active {
            color: var(--primary-color);
        }

        /* 隱藏 flatpickr 的默認樣式 */
        .flatpickr-calendar {
            box-shadow: var(--shadow-hover);
            border-radius: var(--border-radius);
        }

        .flatpickr-day.selected {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .flatpickr-day:hover {
            background: var(--bg-lighter);
        }

        .flatpickr-time input:hover,
        .flatpickr-time .flatpickr-am-pm:hover,
        .flatpickr-time input:focus,
        .flatpickr-time .flatpickr-am-pm:focus {
            background: var(--bg-lighter);
        }

        #expectedTimeCard {
            transition: all 0.2s ease;
        }

        #expectedTimeCard:hover {
            background-color: var(--bg-lighter);
            transform: translateY(-2px);
        }

        /* 內嵌編輯模態框樣式 */
        .level-options, .status-options {
            display: -ms-grid;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-gap: 10px;
            gap: 10px;
            margin-top: 10px;
        }

        /* Fallback for older browsers */
        @supports not (display: grid) {
            .level-options, .status-options {
                display: -webkit-box;
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
                -webkit-flex-wrap: wrap;
                -ms-flex-wrap: wrap;
                flex-wrap: wrap;
                margin: 10px -5px 0;
            }
            
            .level-option, .status-option {
                -webkit-box-flex: 1;
                -webkit-flex: 1 1 calc(50% - 10px);
                -ms-flex: 1 1 calc(50% - 10px);
                flex: 1 1 calc(50% - 10px);
                margin: 0 5px 10px;
            }
        }

        .level-option, .status-option {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-small);
            cursor: pointer;
            transition: var(--transition);
        }

        .level-option:hover, .status-option:hover {
            border-color: var(--primary-color);
            background-color: var(--bg-lighter);
        }

        .level-option.selected, .status-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(37, 99, 235, 0.1);
        }

        .level-name, .status-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .level-desc, .status-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        .quick-dates {
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            margin-top: 10px;
        }

        .quick-dates > * + * {
            margin-left: 10px;
        }

        .quick-dates button {
            flex: 1;
            padding: 8px;
            font-size: 13px;
            background-color: var(--bg-lighter);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            cursor: pointer;
            transition: var(--transition);
        }

        .quick-dates button:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-secondary {
            background-color: var(--bg-lighter);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: var(--border-color);
        }

        /* 確認模態框樣式 */
        .confirm-modal {
            background-color: rgba(0,0,0,0.6);
            -webkit-backdrop-filter: blur(8px); /* Safari支援 */
            backdrop-filter: blur(8px);
        }

        /* 確認模態框 backdrop-filter 降級支援 */
        @supports not (backdrop-filter: blur()) {
            .confirm-modal {
                background-color: rgba(0,0,0,0.8); /* 更深的背景色 */
            }
        }

        /* 確認模態框 */
        .confirm-modal .modal-content {
            width: 90vw !important;
            max-width: 360px !important;
            padding: 20px !important;
            text-align: center;
            border: 1px solid rgba(37, 99, 235, 0.1);
        }

        .confirm-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background: linear-gradient(135deg, #fef3c7, #f59e0b);
            color: #d97706;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
            transition: var(--transition);
        }

        .confirm-icon.danger {
            background: linear-gradient(135deg, #fecaca, #ef4444);
            color: #dc2626;
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }



        .confirm-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 10px;
            text-align: center;
        }

        .confirm-message {
            font-size: 16px;
            color: var(--text-color);
            line-height: 1.4;
            margin-bottom: 20px;
            white-space: pre-line; /* 支援換行符顯示 */
            text-align: center;
            font-weight: 500;
        }

        /* 內聯樣式清理 - 統一CSS類 */
        .logout-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: 1px solid rgba(239, 68, 68, 0.3);
            margin-left: 10px;
        }

        .error-message {
            color: red;
            text-align: center;
            padding: 20px;
        }

        .image-load-error {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
        }

        .image-load-error-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .image-load-error-text {
            font-size: 12px;
        }

        .exchange-rate-display {
            color: var(--primary-color);
            font-weight: 600;
        }

        .exchange-rate-separator {
            color: var(--text-muted);
            margin: 0 8px;
        }

        .exchange-rate-amount {
            color: var(--text-color);
            font-weight: 500;
        }

        .modal-image-error {
            color: #ef4444;
            font-style: italic;
        }

        .modal-no-images {
            color: #666;
            font-style: italic;
        }

        .table-loading, .table-error, .table-empty {
            text-align: center;
            padding: 20px;
        }

        .table-error {
            color: red;
        }

        .table-empty {
            color: #666;
        }

        .member-status-clickable {
            cursor: pointer;
            text-decoration: underline;
        }

        .member-last-updated {
            font-size: 12px;
        }

        .member-details-empty {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .order-info-highlight {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: 2px solid var(--primary-color);
            position: relative;
        }

        .order-info-member {
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
            padding: 10px 0;
        }

        .order-info-member-level {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-color);
        }

        .order-info-member-phone {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 8px;
        }

        .order-time-card {
            cursor: pointer;
        }

        .order-section-hidden {
            display: none;
        }

        .order-item-hidden {
            display: none;
        }

        .order-actions-section {
            margin-top: 30px;
        }

        .order-btn-width {
            width: 180px;
        }

        .order-btn-hidden {
            display: none;
        }

        .order-btn-icon {
            margin-right: 8px;
        }

        .preview-image-hidden {
            display: none;
        }

        .edit-member-phone-display {
            font-size: 12px;
            color: #666;
            font-weight: normal;
            margin-left: 8px;
        }

        .form-group-hidden {
            display: none;
        }

        .confirm-buttons {
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            -ms-flex-pack: center;
            justify-content: center;
        }

        .confirm-buttons > * + * {
            margin-left: 10px;
        }

        .confirm-btn {
            min-width: 80px;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .confirm-btn-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
        }

        .confirm-btn-primary:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.35);
        }

        .confirm-btn-secondary {
            background: #f3f4f6;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .confirm-btn-secondary:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        .confirm-btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25);
        }

        .confirm-btn-danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.35);
        }

        .confirm-buttons {
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            -ms-flex-pack: center;
            justify-content: center;
        }

        .confirm-buttons > * + * {
            margin-left: 10px;
        }

        .confirm-btn {
            min-width: 80px;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .confirm-btn-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
        }

        .confirm-btn-primary:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.35);
        }

        .confirm-btn-secondary {
            background: #f3f4f6;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .confirm-btn-secondary:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        .confirm-btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25);
        }

        .confirm-btn-danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.35);
        }



        /* 設定按鈕樣式 - 靠右對齊 */
        .settings-button {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .btn-compact {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
        }

        .settings-btn {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            border: 1px solid rgba(99, 102, 241, 0.3);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            background: linear-gradient(135deg, #4f46e5, #4338ca);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);
        }

        .settings-btn .btn-icon {
            margin-right: 6px;
            font-size: 16px;
        }

        /* 編輯會員模態框特殊屬性 */
        #editMemberModal .modal-content {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            scrollbar-width: thin;
            scrollbar-color: rgba(99, 102, 241, 0.3) transparent;
        }

        /* 編輯會員模態框滾動條樣式 */
        #editMemberModal .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        #editMemberModal .modal-content::-webkit-scrollbar-track {
            background: rgba(148, 163, 184, 0.1);
            border-radius: 4px;
            margin: 8px 0;
        }

        #editMemberModal .modal-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.4), rgba(99, 102, 241, 0.6));
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
        }

        #editMemberModal .modal-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.6), rgba(99, 102, 241, 0.8));
            transform: scaleX(1.1);
        }

        #editMemberModal .modal-content::-webkit-scrollbar-thumb:active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.8), rgba(99, 102, 241, 0.9));
        }

        /* 模態框滾輪系統 - 統一樣式管理 */
        /* 訂單模態框滾動條樣式 */
        #orderModal .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        #orderModal .modal-content::-webkit-scrollbar-track {
            background: rgba(148, 163, 184, 0.1);
            border-radius: 4px;
            margin: 8px 0;
        }

        #orderModal .modal-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.4), rgba(16, 185, 129, 0.6));
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
        }

        #orderModal .modal-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.6), rgba(16, 185, 129, 0.8));
            transform: scaleX(1.1);
        }

        #orderModal .modal-content::-webkit-scrollbar-thumb:active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.8), rgba(16, 185, 129, 0.9));
        }

        /* 設定模態框特殊屬性 */
        .settings-modal {
            scrollbar-width: thin;
            scrollbar-color: rgba(59, 130, 246, 0.3) transparent;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .settings-modal::-webkit-scrollbar {
            width: 8px; /* 增加滾動條寬度，更容易點擊 */
        }

        .settings-modal::-webkit-scrollbar-track {
            background: rgba(148, 163, 184, 0.1);
            border-radius: 4px;
            margin: 8px 0; /* 上下留白 */
        }

        .settings-modal::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.4), rgba(59, 130, 246, 0.6));
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
        }

        .settings-modal::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.6), rgba(59, 130, 246, 0.8));
            transform: scaleX(1.1); /* 滑鼠懸停時稍微放大 */
        }

        .settings-modal::-webkit-scrollbar-thumb:active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(59, 130, 246, 0.9));
        }

        .settings-title {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            text-align: center;
            margin: 0;
            padding: 16px 20px;
            font-size: 18px;
            font-weight: 700;
            position: sticky; /* 讓標題在滾動時保持可見 */
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.2);
        }

        .settings-title::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }

        #procurementContent {
            padding: 16px;
            /* 確保內容可以完全滾動 */
            min-height: fit-content;
            position: relative;
        }

        /* 緊湊型設定網格 */
        .settings-container {
            background: white;
            border-radius: var(--border-radius-small);
            padding: 16px;
            border: 1px solid rgba(148, 163, 184, 0.15);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .settings-grid .form-group {
            position: relative;
        }

        .settings-grid .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .settings-grid .form-group input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: var(--border-radius-small);
            font-size: 14px;
            font-weight: 500;
            background: white;
            transition: var(--transition);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .settings-grid .form-group input[type="number"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), 0 1px 3px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .test-section {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
            padding: 15px;
            border-radius: var(--border-radius-small);
            border: 1px solid rgba(245, 158, 11, 0.2);
            margin-top: 5px;
        }

        .test-section label {
            color: #92400e !important;
        }

        .test-result {
            margin-top: 8px;
            padding: 10px 15px;
            background: linear-gradient(135deg, #ffffff 0%, #fefce8 100%);
            border-radius: var(--border-radius-small);
            font-weight: 700;
            font-size: 15px;
            color: #059669;
            text-align: center;
            border: 1px solid rgba(245, 158, 11, 0.3);
            min-height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(148, 163, 184, 0.2);
        }

        .save-btn {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: var(--border-radius-small);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 4px rgba(5, 150, 105, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .save-btn:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(5, 150, 105, 0.4);
        }

        .cancel-btn {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: var(--border-radius-small);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 4px rgba(100, 116, 139, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .cancel-btn:hover {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(100, 116, 139, 0.4);
        }

        .clickable-title {
            cursor: pointer;
            color: #3b82f6 !important;
            transition: all 0.3s ease;
        }

        .clickable-title:hover {
            color: #2563eb !important;
            transform: translateY(-1px);
        }



        /* 精美緊湊型匯率計算器 */
        .rate-calculator-section {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: var(--border-radius-small);
            padding: 14px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .rate-calculator-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #06b6d4, #3b82f6);
            border-radius: 12px 12px 0 0;
        }

        .calculator-title {
            text-align: center;
            color: #1e293b;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding-top: 2px;
        }

        .calculator-title i {
            color: #3b82f6;
            font-size: 16px;
        }



        .rate-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .rate-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .rate-inputs input {
            padding: 10px 12px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: var(--border-radius-small);
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            background: white;
            transition: var(--transition);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .rate-inputs input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), 0 1px 3px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .rate-inputs input::placeholder {
            color: #94a3b8;
            font-weight: 400;
        }

        .mid-rate-display {
            text-align: center;
            font-size: 16px;
            color: #475569;
            font-weight: 600;
            min-height: 18px;
            padding: 4px 0;
        }







        /* 編輯會員模態框刪除按鈕區域樣式 */
        .delete-button-container {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 2px dashed rgba(239, 68, 68, 0.2);
            text-align: center;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-radius: var(--border-radius-small);
            padding: 16px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center; /* 確保內容置中 */
            justify-content: center;
        }

        .delete-button-container::before {
            content: '⚠️ 危險操作區域';
            display: block;
            font-size: 12px;
            color: #dc2626;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            opacity: 0.8;
            text-align: center;
            width: 100%;
        }

        .delete-member-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: white;
            padding: 12px 20px;
            border-radius: var(--border-radius-small);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
                            gap: 0;
            box-shadow: 
                0 2px 4px rgba(239, 68, 68, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            min-width: 140px;
            margin: 0 auto; /* 確保按鈕置中 */
            position: relative;
            overflow: hidden;
        }

        .delete-member-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 
                0 4px 8px rgba(239, 68, 68, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.2) inset;
        }

        .delete-member-btn:active {
            transform: translateY(-1px);
            box-shadow: 
                0 2px 4px rgba(239, 68, 68, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
        }

        /* 刪除按鈕脈搏動畫效果 */
        .delete-member-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            border-radius: var(--border-radius-small);
            background: rgba(239, 68, 68, 0.2);
            transform: translate(-50%, -50%) scale(0);
            animation: deleteButtonPulse 2s infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes deleteButtonPulse {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            70% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0;
            }
        }







        /* 設定頁面響應式設計已合併到統一區塊 */

        /* 禁用狀態的表單元素樣式 */
        input:disabled, select:disabled {
            background-color: #f5f5f5 !important;
            color: #999 !important;
            cursor: not-allowed !important;
            border-color: #ddd !important;
        }

        select:disabled {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 8.825L1.175 4 2.05 3.125 6 7.075 9.95 3.125 10.825 4z'/%3E%3C/svg%3E") !important;
        }

        /* 禁用狀態提示 */
        .form-group.disabled-hint {
            position: relative;
        }

        .form-group.disabled-hint::after {
            content: '🔒';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 12px;
            opacity: 0.6;
        }

        /* 登錄頁面樣式 */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
            animation: loginSlideIn 0.5s ease-out;
        }

        @keyframes loginSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-form {
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            -ms-flex-direction: column;
            flex-direction: column;
        }

        .login-form > * + * {
            margin-top: 20px;
        }

        .login-input {
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-small);
            font-size: 16px;
            transition: var(--transition);
            text-align: center;
            font-weight: 500;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .login-error {
            color: var(--error-color);
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        .lockout-message {
            color: var(--warning-color);
            font-size: 14px;
            margin-top: 10px;
            display: none;
            font-weight: 600;
        }

        .main-content {
            display: none;
        }

        .main-content.authenticated {
            display: block;
        }

        .login-container.hidden {
            display: none !important;
        }

        /* 歷史記錄樣式 */
        .member-history-section {
            margin-top: 0;
            padding: 0;
            background: transparent;
            border: none;
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .history-list {
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            -ms-flex-direction: column;
            flex-direction: column;
            overflow-y: auto;
            max-height: 300px;
            padding-right: 8px;
        }

        .history-list > * + * {
            margin-top: 8px;
        }



        .history-item {
            background: white;
            padding: 12px;
            border-radius: var(--border-radius-small);
            border-left: 3px solid var(--error-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            transition: var(--transition);
        }

        .history-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .history-action {
            font-weight: 600;
            color: var(--error-color);
            font-size: 13px;
        }

        .history-timestamp {
            font-size: 11px;
            color: var(--text-muted);
        }

        .history-remark {
            color: var(--text-color);
            line-height: 1.4;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .history-details {
            font-size: 11px;
            color: var(--text-light);
            font-style: italic;
        }
    </style>
</head>
<body>
    <script>
        // 初始化 Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCe8a7YjQo9jwoqYLImEPb5L0_bUhDLBY4",
            authDomain: "cny-90e4e.firebaseapp.com",
            projectId: "cny-90e4e",
            storageBucket: "cny-90e4e.firebasestorage.app",
            messagingSenderId: "114464076437",
            appId: "1:114464076437:web:0e03e27460dbad44a0e19c",
            measurementId: "G-Q2Y3LJYTHT"
        };

        let db, storage;
        
        // Firebase 初始化函數（等待載入完成後調用）
        function initializeFirebase() {
            try {
                // 詳細檢查Firebase可用性
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase 全域物件未定義');
                }
                
                if (typeof firebase.initializeApp !== 'function') {
                    throw new Error('Firebase.initializeApp 方法不可用');
                }
                
                if (typeof firebase.firestore !== 'function') {
                    throw new Error('Firebase.firestore 方法不可用');
                }
                
                if (typeof firebase.storage !== 'function') {
                    throw new Error('Firebase.storage 方法不可用');
                }
                
                // 檢查是否已經初始化
                if (firebase.apps && firebase.apps.length > 0) {
                    console.info('🔄 Firebase 已初始化，使用現有實例');
                    db = firebase.firestore();
                    storage = firebase.storage();
                } else {
                    console.info('開始初始化 Firebase...');
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    storage = firebase.storage();
                }
                
                // 驗證初始化結果
                if (!db || typeof db.collection !== 'function') {
                    throw new Error('Firestore 初始化失敗');
                }
                
                if (!storage || typeof storage.ref !== 'function') {
                    throw new Error('Storage 初始化失敗');
                }
                
                console.info('✅ Firebase 初始化成功');
                return true;
            } catch (error) {
                console.error('❌ Firebase 初始化失敗:', error);
                console.error('🔍 錯誤詳情:', {
                    name: error.name,
                    message: error.message,
                    code: error.code,
                    firebaseAvailable: typeof firebase !== 'undefined',
                    firebaseApps: typeof firebase !== 'undefined' ? firebase.apps?.length : 'N/A'
                });
                
                // 清除可能的部分初始化狀態
                db = null;
                storage = null;
                
                console.warn('⚠️ Firebase 功能不可用，將使用本地 sessionStorage 作為備用方案');
                return false;
            }
        }

        // ✅ Firestore 安全規則已成功部署並配置完成

        // 代碼清理和性能監控
        const CodeMaintenanceUtils = {
            // 檢查未使用的事件監聽器
            findUnusedListeners() {
                const allElements = document.querySelectorAll('[onclick], [onchange], [oninput]');
                const unusedListeners = [];
                
                allElements.forEach(el => {
                    const events = ['onclick', 'onchange', 'oninput'];
                    events.forEach(event => {
                        if (el[event] && typeof el[event] === 'function') {
                            try {
                                // 嘗試檢查函數是否實際存在
                                const funcName = el.getAttribute(event.substring(2));
                                if (funcName && typeof window[funcName] !== 'function') {
                                    unusedListeners.push({element: el, event, function: funcName});
                                }
                            } catch (e) {
                                // 忽略檢查錯誤
                            }
                        }
                    });
                });
                
                return unusedListeners;
            },
            
            // 檢查內存洩漏風險
            checkMemoryLeaks() {
                const warnings = [];
                
                // 檢查未清理的定時器
                if (typeof lockoutTimer !== 'undefined' && lockoutTimer !== null) {
                    warnings.push('未清理的鎖定定時器');
                }
                
                // 檢查DOM緩存大小
                if (typeof DOMCache !== 'undefined' && DOMCache.size > 100) {
                    warnings.push('DOM緩存可能過大: ' + DOMCache.size + ' 項目');
                }
                
                // 檢查Firebase緩存大小
                if (typeof FirebaseCache !== 'undefined' && FirebaseCache.cacheSize > 50) {
                    warnings.push('Firebase緩存可能過大: ' + FirebaseCache.cacheSize + ' 項目');
                }
                
                return warnings;
            },
            
            // 執行完整性檢查報告
            generateHealthReport() {
                return {
                    timestamp: new Date().toISOString(),
                    version: window.AdminSystem?.version || 'unknown',
                    firebaseStatus: isFirebaseAvailable(),
                    memoryWarnings: this.checkMemoryLeaks(),
                    unusedListeners: this.findUnusedListeners(),
                    isInitialized: window.AdminSystem?.isInitialized || false
                };
            }
        };

        // 檢查 Firebase 是否可用
        function isFirebaseAvailable() {
            return typeof firebase !== 'undefined' && 
                   db && 
                   storage && 
                   typeof db.collection === 'function' &&
                   typeof storage.ref === 'function';
        }

        // 代碼完整性檢查
        function validateCodeIntegrity() {
            const requiredFunctions = [
                'checkAuthenticationStatus',
                'showLoginPage', 
                'showMainContent',
                'checkIPBlocking',
                'createFirebaseSession',
                'clearFirebaseSession',
                'getUserFingerprint'
            ];
            
            const missingFunctions = requiredFunctions.filter(fn => typeof window[fn] !== 'function');
            
            if (missingFunctions.length > 0) {
                console.error('代碼完整性檢查失敗，缺少以下函數:', missingFunctions);
                return false;
            }
            
            console.info('✅ 代碼完整性檢查通過');
            return true;
        }

        // Clear hash on initial load
        if (window.location.hash) {
            history.replaceState(null, null, window.location.pathname + window.location.search);
        }


    </script>
            <!-- 1秒載入骨架屏 -->
    <div id="loadingScreen" class="loading-screen">
        <div class="skeleton skeleton-header"></div>
        <div class="skeleton skeleton-nav"></div>
        <div class="skeleton skeleton-content"></div>
        <div class="loading-text">載入中...</div>
    </div>
    
    <!-- 登錄容器 -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <div class="login-form">
                <input 
                    type="password" 
                    id="adminPassword" 
                    class="login-input" 
                    autocomplete="current-password"
                    maxlength="6"
                    inputmode="numeric"
                >
                <div id="loginError" class="login-error"></div>
                <div id="lockoutMessage" class="lockout-message"></div>
            </div>
        </div>
    </div>

    <!-- 主要內容容器 -->
    <div id="mainContent" class="main-content">
    <div class="container">
        <h1>後台管理系統</h1>
        
        <div class="settings-button">
            <button class="btn-primary btn-compact settings-btn" id="settingsBtn">
                採購設定
            </button>
            <button class="btn-danger btn-compact logout-btn" id="logoutBtn">
                登出
            </button>
        </div>

        <!-- 導航選單 -->
        <div class="nav-menu">
            <a href="#home" class="nav-item active" data-function="home">首頁</a>
            <a href="#user" class="nav-item" data-function="user">會員管理</a>
            <a href="#order" class="nav-item" data-function="order">訂單管理</a>
        </div>

        <!-- 首頁區塊 -->
        <div id="homeSection" class="function-section active">
            <div class="dashboard-section">
                <h2>數據總覽</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>今日總訂單</h3>
                        <div class="stat-value" id="todayOrders">0</div>
                        <div class="stat-label">筆</div>
                    </div>
                    <div class="stat-card">
                        <h3>未處理訂單</h3>
                        <div class="stat-value" id="pendingOrders">0</div>
                        <div class="stat-label">筆</div>
                    </div>
                    <div class="stat-card">
                        <h3>今日已完成</h3>
                        <div class="stat-value" id="processingOrders">0</div>
                        <div class="stat-label">筆</div>
                    </div>
                    <div class="stat-card">
                        <h3>總會員數</h3>
                        <div class="stat-value" id="totalMembers">0</div>
                        <div class="stat-label">人</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-section">
                        <h3>當週訂單趨勢</h3>
                        <div class="chart-canvas-container">
                            <canvas id="orderTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-section">
                        <h3>會員等級分布</h3>
                        <div class="chart-canvas-container">
                            <canvas id="memberLevelChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 會員管理區塊 -->
        <div id="userSection" class="function-section">
            <div class="members-section">
                <div class="members-header">
                    <h2>會員管理</h2>
                    <div class="members-controls">
                        <input type="text" id="memberSearch" placeholder="搜尋會員..." oninput="searchMembers()">
                    </div>
                </div>
                <table id="membersTable">
                    <thead>
                        <tr>
                            <th>電話號碼</th>
                            <th>會員等級</th>
                            <th>到期日期</th>
                            <th>加入日期</th>
                            <th>最後登入</th>
                            <th>最後更新</th>
                            <th>狀態</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="membersList">
                        <!-- 會員列表將由JavaScript動態填充 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 訂單管理區塊 -->
        <div id="orderSection" class="function-section">
            <div class="orders-section">
                <div class="orders-header">
                    <h2>訂單列表</h2>
                    <div class="filters">
                        <select id="statusFilter">
                            <option value="all">全部狀態</option>
                            <option value="pending">待處理</option>
                            <option value="processing">處理中</option>
                            <option value="completed">完成</option>
                        </select>
                    </div>
                </div>
                <table id="ordersTable">
                    <thead>
                        <tr>
                            <th>訂單編號</th>
                            <th>聯絡電話</th>
                            <th>支付類型</th>
                            <th>申請金額</th>
                            <th>實付金額</th>
                            <th>狀態</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="ordersList">
                        <!-- 訂單列表將由JavaScript動態填充 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 添加設定模態框 -->
    <div id="settingsModal" class="modal">
        <div class="modal-content settings-modal">
            <span class="close" onclick="closeSettingsModal()">&times;</span>
            <h2 class="settings-title">
                採購成本設定
            </h2>
            <div class="function-content" id="procurementContent">
                <!-- 新增：匯率計算工具區域 -->
                <div class="rate-calculator-section">
                    <h3 class="calculator-title clickable-title" onclick="openBankRateWindow()" title="點擊查看台銀匯率">
                        <i class="fas fa-calculator"></i>
                        計算機
                    </h3>
                    <div class="rate-input-group">
                        <div class="rate-inputs">
                            <input type="number" 
                                   id="buyRate" 
                                   step="0.0001" 
                                   placeholder="買入價"
                                   oninput="calculateRates()"
                                   onpaste="handleRatePaste(event)"
                                   onclick="clearRateInput(this)">
                            <input type="number" 
                                   id="sellRate" 
                                   step="0.0001" 
                                   placeholder="賣出價"
                                   oninput="calculateRates()"
                                   onpaste="handleRatePaste(event)"
                                   onclick="clearRateInput(this)">
                        </div>
                        <div id="midRateDisplay" class="mid-rate-display"></div>

                    </div>
                </div>

                <div class="settings-container">
                    <div class="settings-grid">
                        <div class="form-group">
                            <label for="purchaseCost">基礎成本</label>
                            <input type="number" id="purchaseCost" min="0.0001" step="0.0001" placeholder="例如: 4.2850">
                        </div>
                        <div class="form-group">
                            <label for="tenThousandDiscount">滿萬優惠</label>
                            <input type="number" id="tenThousandDiscount" min="0.0001" step="0.0001" placeholder="例如: 4.2650">
                        </div>
                        <div class="form-group">
                            <label for="fiftyThousandDiscount">五萬優惠</label>
                            <input type="number" id="fiftyThousandDiscount" min="0.0001" step="0.0001" placeholder="例如: 4.2550">
                        </div>
                        <div class="form-group">
                            <label for="negotiableDiscount">議價優惠</label>
                            <input type="number" id="negotiableDiscount" min="0.0001" step="0.0001" placeholder="例如: 4.2450">
                        </div>

                        <div class="form-group test-section">
                            <label for="testAmount">金額試算</label>
                            <input type="number" id="testAmount" min="0" step="100" placeholder="請輸入金額試算" oninput="calculateTest()">
                            <div id="testResult" class="test-result">-</div>
                        </div>
                    </div>
                    <div class="button-group">
                        <button onclick="saveSettings()" class="btn-primary save-btn">
                            保存
                        </button>
                        <button onclick="closeSettingsModal()" class="btn-secondary cancel-btn">取消</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
                // 初始化首頁數據（1秒載入優化版本）
        async function initializeDashboard() {
            // 立即顯示統計數據（零延遲）
            setupDashboardListeners();
            
            // 等待 Chart.js 載入完成後初始化圖表
            const waitForChart = () => {
                if (typeof Chart !== 'undefined') {
                    console.info('Chart.js 已載入，初始化圖表');
                    initializeCharts();
                } else {
                    console.info('等待 Chart.js 載入...');
                    setTimeout(waitForChart, 200);
                }
            };
            
            // 延遲 1 秒後開始檢查 Chart.js
            setTimeout(waitForChart, 1000);
        }



        // 設置儀表板監聽器（分離出來避免阻塞）
        function setupDashboardListeners() {
            // 確保Firebase可用
            if (!isFirebaseAvailable()) {
                console.warn('⚠️ Firebase 不可用，跳過儀表板監聽器設置');
                return;
            }
            
            try {
                // 判斷 Firestore createdAt 欄位型態
                let today = new Date();
                today.setHours(0, 0, 0, 0);
                let todayQueryValue;
                if (typeof firebase.firestore.Timestamp === 'function') {
                    todayQueryValue = firebase.firestore.Timestamp.fromDate(today);
                } else {
                    todayQueryValue = today.toISOString();
                }
                
                // 今日總訂單數
                db.collection('orders')
                    .where('createdAt', '>=', todayQueryValue)
                    .onSnapshot(snapshot => {
                        document.getElementById('todayOrders').textContent = snapshot.size;
                    }, err => console.error('今日總訂單監聽錯誤', err));
                
                // 未處理訂單數（包含 pending + processing）
                db.collection('orders')
                    .onSnapshot(snapshot => {
                        let unprocessedCount = 0;
                        snapshot.forEach(doc => {
                            const order = doc.data();
                            if (order.status === 'pending' || order.status === 'processing') {
                                unprocessedCount++;
                            }
                        });
                        document.getElementById('pendingOrders').textContent = unprocessedCount;
                    }, err => console.error('未處理訂單監聽錯誤', err));
                
                // 今日已完成訂單數（根據完成時間統計）
                db.collection('orders')
                    .where('status', '==', 'completed')
                    .onSnapshot(snapshot => {
                        let completedTodayCount = 0;
                        const todayStart = new Date();
                        todayStart.setHours(0, 0, 0, 0);
                        
                        snapshot.forEach(doc => {
                            const order = doc.data();
                            if (order.completedAt) {
                                const completedDate = new Date(order.completedAt);
                                if (completedDate >= todayStart) {
                                    completedTodayCount++;
                                }
                            }
                        });
                        document.getElementById('processingOrders').textContent = completedTodayCount;
                    }, err => console.error('今日已完成訂單監聽錯誤', err));
                
                // 總會員數
                db.collection('members')
                    .onSnapshot(snapshot => {
                        document.getElementById('totalMembers').textContent = snapshot.size;
                    }, err => console.error('會員監聽錯誤', err));
                    
            } catch (error) {
                console.error('Error setting up dashboard listeners:', error);
            }
        }

        // 圖表初始化（簡化版）
        function initializeCharts() {
            console.info('開始初始化圖表...');
            
            // 檢查圖表容器是否存在
            const orderChart = document.getElementById('orderTrendChart');
            const memberChart = document.getElementById('memberLevelChart');
            
            if (!orderChart || !memberChart) {
                console.error('圖表容器不存在，無法初始化圖表');
                return;
            }
            
            console.info('圖表容器已找到，準備初始化');
            
            // 檢查 Firebase 是否可用
            if (!isFirebaseAvailable()) {
                console.warn('Firebase 不可用，使用默認數據初始化圖表');
                fastChartManager.initWithDefaultData();
                return;
            }
            
            // 使用圖表管理器初始化
            fastChartManager.fastInit();
        }



        // 高性能圖表管理系統
        class FastChartManager {
            constructor() {
                this.cache = new Map();
                this.charts = {};
                this.isLoaded = false;
                this.isInitialized = false;
                this.updateTimer = null;
                this.CACHE_TTL = 10000; // 10秒緩存（即時更新）
            }

            // 快速初始化（立即顯示簡化版本）
            async fastInit() {
                // 防止重複初始化
                if (this.isInitialized) {
                    console.info('圖表已初始化，跳過重複初始化');
                    return;
                }

                this.isInitialized = true;
                console.info('開始初始化圖表管理器');
                
                // 檢查 Chart.js 是否可用
                if (typeof Chart !== 'undefined') {
                    try {
                        await this.loadRealCharts();
                        console.info('圖表初始化成功');
                    } catch (error) {
                        console.error('圖表載入失敗:', error);
                        // 載入失敗時使用默認數據
                        this.initWithDefaultData();
                    }
                } else {
                    console.warn('Chart.js 尚未載入，等待中...');
                    // 等待 Chart.js 載入（使用更安全的方式）
                    this.waitForChartJS();
                }
            }

            // 安全等待 Chart.js 載入
            waitForChartJS(maxAttempts = 10, attempt = 0) {
                if (attempt >= maxAttempts) {
                    console.error('Chart.js 載入超時，使用默認數據');
                    this.initWithDefaultData();
                    return;
                }

                if (typeof Chart !== 'undefined') {
                    console.info('Chart.js 已載入，重新初始化');
                    this.isInitialized = false; // 重置標誌
                    this.fastInit();
                } else {
                    setTimeout(() => {
                        this.waitForChartJS(maxAttempts, attempt + 1);
                    }, 500); // 每 500ms 檢查一次
                }
            }

            // 載入真實圖表數據
            async loadRealCharts() {
                const [orderData, memberData] = await Promise.all([
                    this.getOrderData(),
                    this.getMemberData()
                ]);

                this.renderOrderChart(orderData);
                this.renderMemberChart(memberData);
                this.isLoaded = true;

                // 設置自動更新
                this.setupAutoUpdate();
            }

            // 獲取訂單數據（修復版）
            async getOrderData() {
                const orderCacheKey = 'orderTrend';
                const cached = this.cache.get(orderCacheKey);
                
                if (cached && Date.now() - cached.time < this.CACHE_TTL) {
                    return cached.data;
                }

                try {
                    // 獲取所有訂單數據，避免複雜的時間範圍查詢
                    const allSnapshot = await db.collection('orders').get();
                    
                    if (allSnapshot.empty) {
                        return this.getDefaultOrderData();
                    }

                    // 分析並處理數據
                    const weekStart = this.getWeekStart();
                    const data = this.processOrderData(allSnapshot, weekStart);
                    
                    this.cache.set(orderCacheKey, { data, time: Date.now() });
                    return data;
                } catch (error) {
                    console.error('獲取訂單數據失敗:', error);
                    return this.getDefaultOrderData();
                }
            }

            // 獲取會員數據（超快查詢）
            async getMemberData() {
                const memberCacheKey = 'memberLevel';
                const cached = this.cache.get(memberCacheKey);
                
                if (cached && Date.now() - cached.time < this.CACHE_TTL) {
                    return cached.data;
                }

                try {
                    const snapshot = await db.collection('members')
                        .limit(1000) // 限制查詢數量
                        .get();

                    const data = this.processMemberData(snapshot);
                    this.cache.set(memberCacheKey, { data, time: Date.now() });
                    return data;
                } catch (error) {
                    return this.getDefaultMemberData();
                }
            }

            // 處理訂單數據（修復版）
            processOrderData(snapshot, weekStart) {
                const orderTrendData = new Array(7).fill(0);
                
                // 週結束時間
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 7);
                weekEnd.setHours(23, 59, 59, 999); // 設定為當天結束

                snapshot.forEach(doc => {
                    const order = doc.data();
                    
                    // 處理不同的時間戳格式
                    let orderDate = null;
                    if (order.createdAt) {
                        if (typeof order.createdAt.toDate === 'function') {
                            // Firestore Timestamp
                            orderDate = order.createdAt.toDate();
                        } else if (typeof order.createdAt === 'string') {
                            // ISO 字串
                            orderDate = new Date(order.createdAt);
                        } else if (typeof order.createdAt === 'number') {
                            // Unix 時間戳（毫秒）
                            orderDate = new Date(order.createdAt);
                        } else if (order.createdAt instanceof Date) {
                            // 已經是 Date 物件
                            orderDate = order.createdAt;
                        }
                    }
                    
                    if (orderDate && !isNaN(orderDate.getTime())) {
                        // 檢查是否在當週範圍內
                        if (orderDate >= weekStart && orderDate < weekEnd) {
                            // 計算是週幾（0=週一, 1=週二, ..., 6=週日）
                            const orderDay = orderDate.getDay();
                            const dayIndex = orderDay === 0 ? 6 : orderDay - 1; // 轉換為週一開始的索引
                            
                            orderTrendData[dayIndex]++;
                        }
                    }
                });

                return {
                    labels: this.getWeekLabels(weekStart),
                    data: orderTrendData
                };
            }

            // 處理會員數據
            processMemberData(snapshot) {
                const levelCount = { basic: 0, tenThousand: 0, fiftyThousand: 0, negotiable: 0 };
                
                snapshot.forEach(doc => {
                    const member = doc.data();
                    const level = member.level || 'basic';
                    if (levelCount.hasOwnProperty(level)) {
                        levelCount[level]++;
                    }
                });

                return levelCount;
            }

            // 渲染真實訂單圖表
            renderOrderChart(data) {
                const canvas = document.getElementById('orderTrendChart');
                if (!canvas) return;

                canvas.style.display = 'block';

                if (this.charts.order) {
                    this.charts.order.destroy();
                }

                const ctx = canvas.getContext('2d');
                this.charts.order = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: '訂單數量',
                            data: data.data,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            tension: 0.3,
                            fill: true,
                            borderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                enabled: true,
                                callbacks: {
                                    title: function(tooltipItems) {
                                        return tooltipItems[0].label;
                                    },
                                    label: function(context) {
                                        return `訂單數量: ${context.parsed.y}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        return Math.floor(value) === value ? value : '';
                                    }
                                }
                            },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }

            // 渲染真實會員圖表
            renderMemberChart(levelCount) {
                const canvas = document.getElementById('memberLevelChart');
                if (!canvas) return;

                canvas.style.display = 'block';

                if (this.charts.member) {
                    this.charts.member.destroy();
                }

                const ctx = canvas.getContext('2d');
                this.charts.member = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['基礎會員', '滿萬會員', '五萬會員', '議價會員'],
                        datasets: [{
                            data: [levelCount.basic, levelCount.tenThousand, levelCount.fiftyThousand, levelCount.negotiable],
                            backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#8b5cf6'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false, // 禁用動畫
                        plugins: {
                            legend: { position: 'bottom', labels: { padding: 15, font: { size: 11 } } }
                        },
                        cutout: '60%'
                    }
                });
            }

            // 輔助函數 - 獲取本週開始時間（週一 00:00:00）
            getWeekStart() {
                const today = new Date();
                const currentDay = today.getDay(); // 0=週日, 1=週一, ..., 6=週六
                
                // 計算到週一的天數差
                const daysFromMonday = currentDay === 0 ? 6 : currentDay - 1;
                
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - daysFromMonday);
                weekStart.setHours(0, 0, 0, 0); // 設定為當天開始
                
                return weekStart;
            }

            getWeekLabels(weekStart) {
                const labels = [];
                const weekDays = ['週一', '週二', '週三', '週四', '週五', '週六', '週日'];
                
                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + i);
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    labels.push(`${weekDays[i]} ${month}/${day}`);
                }
                
                return labels;
            }

            getDefaultOrderData() {
                const weekStart = this.getWeekStart();
                return {
                    labels: this.getWeekLabels(weekStart),
                    data: [0, 0, 0, 0, 0, 0, 0]
                };
            }

            getDefaultMemberData() {
                return { basic: 1, tenThousand: 0, fiftyThousand: 0, negotiable: 0 };
            }

            // 設置自動更新
            setupAutoUpdate() {
                // 清除舊的定時器
                if (this.updateTimer) {
                    clearInterval(this.updateTimer);
                }
                
                this.updateTimer = setInterval(async () => {
                    if (this.isLoaded) {
                        this.cache.clear(); // 清除緩存
                        await this.loadRealCharts();
                    }
                }, 60000); // 1分鐘更新一次（配合10秒緩存）
            }

            // 清理資源
            cleanup() {
                Object.values(this.charts).forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
                this.cache.clear();
                
                if (this.updateTimer) {
                    clearInterval(this.updateTimer);
                    this.updateTimer = null;
                }
                
                // 重置狀態
                this.isLoaded = false;
                this.isInitialized = false;
                this.charts = {};
            }

            // 重置圖表系統（用於強制重新初始化）
            reset() {
                this.cleanup();
            }
            
            // 使用默認數據初始化圖表（Firebase 不可用時）
            initWithDefaultData() {
                console.info('使用默認數據初始化圖表');
                
                // 檢查 Chart.js 是否可用
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js 未定義，無法渲染圖表，顯示提示訊息');
                    this.showChartUnavailableMessage();
                    return;
                }
                
                this.renderOrderChart(this.getDefaultOrderData());
                this.renderMemberChart(this.getDefaultMemberData());
            }
            
            // 顯示圖表不可用訊息
            showChartUnavailableMessage() {
                const orderChart = document.getElementById('orderTrendChart');
                const memberChart = document.getElementById('memberLevelChart');
                
                if (orderChart) {
                    orderChart.style.display = 'none';
                    const container = orderChart.parentElement;
                    if (container) {
                        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">圖表載入中，請稍候...</div>';
                    }
                }
                
                if (memberChart) {
                    memberChart.style.display = 'none';
                    const container = memberChart.parentElement;
                    if (container) {
                        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">圖表載入中，請稍候...</div>';
                    }
                }
            }
        }

        // 全域快速圖表管理器
        const fastChartManager = new FastChartManager();

        // ===== 完整的圖片管理器 =====
        class ImageManager {
            // 載入訂單圖片（增強版）
            static async loadOrderImages(images, container, orderId) {
                try {
                    // 先清理舊的圖片資源
                    this.cleanupContainer(container);
                    
                    // 添加載入狀態
                    container.innerHTML = '<div class="loading-indicator">載入圖片中...</div>';
                    
                    // 改為完全並行載入，提升速度
                    const imagePromises = images.map((image, index) => 
                        this.createImageElement(image, container, index)
                    );
                    
                    // 等待所有圖片載入完成（無論成功或失敗）
                    const results = await Promise.allSettled(imagePromises);
                    
                    // 記錄載入統計
                    const successful = results.filter(result => result.status === 'fulfilled' && result.value !== null).length;
                    const failed = results.filter(result => result.status === 'rejected' || result.value === null).length;
                    
                    if (images.length > 0) {
    
                    }
                    
                    // 移除載入指示器
                    const loadingIndicator = container.querySelector('.loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.remove();
                    }
                    
                } catch (error) {
                    console.error('載入圖片失敗:', error);
                    container.innerHTML = '<p class="error-message">圖片載入失敗</p>';
                }
            }
            
            // 創建單個圖片元素
            static async createImageElement(image, container, index) {
                try {
                        const imageContainer = document.createElement('div');
                        imageContainer.className = 'enhanced-image-container';
                    imageContainer.dataset.imageIndex = index;
                        
                        // 創建圖片元素
                        const img = document.createElement('img');
                        img.alt = image.name;
                    img.loading = 'lazy'; // 延遲載入
                        
                        // 創建覆蓋層
                        const overlay = document.createElement('div');
                        overlay.className = 'image-overlay';
                        
                        // 添加圖片信息
                        const imageInfo = document.createElement('div');
                        imageInfo.className = 'image-info';
                        imageInfo.textContent = image.name;
                        
                    // 使用防抖的點擊處理器
                    let clickTimeout;
                    img.onclick = () => {
                        clearTimeout(clickTimeout);
                        clickTimeout = setTimeout(() => {
                            this.showSimpleImagePreview(image);
                        }, 200);
                    };
                        img.style.cursor = 'pointer';
                        
                        overlay.appendChild(imageInfo);
                        imageContainer.appendChild(img);
                        imageContainer.appendChild(overlay);
                        container.appendChild(imageContainer);
                        
                    // 載入圖片並獲取元數據
                        await this.loadImageWithMetadata(img, image);
                        
                    return imageContainer;
                } catch (error) {
                    console.warn(`載入圖片 ${index} 失敗:`, error.message);
                    
                    // 即使載入失敗，也返回容器（可能包含錯誤訊息）
                    try {
                        const errorContainer = document.createElement('div');
                        errorContainer.className = 'enhanced-image-container error-state';
                        errorContainer.innerHTML = `
                                                <div class="image-load-error">
                        <div class="image-load-error-icon">📷</div>
                        <div class="image-load-error-text">載入失敗</div>
                    </div>
                        `;
                        return errorContainer;
                    } catch (fallbackError) {
                        console.error('創建錯誤容器失敗:', fallbackError);
                        return null;
                    }
                }
            }
            
            // 清理容器中的圖片資源
            static cleanupContainer(container) {
                if (!container) return;
                
                const images = container.querySelectorAll('img');
                images.forEach(img => {
                    // 移除事件監聽器
                    img.onclick = null;
                    img.onload = null;
                    img.onerror = null;
                    
                    // 清空 src，停止載入
                    img.src = '';
                    
                    // 清理元數據
                            delete img.dataset.metadata;
                            delete img.dataset.sizeInfo;
                });
                
                // 清空容器
                container.innerHTML = '';
            }
            
            // 載入圖片並獲取元數據（優化版）
            static async loadImageWithMetadata(imgElement, imageData) {
                return new Promise((resolve, reject) => {
                    // 添加防禦性檢查
                    if (!imgElement || !imageData) {
                        console.error('圖片元素或圖片數據無效');
                        resolve();
                        return;
                    }
                    
                    // 設置超時機制，防止長時間載入
                    const timeout = setTimeout(() => {
                        console.warn(`圖片載入超時: ${imageData.name}`);
                        // 隱藏圖片元素但繼續流程
                        if (imgElement) {
                            imgElement.style.display = 'none';
                        }
                        resolve(); // 使用 resolve 而不是 reject，避免中斷整個流程
                    }, 8000); // 8秒超時，適當平衡等待時間與用戶體驗
                    
                    imgElement.onload = async () => {
                        clearTimeout(timeout);
                        try {
                            // 簡化元數據獲取，避免過多 Firebase 請求
                            const overlay = imgElement.parentNode?.querySelector('.image-overlay');
                            if (overlay) {
                                // 只添加基本信息，不做複雜的 Firebase 查詢
                                    const metadataDiv = document.createElement('div');
                                    metadataDiv.className = 'image-metadata';
                                    metadataDiv.textContent = imageData.type ? imageData.type.toUpperCase() : '圖片';
                                    
                                    const sizeInfo = document.createElement('div');
                                    sizeInfo.className = 'image-size-info';
                                sizeInfo.textContent = `${imgElement.naturalWidth}×${imgElement.naturalHeight}`;
                                
                                overlay.appendChild(metadataDiv);
                                overlay.appendChild(sizeInfo);
                            }
                            
                            resolve();
                        } catch (error) {
                            console.warn('添加圖片元數據失敗:', error.message);
                            resolve(); // 即使元數據失敗也要繼續
                        }
                    };
                    
                    imgElement.onerror = () => {
                        clearTimeout(timeout);
                        imgElement.style.display = 'none';
                        console.error('圖片載入失敗:', {
                            name: imageData.name,
                            type: imageData.type,
                            field: imageData.field
                        });
                        resolve(); // 改為 resolve 而不是 reject，避免中斷整個流程
                    };
                    
                    // 開始載入圖片
                    imgElement.src = imageData.data;
                });
            }
            

            
            // 簡化的圖片預覽
            static showSimpleImagePreview(imageData) {
                const preview = document.getElementById('imagePreview');
                const previewImage = document.getElementById('previewImage');
                
                // 先隱藏預覽
                preview.style.display = 'none';
                previewImage.style.display = 'none';
                
                // 檢查圖片URL是否有效
                if (!imageData || !imageData.data) {
                    console.error('圖片數據無效:', imageData);
                    console.warn('圖片數據無效，無法預覽');
                    return;
                }
                

                
                // 設置圖片源並顯示
                previewImage.src = imageData.data;
                previewImage.onload = function() {
                    preview.style.display = 'flex';
                    previewImage.style.display = 'block';
                    
                    // 使用統一的預覽管理器
                    ImagePreviewManager.setActive(true);
                    
                    // 添加點擊背景關閉功能
                    preview.onclick = function(event) {
                        // 只有點擊背景（非圖片本身）時才關閉
                        if (event.target === preview) {
                            ImagePreviewManager.close();
                        }
                    };
                    
                    // 防止圖片點擊事件冒泡
                    previewImage.onclick = function(event) {
                        event.stopPropagation();
                    };
                };
                previewImage.onerror = function() {
                    // 確保預覽管理器狀態正確
                    ImagePreviewManager.close();
                    
                    console.error('圖片預覽失敗:', imageData.name);
                    
                    // 簡化錯誤處理，避免更多網路請求導致資源耗盡
                    console.warn('圖片預覽失敗，請檢查網路連接或圖片是否有效');
                };
            }
            

        }

        // 安全的 flatpickr 初始化函數
        function createSafeFlatpickr(selector, options = {}) {
            try {
                // 檢查 flatpickr 是否載入
                if (typeof flatpickr === 'undefined') {
                    console.error('Flatpickr 尚未載入');
                    return null;
                }

                // 設定安全的預設選項，包含中文本地化
                const safeOptions = {
                    locale: 'zh_tw',  // 預設使用中文
                    ...options
                };

                // 如果指定了中文locale，確保中文設置可用
                if (safeOptions.locale === 'zh_tw') {
                    // 檢查中文 locale 是否已載入
                    if (!flatpickr.l10ns || !flatpickr.l10ns.zh_tw) {
                        console.warn('中文 locale 尚未載入，等待載入...');
                        // 等待中文本地化載入完成
                        let retryCount = 0;
                        const waitForLocale = () => {
                            if (flatpickr.l10ns && flatpickr.l10ns.zh_tw) {
                                return flatpickr(selector, safeOptions);
                            } else if (retryCount < 10) {
                                retryCount++;
                                setTimeout(waitForLocale, 100);
                                return null;
                            } else {
                                console.warn('等待中文 locale 超時，使用英文');
                                delete safeOptions.locale;
                                return flatpickr(selector, safeOptions);
                            }
                        };
                        return waitForLocale();
                    }
                }

                return flatpickr(selector, safeOptions);
            } catch (error) {
                console.error('Flatpickr 初始化錯誤:', error);
                // 嘗試使用基本選項重新初始化
                try {
                    const basicOptions = { ...options };
                    delete basicOptions.locale;
                    return flatpickr(selector, basicOptions);
                } catch (fallbackError) {
                    console.error('Flatpickr 基本初始化也失敗:', fallbackError);
                    return null;
                }
            }
        }



        // 舊的頁面載入邏輯已移至登錄系統中的 initializeAfterLogin 函數

        // 頁面卸載時清理資源
        window.addEventListener('beforeunload', function() {
            try {
            // 清理訂單詳情監聽器
            if (orderDetailsListener) {
                orderDetailsListener();
                orderDetailsListener = null;
            }
            
            // 清理統一管理器監聽器
            if (typeof listManager !== 'undefined') {
                listManager.stopAllListening();
            }
            
            // 清理圖表資源
            if (fastChartManager) {
                fastChartManager.cleanup();
            }
            
            // 清理圖片預覽管理器
            if (typeof ImagePreviewManager !== 'undefined') {
                ImagePreviewManager.removeEventListeners();
                }
                
                // 清理所有模態框中的圖片資源
                cleanupAllImageResources();
                
    
            } catch (error) {
                console.error('❌ 頁面資源清理時發生錯誤:', error);
            }
        });
        
        // 清理所有圖片資源
        function cleanupAllImageResources() {
            try {
                // 清理所有模態框中的圖片
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    const images = modal.querySelectorAll('img');
                    images.forEach(img => {
                        img.onclick = null;
                        img.onload = null;
                        img.onerror = null;
                        img.src = '';
                    });
                });
                
                // 清理圖片預覽
                const previewImage = document.getElementById('previewImage');
                if (previewImage) {
                    previewImage.src = '';
                    previewImage.onload = null;
                    previewImage.onerror = null;
                }
            } catch (error) {
                console.error('清理圖片資源時發生錯誤:', error);
            }
        }

        // 處理 URL hash 變化
        function handleHashChange() {
            const hash = window.location.hash.replace('#', '');
            // 只允許 home/user/order，否則預設 home
            const validPages = ['home', 'user', 'order'];
            const page = validPages.includes(hash) ? hash : 'home';
            switchFunction(page);
        }

        // 切換功能頁面（優化版 - 同步顯示預載入數據）
        function switchFunction(functionName) {
            
            // 更新導航選單狀態
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const nav = document.querySelector(`.nav-item[href="#${functionName}"]`);
            if (nav) nav.classList.add('active');

            // 更新功能區塊顯示
            document.querySelectorAll('.function-section').forEach(section => {
                section.classList.remove('active');
            });
            const section = document.getElementById(`${functionName}Section`);
            if (section) section.classList.add('active');

            // 根據頁面類型進行優化處理
            switch(functionName) {
                case 'home':
                case 'dashboard':
                    handleDashboardSwitch();
                    break;
                    
                case 'member':
                case 'user':
                    handleMemberSwitch();
                    break;
                    
                case 'order':
                    handleOrderSwitch();
                    break;
            }

            // 只在非首頁時更新 URL hash
            if (functionName !== 'home' && functionName !== 'dashboard') {
                window.location.hash = functionName;
            } else {
                history.pushState("", document.title, window.location.pathname);
            }
        }
        
        // 處理儀表板頁面切換
        function handleDashboardSwitch() {
            // 檢查是否有預載入數據
            const dashboardData = DataPreloader.getCache('dashboard');
            if (dashboardData) {
                console.info('⚡ 使用預載入數據立即顯示儀表板');
                DataPreloader.updateDashboardUI(dashboardData);
            }
            
            // 初始化圖表（防重複初始化）
            if (typeof fastChartManager !== 'undefined') {
                fastChartManager.fastInit();
            }
        }
        
        // 處理會員頁面切換
        function handleMemberSwitch() {
            // 檢查是否有預載入數據
            const membersData = DataPreloader.getCache('members');
            if (membersData && membersData.length > 0) {
                console.info('⚡ 使用預載入數據立即顯示會員列表');
                
                // 立即顯示預載入的會員數據
                const mockSnapshot = {
                    empty: false,
                    size: membersData.length,
                    forEach: (callback) => {
                        membersData.forEach(member => {
                            callback({
                                id: member.id,
                                data: () => member
                            });
                        });
                    }
                };
                
                renderMembersList(mockSnapshot);
            }
            
            // 確保有實時監聽器
            setTimeout(() => {
                if (typeof listManager !== 'undefined') {
                    listManager.startListening('members');
                }
            }, 100);
        }
        
        // 處理訂單頁面切換
        function handleOrderSwitch() {
            // 檢查是否有預載入數據
            const ordersData = DataPreloader.getCache('orders');
            if (ordersData && ordersData.length > 0) {
                console.info('⚡ 使用預載入數據立即顯示訂單列表');
                // 這裡可以添加訂單數據的立即顯示邏輯
            }
            
            // 延遲初始化完整的訂單管理
            setTimeout(() => {
                if (typeof initializeOrderManagement === 'function') {
                    initializeOrderManagement();
                }
            }, 50);
        }



        // 顯示訂單詳情
        async function showOrderDetails(orderId) {
            try {
                currentOrderId = orderId; // 設置當前訂單ID
                
                // 清除舊的監聽器
                if (orderDetailsListener) {
                    orderDetailsListener();
                    orderDetailsListener = null;
                }
                
                // 設置實時監聽器
                orderDetailsListener = db.collection('orders').doc(orderId).onSnapshot(async (doc) => {
                    if (!doc.exists) {
                        alert('訂單不存在');
                        closeModal('orderModal');
                        return;
                    }
                    
                    const order = doc.data();
                    await updateOrderDetailsDisplay(order, orderId);
                });
                
            } catch (error) {
                console.error('Error loading order details:', error);
                alert('載入訂單詳情失敗');
            }
        }

        // 更新訂單詳情顯示
        async function updateOrderDetailsDisplay(order, orderId) {
            try {
                // 獲取會員信息
                const memberPhone = order.phone;
                let memberData = null;
                if (memberPhone) {
                    try {
                        const memberResult = await FirebaseCache.getDoc('members', memberPhone);
                        memberData = memberResult.exists ? memberResult.data : null;
                    } catch (error) {
                        console.error('Error fetching member data:', error);
                    }
                }

                // 顯示會員信息
                document.getElementById('modalMemberPhone').textContent = memberPhone || '-';
                if (memberData) {
                    document.getElementById('modalMemberLevel').textContent = getMemberLevelName(memberData.level || 'basic');
                } else {
                    document.getElementById('modalMemberLevel').textContent = '未註冊會員';
                }
                
                document.getElementById('modalOrderId').textContent = order.orderNumber || orderId; // orderId 現在就是訂單編號
                document.getElementById('modalPaymentType').textContent = getPaymentTypeName(order.paymentType);
                
                // 獲取會員匯率並顯示格式：匯率 / 申請金額
                const exchangeRate = await getMemberExchangeRate(order.amount, memberData?.level || 'basic');
                const modalAmountElement = document.getElementById('modalAmount');
                modalAmountElement.innerHTML = `
                    <span class="exchange-rate-display">${exchangeRate}</span>
                    <span class="exchange-rate-separator">/</span>
                    <span class="exchange-rate-amount">${order.amount.toFixed(2)}</span>
                `;
                
                // Calculate final amount asynchronously, consider member level
                const finalAmount = await calculateFinalAmount(order.amount, memberData?.level || 'basic', memberData);
                document.getElementById('modalFinalAmount').textContent = Math.round(finalAmount).toString();
                
                document.getElementById('modalStatus').textContent = getStatusName(order.status);
                document.getElementById('modalCreatedAt').innerHTML = formatDateTimeTwoLines(order.createdAt);
                
                // 顯示預計完成時間（兩行格式）
                const expectedTimeDisplay = document.getElementById('modalExpectedDateTime');
                if (order.expectedCompletionTime) {
                    expectedTimeDisplay.innerHTML = formatDateTimeTwoLines(order.expectedCompletionTime);
                } else {
                    // 預設為3天後
                    const threeDaysLater = new Date();
                    threeDaysLater.setDate(threeDaysLater.getDate() + 3);
                    threeDaysLater.setHours(9, 0, 0, 0);
                    expectedTimeDisplay.innerHTML = formatDateTimeTwoLines(threeDaysLater.toISOString());
                }

                // 顯示圖片
                const modalImages = document.getElementById('modalImages');
                modalImages.innerHTML = '';
                
                // 檢查不同類型的圖片
                const images = [];
                
                // 驗證URL是否有效的輔助函數
                const isValidImageUrl = (url) => {
                    if (!url || typeof url !== 'string') return false;
                    const trimmedUrl = url.trim();
                    return trimmedUrl.length > 0 && 
                           (trimmedUrl.startsWith('http://') || 
                            trimmedUrl.startsWith('https://') || 
                            trimmedUrl.startsWith('data:'));
                };
                
                // 檢查微信二維碼
                if (isValidImageUrl(order.wechatQrCodeURL)) {
                    images.push({
                        data: order.wechatQrCodeURL,
                        name: '微信支付碼',
                        type: 'wechat',
                        field: 'wechatQrCodeURL'
                    });
                } else if (order.wechatQrCodeURL) {
                    console.warn('微信支付碼 URL 格式無效:', order.wechatQrCodeURL);
                }

                // 檢查支付寶二維碼
                if (isValidImageUrl(order.qrCodeURL)) {
                    images.push({
                        data: order.qrCodeURL,
                        name: '支付寶二維碼',
                        type: 'qrCode',
                        field: 'qrCodeURL'
                    });
                } else if (order.qrCodeURL) {
                    console.warn('支付寶二維碼 URL 格式無效:', order.qrCodeURL);
                }
                
                // 檢查淘寶圖片
                if (isValidImageUrl(order.taobaoImageURL)) {
                    images.push({
                        data: order.taobaoImageURL,
                        name: '淘寶訂單圖片',
                        type: 'taobao',
                        field: 'taobaoImageURL'
                    });
                } else if (order.taobaoImageURL) {
                    console.warn('淘寶圖片 URL 格式無效:', order.taobaoImageURL);
                }
                
                // 檢查阿里巴巴圖片
                if (isValidImageUrl(order.alibabaImageURL)) {
                    images.push({
                        data: order.alibabaImageURL,
                        name: '阿里巴巴訂單圖片',
                        type: 'alibaba',
                        field: 'alibabaImageURL'
                    });
                } else if (order.alibabaImageURL) {
                    console.warn('阿里巴巴圖片 URL 格式無效:', order.alibabaImageURL);
                }

                // 檢查其他平台圖片
                if (isValidImageUrl(order.othersImageURL)) {
                    images.push({
                        data: order.othersImageURL,
                        name: '其他平台圖片',
                        type: 'others',
                        field: 'othersImageURL'
                    });
                } else if (order.othersImageURL) {
                    console.warn('其他平台圖片 URL 格式無效:', order.othersImageURL);
                }
                
                // 檢查其他圖片
                if (order.images && Array.isArray(order.images)) {
                    order.images.forEach((image, index) => {
                        if (typeof image === 'string') {
                            if (isValidImageUrl(image)) {
                                images.push({
                                    data: image,
                                    name: '訂單圖片',
                                    type: 'other',
                                    field: 'images',
                                    index: index
                                });
                            } else {
                                console.warn(`訂單圖片 [${index}] URL 格式無效:`, image);
                            }
                        } else if (image && image.data) {
                            if (isValidImageUrl(image.data)) {
                                images.push({
                                    ...image,
                                    type: 'other',
                                    field: 'images',
                                    index: index
                                });
                            } else {
                                console.warn(`訂單圖片 [${index}] 數據 URL 格式無效:`, image.data);
                            }
                        }
                    });
                }

                // 先顯示模態框（立即響應）
                if (!document.getElementById('orderModal').classList.contains('show')) {
                    ModalManager.show('orderModal');
                }

                // 顯示其他平台資訊
                const {
                    othersInfoSection,
                    othersProductLinkItem, 
                    othersDescriptionItem,
                    othersProductLinkValue,
                    othersDescriptionValue
                } = DOMManager.getMultiple([
                    'othersInfoSection',
                    'othersProductLinkItem', 
                    'othersDescriptionItem',
                    'othersProductLinkValue',
                    'othersDescriptionValue'
                ]);
                
                let hasOthersInfo = false;
                
                // 檢查商品連結
                if (order.othersProductLink && order.othersProductLink.trim()) {
                    const cleanedLink = extractAndValidateURL(order.othersProductLink);
                    if (cleanedLink) {
                        othersProductLinkValue.href = cleanedLink;
                        othersProductLinkValue.textContent = order.othersProductLink; // 顯示原始文本
                        othersProductLinkValue.onclick = function(event) {
                            event.preventDefault();
                            event.stopPropagation();
                            // 安全打開連結
                            window.open(cleanedLink, '_blank', 'noopener,noreferrer');
                        };
                        ElementVisibility.show(othersProductLinkItem);
                        hasOthersInfo = true;
                    } else {
                        // 如果無法解析有效URL，顯示為文本
                        othersProductLinkValue.removeAttribute('href');
                    othersProductLinkValue.textContent = order.othersProductLink;
                        othersProductLinkValue.onclick = null;
                        othersProductLinkValue.style.color = 'var(--text-color)';
                        othersProductLinkValue.style.cursor = 'text';
                        ElementVisibility.show(othersProductLinkItem);
                    hasOthersInfo = true;
                    }
                } else {
                    ElementVisibility.hide(othersProductLinkItem);
                }
                
                // 檢查備註說明
                if (order.othersDescription && order.othersDescription.trim()) {
                    othersDescriptionValue.textContent = order.othersDescription;
                    ElementVisibility.show(othersDescriptionItem);
                    hasOthersInfo = true;
                } else {
                    ElementVisibility.hide(othersDescriptionItem);
                }
                
                // 顯示或隱藏整個其他平台資訊區域
                if (hasOthersInfo) {
                    ElementVisibility.show(othersInfoSection);
                } else {
                    ElementVisibility.hide(othersInfoSection);
                }

                // 根據訂單狀態顯示操作按鈕
                const {
                    orderActionsSection,
                    acceptOrderBtn,
                    completeOrderBtn
                } = DOMManager.getMultiple([
                    'orderActionsSection',
                    'acceptOrderBtn',
                    'completeOrderBtn'
                ]);
                
                // 使用訂單狀態管理器統一處理按鈕顯示邏輯
                OrderStatusManager.updateActionButtons(order.status, {
                    orderActionsSection,
                    acceptOrderBtn,
                    completeOrderBtn
                });

                // 異步載入圖片（不阻塞模態框顯示）
                if (images.length > 0) {
                    // 顯示載入狀態
                    modalImages.innerHTML = '<div class="loading-indicator">載入圖片中...</div>';
                    
                    // 使用非阻塞的圖片載入
                    setTimeout(async () => {
                        try {
                            await ImageManager.loadOrderImages(images, modalImages, orderId);
                        } catch (error) {
                            console.error('圖片載入失敗:', error);
                            modalImages.innerHTML = '<p class="modal-image-error">圖片載入失敗</p>';
                        }
                    }, 0);
                } else {
                    modalImages.innerHTML = '<p class="modal-no-images">無圖片</p>';
                }
            } catch (error) {
                console.error('Error updating order details display:', error);
            }
        }

        // 清理訂單模態框資源
        function cleanupOrderModalResources() {
            ErrorHandler.safeDom(() => {
                const modalImages = DOMManager.get('modalImages');
                if (modalImages) {
                    // 清理所有圖片的事件監聽器和資源
                    modalImages.querySelectorAll('img').forEach(img => {
                        img.onclick = img.onload = img.onerror = null;
                        img.src = '';
                        delete img.dataset.metadata;
                        delete img.dataset.sizeInfo;
                    });
                    modalImages.innerHTML = '';
                }
                
                // 關閉圖片預覽
                if (typeof ImagePreviewManager !== 'undefined') {
                    ImagePreviewManager.close();
                }
                
                // 開發環境垃圾回收提示
                if (typeof gc === 'function') gc();
            }, '清理訂單模態框資源');
        }

        // 關閉模態框
        function closeModal(modalId) {
            ModalManager.hide(modalId);
            if (modalId === 'orderModal') {
                currentOrderId = null; // 清除當前訂單ID
                
                // 清理訂單詳情監聽器
                if (orderDetailsListener) {
                    orderDetailsListener();
                    orderDetailsListener = null;
                }
                
                // 清理圖片資源和事件監聽器
                cleanupOrderModalResources();
            }
        }

        // 初始化所有模態框的關閉功能（異步）
        setTimeout(() => {
            // 為所有模態框添加關閉功能
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                const closeBtn = modal.querySelector('.close');
                if (closeBtn) {
                    closeBtn.onclick = function() {
                        ModalManager.hide(modal.id);
                    }
                }
            });

            // 點擊模態框外部不會關閉 - 只允許點擊 X 按鈕關閉
        }, 0);

        // 關閉設定模態框
        function closeSettingsModal() {
            closeModal('settingsModal');
            // 清空測試金額和結果
            document.getElementById('testAmount').value = '';
            document.getElementById('testResult').textContent = '-';
        }



        // 關閉時間選擇模態框
        function closeTimeSelectionModal() {
            closeModal('timeSelectionModal');
            currentOrderId = null;
        }

        // 關閉會員詳情模態框
        function closeMemberDetails() {
            closeModal('memberDetailsModal');
        }

        // 關閉編輯會員模態框
        function closeEditMemberModal() {
            closeModal('editMemberModal');
        }

        // 刪除會員功能
        async function deleteMember() {
            const phoneInput = document.getElementById('editMemberPhone');
            const statusInput = document.getElementById('editMemberStatus');
            
            if (!phoneInput || !statusInput) {
                alert('無法獲取會員資料');
                return;
            }

            const phone = phoneInput.value;
            const status = statusInput.value;

            // 雙重確認：只允許刪除未審核會員
            if (status !== 'pending') {
                alert('只能刪除未審核的會員');
                return;
            }

            // 使用自定義確認模態框
            const title = '正在刪除';
            const message = `${phone}`;
            
            showConfirmModal(title, message, async () => {
                try {
                    // 執行刪除操作
                    await db.collection('members').doc(phone).delete();
                    
                    // 顯示成功訊息
                    showSuccessToast(`會員 ${phone} 已成功刪除`);
                    
                    // 關閉編輯模態框
                    closeEditMemberModal();
                    
                    // 移除手動刷新，讓即時監聽器自動處理更新
    
                    
                } catch (error) {
                    console.error('刪除會員失敗:', error);
                    let errorMessage = '刪除會員失敗';
                    
                    if (error.code === 'permission-denied') {
                        errorMessage = '權限不足：無法刪除會員資料';
                    } else if (error.code === 'not-found') {
                        errorMessage = '會員不存在或已被刪除';
                    } else if (error.code === 'unavailable') {
                        errorMessage = '網路連線異常，請稍後再試';
                    } else if (error.message) {
                        errorMessage = `刪除失敗：${error.message}`;
                    } else {
                        errorMessage = '刪除會員失敗，請稍後再試';
                    }
                    
                    alert(errorMessage);
                }
            }, '是的', 'danger');
        }

        // 確認模態框管理
        let confirmCallback = null;

        function showConfirmModal(title, message, callback, buttonText = '確認', buttonStyle = 'primary') {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmButton').textContent = buttonText;
            
            // 設置按鈕樣式
            const confirmButton = document.getElementById('confirmButton');
            confirmButton.className = `confirm-btn confirm-btn-${buttonStyle}`;
            
            // 設置圖標樣式和內容
            const confirmIcon = document.querySelector('.confirm-icon');
            confirmIcon.className = `confirm-icon ${buttonStyle === 'danger' ? 'danger' : ''}`;
            
            // 根據類型設置圖標
            if (buttonStyle === 'danger') {
                confirmIcon.textContent = '🗑️';
            } else {
                confirmIcon.textContent = '⚠️';
            }
            
            confirmCallback = callback;
            ModalManager.show('confirmModal');
        }

        function closeConfirmModal() {
            ModalManager.hide('confirmModal');
            confirmCallback = null;
        }

        function confirmAction() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        }

        // 成功提示Toast
        function showSuccessToast(message) {
            // 創建Toast元素
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
                z-index: 9999;
                font-weight: 500;
                transition: all 0.3s ease;
                transform: translateX(100%);
                opacity: 0;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // 動畫顯示
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
                toast.style.opacity = '1';
            }, 100);
            
            // 3秒後自動消失
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                toast.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

            

        // 圖片預覽管理器 - 統一管理預覽功能，避免事件監聽器重複綁定
        // 使用立即執行函數避免全域污染，提供版本控制和衝突檢測
        const ImagePreviewManager = (function() {
            // 版本資訊和衝突檢測
            const version = '1.0.0';
            if (window.ImagePreviewManager) {
                console.warn('⚠️ ImagePreviewManager 已存在，可能存在版本衝突');
                console.info('現有版本:', window.ImagePreviewManager.version || 'unknown');
                console.info('新版本:', version);
            }
            
            return {
                version: version,
            isActive: false,
            keyHandlerBound: false,
            
            // 關閉圖片預覽
            close() {
                const preview = document.getElementById('imagePreview');
                const previewImage = document.getElementById('previewImage');
                
                if (preview && previewImage) {
                    preview.style.display = 'none';
                    previewImage.style.display = 'none';
                    
                    // 清理圖片資源
                    previewImage.onload = null;
                    previewImage.onerror = null;
                    previewImage.src = '';
                    
                    // 清理點擊事件
                    preview.onclick = null;
                    previewImage.onclick = null;
                    
                    // 移除事件監聽器
                    this.removeEventListeners();
                }
                
                this.isActive = false;
            },
            
            // 鍵盤事件處理器
            handleKeydown(event) {
                if (event.key === 'Escape' && ImagePreviewManager.isActive) {
                    ImagePreviewManager.close();
                }
            },
            
            // 添加事件監聽器（防重複）
            addEventListeners() {
                if (!this.keyHandlerBound) {
                    document.addEventListener('keydown', this.handleKeydown);
                    this.keyHandlerBound = true;
                }
            },
            
            // 移除事件監聽器
            removeEventListeners() {
                if (this.keyHandlerBound) {
                    document.removeEventListener('keydown', this.handleKeydown);
                    this.keyHandlerBound = false;
                }
            },
            
            // 設置預覽狀態
            setActive(active) {
                this.isActive = active;
                if (active) {
                    this.addEventListeners();
                } else {
                    this.removeEventListeners();
                }
            }
        };
        })(); // 立即執行函數結束

        // 設置全域引用以供其他模組使用
        window.ImagePreviewManager = ImagePreviewManager;

        // 向後兼容的函數包裝器
        function closeImagePreview() {
            ImagePreviewManager.close();
        }



        // 提取和驗證URL的輔助函數
        function extractAndValidateURL(text) {
            if (!text || typeof text !== 'string') {
                return null;
            }
            
            try {
                // 清理輸入文本，移除前後空白
                const cleanText = text.trim();
                
                // 使用簡化但有效的URL提取策略
                const urlRegexes = [
                    // 淘寶連結（優先級最高）
                    /https?:\/\/(?:m\.)?tb\.cn\/[hH]\.\w+(?:\?[^\s]*)?/gi,
                    /(?:m\.)?tb\.cn\/[hH]\.\w+(?:\?[^\s]*)?/gi,
                    // 通用HTTP連結
                    /https?:\/\/[^\s]+/gi,
                    // 其他短連結
                    /(?:t\.cn|dwz\.cn|suo\.im)\/[^\s]+/gi
                ];
                
                for (let i = 0; i < urlRegexes.length; i++) {
                    const regex = urlRegexes[i];
                    const matches = cleanText.match(regex);
                    
                    if (matches && matches.length > 0) {
                        let url = matches[0].trim();
                        
                        // 清理URL尾部的標點符號
                        url = url.replace(/[，。！？；：""''（）【】「」\s]+$/, '');
                        
                        // 如果沒有協議，添加 https
                        if (!url.startsWith('http://') && !url.startsWith('https://')) {
                            url = 'https://' + url;
                        }
                        
                        // 驗證URL格式
                        try {
                            const urlObj = new URL(url);
                            if (urlObj.protocol === 'http:' || urlObj.protocol === 'https:') {
                                return url;
                            }
                        } catch (urlError) {
                            console.warn('❌ URL格式驗證失敗:', url, urlError.message);
                            continue;
                        }
                    }
                }
                
                // 如果所有策略都失敗
                console.warn('⚠️ 無法提取有效URL:', {
                    原文: text.substring(0, 100) + (text.length > 100 ? '...' : ''),
                    文本長度: text.length,
                    包含http: text.includes('http'),
                    包含tb: text.includes('tb.cn')
                });
                return null;
                
            } catch (error) {
                console.error('❌ URL解析錯誤:', error.message);
                return null;
            }
        }

        // 獲取支付類型名稱
        function getPaymentTypeName(type) {
            const types = {
                'alipay': '支付寶',
                'taobao': '淘寶',
                'alibaba': '阿里巴巴'
            };
            return types[type] || type;
        }

        // 獲取狀態名稱
        function getStatusName(status) {
            const statuses = {
                'pending': '待處理',
                'processing': '處理中',
                'completed': '完成'
            };
            return statuses[status] || status;
        }

        // 顯示設定模態框
        async function showSettingsModal() {
            ModalManager.show('settingsModal');
            
            try {
                // 使用統一緩存系統獲取設定
                const settingsResult = await FirebaseCache.getDoc('settings', 'procurement');
                const settings = settingsResult.exists ? settingsResult.data : {};

                document.getElementById('purchaseCost').value = settings.purchaseCost || '';
                document.getElementById('tenThousandDiscount').value = settings.tenThousandDiscount || '';
                document.getElementById('fiftyThousandDiscount').value = settings.fiftyThousandDiscount || '';
                document.getElementById('negotiableDiscount').value = settings.negotiableDiscount || '';
                document.getElementById('testAmount').value = '';
                document.getElementById('testResult').textContent = '-';

                // 使用 EventManager 避免重複綁定事件
                const inputs = ['purchaseCost', 'tenThousandDiscount', 'fiftyThousandDiscount', 'negotiableDiscount'];
                inputs.forEach(id => {
                    EventManager.addListener(id, 'paste', handlePaste);
                    EventManager.addListener(id, 'input', validateInput);
                    EventManager.addListener(id, 'focus', function() {
                        this.select();
                    });
                });

                // 綁定金額試算輸入框事件
                EventManager.addListener('testAmount', 'focus', function() {
                    this.select();
                });
            } catch (error) {
                await AsyncErrorHandler.handleError(error, '載入設定');
            }
        }

        // 保存設定
        async function saveSettings() {
            try {
                // 收集表單數據
                const formData = {
                    purchaseCost: document.getElementById('purchaseCost').value,
                    tenThousandDiscount: document.getElementById('tenThousandDiscount').value,
                    fiftyThousandDiscount: document.getElementById('fiftyThousandDiscount').value,
                    negotiableDiscount: document.getElementById('negotiableDiscount').value
                };
                
                // 定義驗證規則
                const validationSchema = {
                    purchaseCost: [{
                        type: DataValidator.ValidationRules.POSITIVE_NUMBER,
                        options: { maxDecimals: 4, required: true }
                    }],
                    tenThousandDiscount: [{
                        type: DataValidator.ValidationRules.POSITIVE_NUMBER,
                        options: { maxDecimals: 4, required: true }
                    }],
                    fiftyThousandDiscount: [{
                        type: DataValidator.ValidationRules.POSITIVE_NUMBER,
                        options: { maxDecimals: 4, required: true }
                    }],
                    negotiableDiscount: [{
                        type: DataValidator.ValidationRules.POSITIVE_NUMBER,
                        options: { maxDecimals: 4, required: true }
                    }]
                };
                
                // 執行驗證
                const validation = DataValidator.validateBatch(formData, validationSchema);
                
                if (!validation.valid) {
                    // 顯示第一個錯誤
                    const firstError = Object.values(validation.errors)[0];
                    alert(firstError);
                    return;
                }
                
                // 使用驗證後的數據
                const settings = validation.data;
                
                // 使用與 index.html 一致的集合名稱
                await db.collection('settings').doc('procurement').set(settings);
                
                // 清除設定快取，確保下次讀取最新設定
                FirebaseCache.clearCollection('settings');
                clearSettingsCache();
                
                closeSettingsModal();
            } catch (error) {
                await AsyncErrorHandler.handleError(error, '保存設定');
            }
        }



        // ===== 全域錯誤處理器 =====
        window.addEventListener('unhandledrejection', function(event) {
            console.error('未處理的 Promise 拒絕:', event.reason);
            
            // 特別處理 Firebase 錯誤
            if (event.reason && event.reason.code) {
                console.warn('Firebase 錯誤已被捕獲:', event.reason.code, event.reason.message);
            }
            
            // 防止預設的控制台錯誤顯示
            event.preventDefault();
        });

        window.addEventListener('error', function(event) {
            // 特別處理圖片相關錯誤
            if (event.message && event.message.includes('appendChild')) {
                console.warn('DOM 操作錯誤已被捕獲:', event.message);
                // 防止錯誤中斷程序執行
                event.preventDefault();
            }
            
            // 特別處理 Firebase 相關錯誤
            if (event.message && (event.message.includes('firebase') || event.message.includes('firestore'))) {
                console.warn('Firebase 錯誤已被捕獲:', event.message);
                event.preventDefault();
            }
        });

        // ===== Firebase 連接狀態檢查 =====
        function checkFirebaseConnection() {
            try {
                if (!window.firebase) {
                    console.error('Firebase SDK 未載入');
                    return false;
                }
                
                if (!db) {
                    console.error('Firestore 資料庫未初始化');
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('Firebase 連接檢查失敗:', error);
                return false;
            }
        }

        // ===== 統一模態框管理系統 =====
        const ModalManager = {
            currentModal: null,
            
            show(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('show');
                    modal.style.display = 'flex';
                    this.currentModal = modalId;
                    
                    // 防止背景滾動
                    document.body.style.overflow = 'hidden';
                    
                    // 移除所有點擊背景關閉的功能，只能透過X按鈕關閉
                    modal.onclick = (e) => {
                        // 阻止所有點擊事件，確保不會意外關閉
                        e.stopPropagation();
                    };
                    
                    // 為模態框內容添加點擊事件，防止內容區域的點擊關閉模態框
                    const modalContent = modal.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.onclick = (e) => {
                            e.stopPropagation();
                        };
                    }
                }
            },
            
            hide(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                    this.currentModal = null;
                    
                    // 恢復背景滾動
                    document.body.style.overflow = '';
                    // 移除點擊事件
                    modal.onclick = null;
                }
            },
            
            hideAll() {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                    modal.onclick = null;
                });
                this.currentModal = null;
                document.body.style.overflow = '';
            }
        };

        // ESC鍵關閉功能已移除，所有模態框只能透過X按鈕關閉

        // 開啟台銀匯率小視窗
        function openBankRateWindow() {
            const width = 800, height = 600;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            window.open(
                "https://rate.bot.com.tw/xrt?Lang=zh-TW",
                "bankRateWindow",
                `width=${width},height=${height},top=${top},left=${left},scrollbars=yes,resizable=yes,menubar=no,toolbar=no,status=no,noopener=yes,noreferrer=yes`
            );
        }



        // ===== 匯率計算模組全局變量 =====
        // 防抖計時器（避免頻繁計算）
        let calculateRatesTimeout;
        function calculateRates() {
            // 防抖處理
            clearTimeout(calculateRatesTimeout);
            calculateRatesTimeout = setTimeout(() => {
                const buyRateEl = document.getElementById("buyRate");
                const sellRateEl = document.getElementById("sellRate");
                const midRateDisplay = document.getElementById("midRateDisplay");

                // 元素存在性檢查
                if (!buyRateEl || !sellRateEl || !midRateDisplay) {
                    console.error('匯率計算器DOM元素未找到');
                    return;
                }

                const buyRate = parseFloat(buyRateEl.value) || 0;
                const sellRate = parseFloat(sellRateEl.value) || 0;

                // 輸入驗證
                if (buyRate < 0 || sellRate < 0) {
                    midRateDisplay.textContent = "匯率不能為負數";
                    return;
                }

                if (buyRate > 1000 || sellRate > 1000) {
                    midRateDisplay.textContent = "匯率數值過大，請檢查輸入";
                    return;
                }

                // 計算並顯示中價
                if (buyRate > 0 && sellRate > 0) {
                    const midRate = (buyRate + sellRate) / 2;
                    midRateDisplay.textContent = `中價：${midRate.toFixed(4)}`;

                    // 計算不同等級的採購成本
                    const basePrice = Math.ceil((midRate + 0.05) * 10000) / 10000;
                    const tenKPrice = Math.ceil((midRate + 0.03) * 10000) / 10000;
                    const fiftyKPrice = Math.ceil((midRate + 0.015) * 10000) / 10000;
                    const negotiablePrice = Math.ceil((midRate + 0.01) * 10000) / 10000;

                    // 直接套用到對應欄位
                    const purchaseCostEl = document.getElementById('purchaseCost');
                    const tenThousandDiscountEl = document.getElementById('tenThousandDiscount');
                    const fiftyThousandDiscountEl = document.getElementById('fiftyThousandDiscount');
                    const negotiableDiscountEl = document.getElementById('negotiableDiscount');

                    if (purchaseCostEl) purchaseCostEl.value = basePrice.toFixed(4);
                    if (tenThousandDiscountEl) tenThousandDiscountEl.value = tenKPrice.toFixed(4);
                    if (fiftyThousandDiscountEl) fiftyThousandDiscountEl.value = fiftyKPrice.toFixed(4);
                    if (negotiableDiscountEl) negotiableDiscountEl.value = negotiablePrice.toFixed(4);
                    
                    // 觸發測試計算以更新預覽
                    calculateTest();
                } else {
                    midRateDisplay.textContent = "";
                    
                    // 清空成本欄位
                    const costFields = ['purchaseCost', 'tenThousandDiscount', 'fiftyThousandDiscount', 'negotiableDiscount'];
                    costFields.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) field.value = "";
                    });
                }
            }, 100); // 100ms 防抖延遲
        }

        // 處理匯率貼上事件
        function handleRatePaste(event) {
            event.preventDefault();
            const pastedText = (event.clipboardData || window.clipboardData).getData('text');
            const values = pastedText.trim().split(/\s+|\t/);
            
            if (values.length >= 2) {
                document.getElementById("buyRate").value = values[0];
                document.getElementById("sellRate").value = values[1];
                calculateRates();
            } else if (values.length === 1) {
                event.target.value = values[0];
                calculateRates();
            }
        }

        // 清空匯率輸入欄位
        function clearRateInput(input) {
            input.value = "";
            calculateRates();
        }







        // 計算測試金額（用於設定模態框）
        async function calculateTest() {
            const testAmount = parseFloat(document.getElementById('testAmount').value) || 0;
            
            try {
                // 使用快取的設定
                const settings = await getSettings();
                
                if (testAmount <= 0) {
                    document.getElementById('testResult').textContent = '-';
                                return;
                            }
                
                let finalAmount = 0;
                let type = '';
                
                // 修正計算邏輯：金額 × 採購成本設定值
                if (testAmount >= 50000) {
                    finalAmount = testAmount * (settings.fiftyThousandDiscount || 0);
                    type = '五萬優惠';
                } else if (testAmount >= 10000) {
                    finalAmount = testAmount * (settings.tenThousandDiscount || 0);
                    type = '滿萬優惠';
                        } else {
                    finalAmount = testAmount * (settings.purchaseCost || 0);
                    type = '基礎成本';
                }
                
                // 四捨五入到整數
                finalAmount = Math.round(finalAmount);
                
                document.getElementById('testResult').textContent = `${type}：${finalAmount}`;
            } catch (error) {
                console.error('Error calculating test:', error);
                document.getElementById('testResult').textContent = '計算失敗';
            }
        }

        // 獲取會員等級對應的匯率
        async function getMemberExchangeRate(amount, memberLevel = 'basic') {
            try {
                const settings = await getSettings();
                
                switch(memberLevel) {
                    case 'fiftyThousand':
                        // 五萬會員直接使用五萬優惠匯率
                        return (settings.fiftyThousandDiscount || 0).toFixed(1);
                    case 'tenThousand':
                        // 滿萬會員：達到五萬門檻使用五萬優惠，否則使用滿萬優惠
                        if (amount >= 50000) {
                            return (settings.fiftyThousandDiscount || 0).toFixed(1);
                        } else {
                            return (settings.tenThousandDiscount || 0).toFixed(1);
                        }
                    case 'negotiable':
                        // 議價會員使用設定中的議價優惠
                        return (settings.negotiableDiscount || 0).toFixed(1);
                    case 'basic':
                    default:
                        // 基礎會員：達到滿萬門檻使用滿萬優惠，達到五萬門檻使用五萬優惠
                        if (amount >= 50000) {
                            return (settings.fiftyThousandDiscount || 0).toFixed(1);
                        } else if (amount >= 10000) {
                            return (settings.tenThousandDiscount || 0).toFixed(1);
                        } else {
                            return (settings.purchaseCost || 0).toFixed(1);
                        }
                }
            } catch (error) {
                console.error('Error getting member exchange rate:', error);
                return '0.0';
            }
        }

        // 計算最終金額
        async function calculateFinalAmount(amount, memberLevel = 'basic', memberData = null) {
            try {
                // 使用快取的設定
                const settings = await getSettings();
                
                let finalAmount = 0;
                
                switch(memberLevel) {
                    case 'fiftyThousand':
                        // 五萬會員直接使用五萬優惠
                        finalAmount = amount * (settings.fiftyThousandDiscount || 0);
                        break;
                    case 'tenThousand':
                        // 滿萬會員：達到五萬門檻使用五萬優惠，否則使用滿萬優惠
                        if (amount >= 50000) {
                            finalAmount = amount * (settings.fiftyThousandDiscount || 0);
                        } else {
                            finalAmount = amount * (settings.tenThousandDiscount || 0);
                        }
                        break;
                    case 'negotiable':
                        // 議價會員使用設定中的議價優惠
                        finalAmount = amount * (settings.negotiableDiscount || 0);
                        break;
                    case 'basic':
                    default:
                        // 基礎會員：達到滿萬門檻使用滿萬優惠，達到五萬門檻使用五萬優惠
                        if (amount >= 50000) {
                            finalAmount = amount * (settings.fiftyThousandDiscount || 0);
                        } else if (amount >= 10000) {
                            finalAmount = amount * (settings.tenThousandDiscount || 0);
                        } else {
                            finalAmount = amount * (settings.purchaseCost || 0);
                        }
                        break;
                }

                // 四捨五入到整數
                return Math.round(finalAmount);
            } catch (error) {
                console.error('Error calculating final amount:', error);
                return Math.round(amount);
            }
        }

        // ===== 後台管理系統：訂單自動狀態轉換邏輯 =====
        // 使用命名空間避免全局變量衝突
        const AdminAutoProcessor = {
            timer: null,
            isRunning: false
        };

        // 啟動訂單自動狀態檢查（系統級邏輯，獨立於登錄狀態）
        function startOrderAutoStatusCheck() {
            // 防止重複啟動
            if (AdminAutoProcessor.isRunning) {

                return;
            }
            
            // 清除現有的計時器
            stopOrderAutoStatusCheck();
            

            AdminAutoProcessor.isRunning = true;
            
            // 立即執行一次檢查
            checkAndUpdateOrderStatuses();
            
            // 每30秒自動檢查一次訂單狀態
            AdminAutoProcessor.timer = setInterval(async () => {
                try {
                    await checkAndUpdateOrderStatuses();
                } catch (error) {
                    console.error('❌ 系統訂單狀態檢查失敗:', error);
                    
                    // 如果是權限問題，不停止檢查（可能是暫時的網路問題）
                    if (error.code === 'permission-denied') {
                        console.warn('⚠️ 權限錯誤，但繼續嘗試檢查（可能是暫時問題）');
                    }
                    
                    // 如果是網路問題，延長下次檢查間隔
                    if (error.code === 'unavailable') {
                        console.warn('⚠️ 網路不可用，將在下次間隔後重試');
                    }
                    
                    // 持續運行，不停止檢查
                }
            }, 30000); // 30秒檢查一次
        }

        // 停止訂單自動狀態檢查
        function stopOrderAutoStatusCheck() {
            if (AdminAutoProcessor.timer) {
                clearInterval(AdminAutoProcessor.timer);
                AdminAutoProcessor.timer = null;
                AdminAutoProcessor.isRunning = false;
    
            }
        }

        // 檢查並自動更新訂單狀態（後台管理核心邏輯）
        async function checkAndUpdateOrderStatuses() {
            try {
                const now = new Date();
                
                // 獲取自動狀態轉換設置
                const autoProcessingSeconds = 30; // 固定30秒，避免依賴已移除的設定
                
                // 只查詢待處理的訂單以提升效能
                const pendingOrdersSnapshot = await db.collection('orders')
                    .where('status', '==', 'pending')
                    .get();
                
                if (pendingOrdersSnapshot.empty) {
                    return; // 沒有待處理訂單，直接返回
                }
                
                const batch = db.batch();
                let batchCount = 0;
                let updatedCount = 0;
                
                pendingOrdersSnapshot.docs.forEach(doc => {
                    const order = doc.data();
                    const createdAt = new Date(order.createdAt);
                    const timeDiffSeconds = (now - createdAt) / 1000;
                    
                    // 檢查是否需要從待處理轉為處理中
                    if (timeDiffSeconds >= autoProcessingSeconds) {
                        
                        
                        // 準備更新數據
                        const updateData = {
                            status: 'processing',
                            lastUpdated: now.toISOString(),
                            statusHistory: firebase.firestore.FieldValue.arrayUnion({
                                status: 'processing',
                                timestamp: now.toISOString(),
                                updatedBy: 'system-auto',
                                note: `系統自動轉為處理中（${autoProcessingSeconds}秒後）`
                            })
                        };
                        
                        // 添加到批次更新
                        const orderRef = db.collection('orders').doc(doc.id);
                        batch.update(orderRef, updateData);
                        
                        batchCount++;
                        updatedCount++;
                        
                        // Firebase 批次限制為 500 個操作
                        if (batchCount >= 500) {
                            return; // 超過限制，停止添加
                        }
                    }
                });
                
                // 執行批次更新
                if (batchCount > 0) {
                    await batch.commit();
    
                    
                    // 顯示成功提示（僅在有更新且有管理員登錄時）
                    if (updatedCount > 0 && isAuthenticated) {
                        showSuccessToast(`系統自動處理 ${updatedCount} 個訂單：待處理 → 處理中`);
                    }
                }
                
            } catch (error) {
                console.error('❌ 系統訂單狀態檢查失敗:', error);
                
                // 錯誤處理（不影響系統持續運行）
                if (error.code === 'permission-denied') {
                    console.warn('⚠️ 權限不足：無法更新訂單狀態（可能是暫時問題）');
                } else if (error.code === 'unavailable') {
                    console.warn('⚠️ 網路連線異常，跳過本次檢查');
                } else {
                    console.warn('⚠️ 系統檢查遇到問題:', error.message);
                }
            }
        }

        // 驗證輸入值
        function validateInput(event) {
            const value = parseFloat(event.target.value);
            
            // 檢查是否為有效數字且大於零
            if (isNaN(value) || value <= 0) {
                event.target.value = '';
                alert('請輸入大於零的數值');
                            return;
                        }
            
            // 檢查小數位數是否超過四位
            const decimalPart = event.target.value.split('.')[1];
            if (decimalPart && decimalPart.length > 4) {
                event.target.value = value.toFixed(4);
                alert('小數位數最多四位');
            }
            
            // 當任何設定值改變時，重新計算測試金額
            calculateTest();
        }

        // 處理貼上事件
        function handlePaste(event) {
            event.preventDefault();
            const pastedText = (event.clipboardData || window.clipboardData).getData('text');
            
            // 解析貼上的文本
            const lines = pastedText.split('\n');
            const values = {};
            
            lines.forEach(line => {
                const match = line.match(/([^：:]+)[：:]\s*([\d.]+)/);
                if (match) {
                    const key = match[1].trim();
                    const value = parseFloat(match[2]);
                    
                    if (!isNaN(value) && value > 0) {
                        if (key.includes('基礎成本')) {
                            values.purchaseCost = value;
                        } else if (key.includes('滿萬優惠')) {
                            values.tenThousandDiscount = value;
                        } else if (key.includes('五萬優惠')) {
                            values.fiftyThousandDiscount = value;
                        } else if (key.includes('議價優惠')) {
                            values.negotiableDiscount = value;
                        }
                    }
                }
            });
            
            // 更新輸入框的值
            if (values.purchaseCost) {
                document.getElementById('purchaseCost').value = values.purchaseCost;
            }
            if (values.tenThousandDiscount) {
                document.getElementById('tenThousandDiscount').value = values.tenThousandDiscount;
            }
            if (values.fiftyThousandDiscount) {
                document.getElementById('fiftyThousandDiscount').value = values.fiftyThousandDiscount;
            }
            if (values.negotiableDiscount) {
                document.getElementById('negotiableDiscount').value = values.negotiableDiscount;
            }
            
            // 觸發計算
            calculateTest();
        }



        // 完成當前訂單
        async function completeCurrentOrder() {
            if (!currentOrderId) {
                alert('無法確定訂單ID');
                return;
            }
            
            try {
                // 獲取當前訂單狀態
                const orderDoc = await db.collection('orders').doc(currentOrderId).get();
                if (!orderDoc.exists) {
                    alert('訂單不存在');
                    return;
                }
                
                const currentOrder = orderDoc.data();
                let confirmTitle = '是否要完成此訂單';
                let confirmMessage = '完成後將無法修改';
                
                // 如果是待處理狀態，提醒用戶會跳過接收步驟
                if (currentOrder.status === 'pending') {
                    confirmTitle = '是否要直接完成此訂單';
                    confirmMessage = '此訂單尚未接收，將自動跳過設定預計完成時間的步驟\n完成後將無法修改';
                }
                
                // 顯示美觀的確認對話框
                showConfirmModal(confirmTitle, confirmMessage, async () => {
                    try {
                        const updateData = {
                            status: 'completed',
                            completedAt: new Date().toISOString(),
                            lastUpdated: new Date().toISOString() // 添加最後更新時間戳
                        };
                        
                        // 如果是從待處理直接完成，設定預計完成時間為當前時間
                        if (currentOrder.status === 'pending') {
                            updateData.expectedCompletionTime = new Date().toISOString();
                        }
                        
                        await db.collection('orders').doc(currentOrderId).update(updateData);
                        
                        // 顯示成功提示
                        showSuccessToast('訂單已完成！');
                        
                        // 訂單列表和詳情都會通過實時監聽自動更新
                        
                    } catch (error) {
                        console.error('Error completing order:', error);
                        alert('完成訂單時發生錯誤');
                    }
                }, '完成');
                
            } catch (error) {
                console.error('Error loading order for completion:', error);
                alert('載入訂單資料失敗');
            }
        }

        // 顯示當前訂單的時間選擇
        async function showTimeSelectionForCurrentOrder() {
            try {
                if (!currentOrderId) {
                    alert('無法確定訂單ID');
                    return;
                }
                
                // 關閉訂單詳情模態框
                ModalManager.hide('orderModal');
                
                // 顯示時間選擇模態框
                await showTimeSelectionModal(currentOrderId);
            } catch (error) {
                console.error('顯示時間選擇模態框失敗:', error);
                alert('顯示時間選擇視窗失敗，請重試。');
            }
        }

        // 顯示時間選擇模態框（用於人工介入）
        async function showTimeSelectionModal(orderId) {
            try {
                // 輸入驗證
                if (!orderId) {
                    console.error('showTimeSelectionModal: 缺少訂單ID');
                    alert('錯誤：缺少訂單ID');
                    return;
                }

                // 檢查 Firebase 連接
                if (!db) {
                    console.error('showTimeSelectionModal: Firebase 資料庫未初始化');
                    alert('錯誤：資料庫連接失敗');
                    return;
                }

                currentOrderId = orderId;
                
                // 使用 async/await 替代 then/catch
                const docSnapshot = await db.collection('orders').doc(orderId).get();
                
                if (!docSnapshot.exists) {
                    console.error('Order not found in Firestore:', orderId);
                    alert('找不到訂單資料。訂單可能已被刪除或不存在。');
                    return;
                }

                const order = docSnapshot.data();
                
                // 檢查訂單數據完整性
                if (!order) {
                    console.error('Order data is empty:', orderId);
                    alert('訂單資料為空，請重新載入。');
                    return;
                }

                // 顯示模態框
                ModalManager.show('timeSelectionModal');
                
                // 確保 DOM 元素存在
                const expectedDateElement = document.getElementById('expectedDate');
                const expectedTimeElement = document.getElementById('expectedTime');
                
                if (!expectedDateElement || !expectedTimeElement) {
                    console.error('時間選擇元素未找到');
                    alert('頁面元素載入錯誤，請重新整理頁面。');
                    ModalManager.hide('timeSelectionModal');
                    return;
                }

                // 初始化顯示狀態
                updateDateTimeDisplay();
                
                // 綁定事件監聽器（移除舊的監聽器避免重複）
                expectedDateElement.removeEventListener('change', updateDateTimeDisplay);
                expectedTimeElement.removeEventListener('change', updateDateTimeDisplay);
                expectedDateElement.addEventListener('change', updateDateTimeDisplay);
                expectedTimeElement.addEventListener('change', updateDateTimeDisplay);

                try {
                    // 初始化日期選擇器（加入錯誤處理）
                    const datePicker = createSafeFlatpickr("#expectedDate", {
                        locale: "zh_tw",
                        dateFormat: "Y-m-d",
                        minDate: "today",
                        disableMobile: "true",
                        onChange: function(selectedDates, dateStr, instance) {
                            setTimeout(updateDateTimeDisplay, 50);
                        }
                    });

                    // 初始化時間選擇器（加入錯誤處理）
                    const timePicker = createSafeFlatpickr("#expectedTime", {
                        locale: "zh_tw",
                        enableTime: true,
                        noCalendar: true,
                        dateFormat: "H:i",
                        time_24hr: true,
                        disableMobile: "true",
                        onChange: function(selectedDates, dateStr, instance) {
                            setTimeout(updateDateTimeDisplay, 50);
                        }
                    });
                    
                    // 檢查 flatpickr 是否成功初始化
                    if (!datePicker && !timePicker) {
                        console.warn('Flatpickr 初始化失敗，使用原生 input');
                        // 備用方案：設置 input type
                        expectedDateElement.type = 'date';
                        expectedTimeElement.type = 'time';
                    }
                    
                    // 如果有已設定的時間，則顯示該時間
                    if (order.expectedCompletionTime) {
                        try {
                            const expectedTime = new Date(order.expectedCompletionTime);
                            
                            if (datePicker) {
                                datePicker.setDate(expectedTime);
                            } else {
                                expectedDateElement.value = expectedTime.toISOString().split('T')[0];
                            }
                            
                            if (timePicker) {
                                timePicker.setDate(expectedTime);
                            } else {
                                expectedTimeElement.value = expectedTime.toTimeString().slice(0, 5);
                            }
                            
                            // 更新顯示
                            setTimeout(updateDateTimeDisplay, 100);
                        } catch (timeError) {
                            console.warn('設置現有時間失敗:', timeError);
                            // 繼續使用預設值
                        }
                    } else {
                        // 設定預設值為3天後
                        const threeDaysLater = new Date();
                        threeDaysLater.setDate(threeDaysLater.getDate() + 3);
                        
                        if (datePicker) {
                            datePicker.setDate(threeDaysLater);
                            if (timePicker) {
                                timePicker.setDate("09:00");
                            }
                        } else {
                            expectedDateElement.value = threeDaysLater.toISOString().split('T')[0];
                            expectedTimeElement.value = "09:00";
                        }
                        
                        // 更新顯示
                        setTimeout(updateDateTimeDisplay, 100);
                    }
                    
                } catch (pickerError) {
                    console.error('時間選擇器初始化錯誤:', pickerError);
                    alert('時間選擇器載入失敗，請使用手動輸入。');
                }
                
            } catch (error) {
                console.error('Error fetching order for time selection modal:', error);
                
                // 詳細錯誤信息
                let errorMessage = '載入訂單資料時發生錯誤：';
                
                if (error.code === 'permission-denied') {
                    errorMessage += '權限不足，請檢查登錄狀態。';
                } else if (error.code === 'unavailable') {
                    errorMessage += '網路連接異常，請檢查網路狀態後重試。';
                } else if (error.code === 'not-found') {
                    errorMessage += '訂單不存在或已被刪除。';
                } else if (error.message) {
                    errorMessage += error.message;
                } else {
                    errorMessage += '未知錯誤，請稍後重試。';
                }
                
                console.error('詳細錯誤信息:', {
                    orderId: orderId,
                    error: error,
                    code: error.code,
                    message: error.message
                });
                
                alert(errorMessage);
            }
        }

        // 更新時間選擇顯示
        function updateDateTimeDisplay() {
            const dateInput = document.getElementById('expectedDate');
            const timeInput = document.getElementById('expectedTime');
            const displayElement = document.getElementById('selectedDateTimeDisplay');
            const displayValue = displayElement.querySelector('.display-value');
            
            if (!dateInput || !timeInput || !displayElement || !displayValue) {
                return;
            }
            
            const dateValue = dateInput.value;
            const timeValue = timeInput.value;
            
            if (dateValue && timeValue) {
                // 格式化顯示日期時間
                try {
                    const dateTime = new Date(`${dateValue}T${timeValue}`);
                    const formattedDate = dateTime.toLocaleDateString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                    const formattedTime = dateTime.toLocaleTimeString('zh-TW', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                    
                    displayValue.textContent = `${formattedDate} ${formattedTime}`;
                    displayElement.classList.add('has-value');
                    
                    // 啟用確認按鈕
                    const confirmBtn = document.querySelector('.btn-confirm');
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('日期時間格式錯誤:', error);
                    displayValue.textContent = '請選擇日期和時間';
                    displayElement.classList.remove('has-value');
                }
            } else if (dateValue || timeValue) {
                // 部分選擇
                const partial = [];
                if (dateValue) partial.push(`日期: ${dateValue}`);
                if (timeValue) partial.push(`時間: ${timeValue}`);
                displayValue.textContent = partial.join(', ');
                displayElement.classList.remove('has-value');
                
                // 禁用確認按鈕
                const confirmBtn = document.querySelector('.btn-confirm');
                if (confirmBtn) {
                    confirmBtn.disabled = true;
                }
            } else {
                // 清空狀態
                displayValue.textContent = '請選擇日期和時間';
                displayElement.classList.remove('has-value');
                
                // 禁用確認按鈕
                const confirmBtn = document.querySelector('.btn-confirm');
                if (confirmBtn) {
                    confirmBtn.disabled = true;
                }
            }
        }

        // 提交預計完成時間
        async function submitExpectedTime() {
            const date = document.getElementById('expectedDate').value;
            const time = document.getElementById('expectedTime').value;
            
            if (!date || !time) {
                alert('請填寫完整的日期和時間');
                return;
            }

            const expectedDateTime = new Date(`${date}T${time}`);
            
            // 檢查時間是否為未來時間
            const now = new Date();
            if (expectedDateTime <= now) {
                alert('預計完成時間必須為未來時間');
                return;
            }
            
            try {
                await db.collection('orders').doc(currentOrderId).update({
                    status: 'processing',
                    expectedCompletionTime: expectedDateTime.toISOString(),
                    lastUpdated: new Date().toISOString() // 添加最後更新時間戳
                });
                
                // 訂單列表會通過實時監聽自動更新
                
                // 關閉時間選擇模態框
                closeTimeSelectionModal();
                
                // 顯示成功訊息
                alert('訂單已成功接收！');
                
                // 重新顯示訂單詳情模態框（狀態會通過實時監聽自動更新）
                if (currentOrderId) {
                    setTimeout(() => {
                        showOrderDetails(currentOrderId);
                    }, 100);
                }
            } catch (error) {
                console.error('Error updating expected time:', error);
                alert('更新預計完成時間失敗');
            }
        }

        // 監聽會員資料更新事件
        window.addEventListener('memberDataUpdated', function(e) {
            const { phone, level, expiry } = e.detail;
            // 更新當前頁面的會員資料顯示
            const memberLevelElement = document.getElementById('memberLevel');
            if (memberLevelElement) {
                memberLevelElement.textContent = `【${getMemberLevelName(level)}】`;
            }
        });

        // 獲取會員等級名稱
        function getMemberLevelName(level) {
            const levels = {
                'basic': '基礎會員',
                'tenThousand': '滿萬會員',
                'fiftyThousand': '五萬會員',
                'negotiable': '議價會員'
            };
            return levels[level] || level;
        }

        let currentOrderId = null;
        let orderDetailsListener = null; // 訂單詳情實時監聽器

        // 統一監聽管理器
        class ListManagerSystem {
            constructor() {
                this.listeners = new Map(); // 存儲所有監聽器
                this.searchStates = new Map(); // 存儲搜索狀態
                this.renderFunctions = new Map(); // 存儲渲染函數
                this.domConfigs = new Map(); // 存儲DOM配置
                this.lastOrderStatus = 'all'; // 追蹤訂單狀態篩選
                
            }

            // 註冊列表管理配置
            registerList(listId, config) {
                this.domConfigs.set(listId, {
                    listElement: config.listElementId,
                    filterElement: config.filterElementId,
                    collection: config.collection,
                    primaryOrderBy: config.primaryOrderBy,
                    fallbackOrderBy: config.fallbackOrderBy,
                    emptyMessage: config.emptyMessage || '暫無資料',
                    loadingMessage: config.loadingMessage || '載入中...',
                    errorMessage: config.errorMessage || '載入失敗，請稍後重試',
                    columns: config.columns || 7
                });
                
                this.renderFunctions.set(listId, config.renderFunction);
                this.searchStates.set(listId, '');
                
            }

            // 統一的DOM檢查
            checkDomReady(listId) {
                const config = this.domConfigs.get(listId);
                if (!config) return false;

                const listElement = document.getElementById(config.listElement);
                const filterElement = config.filterElement ? document.getElementById(config.filterElement) : true;

                const isReady = !!(listElement && filterElement);
                
                if (!isReady) {
                    console.warn(`⚠️ ${listId} DOM尚未準備好:`, {
                        listElement: !!listElement,
                        filterElement: !!filterElement
                    });
                }

                return isReady;
            }

            // 統一的監聽啟動
            startListening(listId, searchQuery = '') {
                const config = this.domConfigs.get(listId);
                if (!config) {
                    console.error(`❌ 未找到 ${listId} 的配置`);
                    return false;
                }

                if (!this.checkDomReady(listId)) {
                    console.error(`❌ ${listId} DOM未準備好，無法啟動監聽`);
                    return false;
                }

                // 檢查是否已有相同搜索條件的監聽器在運行
                const currentSearchState = this.searchStates.get(listId) || '';
                const hasActiveListener = this.listeners.has(listId);
                
                // 對於訂單列表，還需要檢查狀態篩選是否改變
                if (listId === 'orders') {
                    const statusFilter = document.getElementById('statusFilter');
                    const currentStatus = statusFilter ? statusFilter.value : 'all';
                    const lastStatus = this.lastOrderStatus || 'all';
                    
                    if (hasActiveListener && currentSearchState === searchQuery && currentStatus === lastStatus) {
                        // 訂單監聽器已存在且條件相同，跳過重複啟動
                        return true;
                    }
                    
                    // 記錄當前狀態
                    this.lastOrderStatus = currentStatus;
                } else if (listId === 'members') {
                    // 會員列表不使用防重複機制，確保即時更新
                } else {
                    if (hasActiveListener && currentSearchState === searchQuery) {
                        return true;
                    }
                }

                // 清除舊監聽器
                this.stopListening(listId);

                // 更新搜索狀態
                this.searchStates.set(listId, searchQuery);

                // 智能載入狀態管理
                const listElement = document.getElementById(config.listElement);
                const currentContent = listElement.innerHTML.trim();
                const hasDataRows = listElement.querySelectorAll('tr').length > 0 && 
                                  !currentContent.includes('暫無') && 
                                  !currentContent.includes('載入') && 
                                  !currentContent.includes('錯誤');
                
                // 只在真正需要時顯示載入狀態
                if (!hasDataRows) {
                    listElement.innerHTML = `<tr><td colspan="${config.columns}" class="table-loading">${config.loadingMessage}</td></tr>`;
                }

                // 構建查詢
                let query = this.buildQuery(listId, searchQuery);



                // 設置監聽器
                const unsubscribe = query.onSnapshot(async snapshot => {
    
                    const renderFunction = this.renderFunctions.get(listId);
                    if (renderFunction) {
                        if (listId === 'orders') {
                            // 訂單需要特殊處理（去重）
                            const uniqueOrders = {};
                            snapshot.docs.forEach(doc => {
                                uniqueOrders[doc.id] = doc.data();
                            });
                            await renderFunction(uniqueOrders);
                        } else {
                            // 其他列表直接傳遞snapshot
                            renderFunction(snapshot);
                        }
                    }
                }, error => {
                    this.handleListeningError(listId, error, searchQuery);
                });

                this.listeners.set(listId, unsubscribe);
                return true;
            }

            // 構建查詢
            buildQuery(listId, searchQuery) {
                const config = this.domConfigs.get(listId);
                
                if (listId === 'members' && searchQuery && searchQuery.trim() !== '') {
                    // 會員搜索查詢 - 由於需要廣義搜索（包含電話號碼中間部分），
                    // 我們必須拉取所有會員數據，然後在前端做篩選
                    // 這是因為Firebase不支援包含搜索，只支援前綴搜索
                    return db.collection(config.collection);  // 移除排序，確保包含所有會員
                } else if (listId === 'members') {
                    // 會員列表查詢 - 使用無排序查詢確保包含所有會員
                    return db.collection(config.collection);  // 移除排序，確保包含所有會員
                } else if (listId === 'orders') {
                    // 訂單查詢，檢查狀態篩選
                    const statusFilter = DOMCache.get('statusFilter');
                    // 檢查狀態篩選器
                    
                    if (statusFilter && statusFilter.value !== 'all') {
                        // 建立狀態篩選查詢
                        // 避免複合索引需求，只使用狀態篩選，前端排序
                        return db.collection(config.collection)
                            .where('status', '==', statusFilter.value);
                    } else {
                                                    // 建立全部訂單查詢
                        return db.collection(config.collection).orderBy(config.primaryOrderBy, 'desc');
                    }
                } else {
                    // 預設查詢
                    return db.collection(config.collection).orderBy(config.primaryOrderBy, 'desc');
                }
            }

            // 統一的錯誤處理
            handleListeningError(listId, error, searchQuery) {
                console.error(`Error listening to ${listId}:`, error);
                const config = this.domConfigs.get(listId);
                const listElement = document.getElementById(config.listElement);
                
                if (error.code === 'failed-precondition' || error.message.includes('index')) {
                                            // 索引可能不存在，使用降級查詢
                    
                    // 構建降級查詢
                    let fallbackQuery;
                    if (listId === 'members') {
                        // 會員列表降級查詢 - 統一使用無排序查詢確保包含所有會員
                        fallbackQuery = db.collection(config.collection);
                    } else if (listId === 'orders') {
                        // 訂單降級查詢也要考慮狀態篩選
                        const statusFilter = DOMCache.get('statusFilter');
                        if (statusFilter && statusFilter.value !== 'all') {
                            // 降級查詢使用狀態篩選
                            // 降級查詢只使用狀態篩選，不使用排序
                            fallbackQuery = db.collection(config.collection)
                                .where('status', '==', statusFilter.value);
                        } else {
                            // 全部訂單查詢，使用 createdAt 排序
                            fallbackQuery = db.collection(config.collection).orderBy('createdAt', 'desc');
                        }
                    } else {
                        fallbackQuery = db.collection(config.collection).orderBy(config.fallbackOrderBy, 'desc');
                    }
                    
                    const fallbackUnsubscribe = fallbackQuery.onSnapshot(async snapshot => {
                        const renderFunction = this.renderFunctions.get(listId);
                        if (renderFunction) {
                            if (listId === 'orders') {
                                // 訂單需要特殊處理（去重）
                                const uniqueOrders = {};
                                snapshot.docs.forEach(doc => {
                                    uniqueOrders[doc.id] = doc.data();
                                });
                                await renderFunction(uniqueOrders);
                            } else {
                                // 其他列表直接傳遞snapshot
                                renderFunction(snapshot);
                            }
                        }
                    }, fallbackError => {
                        console.error(`${listId} 降級查詢也失敗:`, fallbackError);
                        
                        // 如果是會員列表，嘗試最終的無排序查詢
                        if (listId === 'members') {
                            // 嘗試會員列表的最終安全查詢
                            const finalQuery = db.collection(config.collection);
                            
                            const finalUnsubscribe = finalQuery.onSnapshot(snapshot => {
                                const renderFunction = this.renderFunctions.get(listId);
                                if (renderFunction) {
                                    renderFunction(snapshot);
                                }
                            }, finalError => {
                                console.error('會員列表最終查詢也失敗:', finalError);
                                if (listElement) {
                                    listElement.innerHTML = `<tr><td colspan="${config.columns}" class="table-error">網路連線異常或權限不足，請檢查後重試</td></tr>`;
                                }
                            });
                            
                            this.listeners.set(listId, finalUnsubscribe);
                        } else {
                            if (listElement) {
                                listElement.innerHTML = `<tr><td colspan="${config.columns}" class="table-error">${config.errorMessage}</td></tr>`;
                            }
                        }
                    });
                    
                    // 更新監聽器
                    this.listeners.set(listId, fallbackUnsubscribe);
                } else {
                    // 其他錯誤
                    if (listElement) {
                        listElement.innerHTML = `<tr><td colspan="${config.columns}" class="table-error">網路連線異常，請檢查網路後重試</td></tr>`;
                    }
                }
            }

            // 停止監聽
            stopListening(listId) {
                const unsubscribe = this.listeners.get(listId);
                if (unsubscribe) {
                    unsubscribe();
                    this.listeners.delete(listId);

                }
            }

            // 停止所有監聽
            stopAllListening() {
                for (const [listId] of this.listeners) {
                    this.stopListening(listId);
                }

            }

            // 獲取搜索狀態
            getSearchState(listId) {
                return this.searchStates.get(listId) || '';
            }

            // 診斷列表狀態
            diagnoseList(listId) {
                const config = this.domConfigs.get(listId);
                if (!config) {
                    console.error(`❌ 未找到 ${listId} 的配置`);
                    return null;
                }

                const listElement = document.getElementById(config.listElement);
                const filterElement = config.filterElement ? document.getElementById(config.filterElement) : true;
                const isListening = this.listeners.has(listId);
                const searchState = this.searchStates.get(listId);

                const diagnosis = {
                    listId,
                    domReady: !!(listElement && filterElement),
                    isListening,
                    searchState,
                    listElement: !!listElement,
                    filterElement: !!filterElement
                };


                return diagnosis;
            }
        }

        // 創建全局統一管理器實例
        const listManager = new ListManagerSystem();

        /* DOM 元素緩存系統
         * 避免重複獲取DOM元素，提升性能和代碼一致性 */
        const DOMCache = {
            // 緩存對象
            cache: new Map(),
            
            // 獲取元素（帶緩存）
            get(id) {
                if (!this.cache.has(id)) {
                    const element = document.getElementById(id);
                    if (element) {
                        this.cache.set(id, element);
                    }
                    return element;
                }
                return this.cache.get(id);
            },
            
            // 清除單個緩存
            clear(id) {
                this.cache.delete(id);
            },
            
            // 清除所有緩存
            clearAll() {
                this.cache.clear();
            },
            
            // 預載入常用元素
            preload() {
                const commonElements = [
                    'statusFilter', 'ordersList', 'membersList', 'memberSearch',
                    'orderModal', 'editMemberModal', 'confirmModal', 'settingsModal'
                ];
                
                commonElements.forEach(id => this.get(id));
            },
            
            // 診斷緩存狀態
            diagnose() {
                return {
                    size: this.cache.size,
                    keys: Array.from(this.cache.keys())
                };
            }
        };

        /* Firebase 查詢緩存系統
         * 避免重複的數據庫查詢，提升應用性能 */
        const FirebaseCache = {
            // 緩存存儲
            cache: new Map(),
            // 緩存過期時間（毫秒）
            TTL: {
                settings: 5 * 60 * 1000,    // 設置：5分鐘
                member: 2 * 60 * 1000,      // 會員：2分鐘
                order: 1 * 60 * 1000,       // 訂單：1分鐘
                security: 5 * 60 * 1000     // 安全：5分鐘
            },
            
            // 生成緩存鍵
            generateKey(collection, docId = null, query = null) {
                if (docId) {
                    return `${collection}/${docId}`;
                }
                if (query) {
                    return `${collection}?${JSON.stringify(query)}`;
                }
                return collection;
            },
            
            // 獲取緩存數據
            get(key) {
                const cached = this.cache.get(key);
                if (!cached) return null;
                
                // 檢查是否過期
                if (Date.now() > cached.expiry) {
                    this.cache.delete(key);
                    return null;
                }
                
                return cached.data;
            },
            
            // 設置緩存數據
            set(key, data, ttl = 60000) {
                this.cache.set(key, {
                    data,
                    expiry: Date.now() + ttl,
                    timestamp: Date.now()
                });
            },
            
            // 智能獲取文檔（帶緩存）
            async getDoc(collection, docId, options = {}) {
                const key = this.generateKey(collection, docId);
                const cached = this.get(key);
                
                if (cached && !options.forceRefresh) {
                    return cached;
                }
                
                try {
                    const doc = await db.collection(collection).doc(docId).get();
                    const result = doc.exists ? { exists: true, data: doc.data(), id: doc.id } : { exists: false };
                    
                    // 根據集合類型設置TTL
                    const ttl = this.TTL[collection] || 60000;
                    this.set(key, result, ttl);
                    
                    return result;
                } catch (error) {
                    console.error(`Firebase緩存獲取失敗 ${collection}/${docId}:`, error);
                    throw error;
                }
            },
            
            // 智能獲取集合（帶緩存）
            async getCollection(collection, query = null, options = {}) {
                const key = this.generateKey(collection, null, query);
                const cached = this.get(key);
                
                if (cached && !options.forceRefresh) {
                    return cached;
                }
                
                try {
                    let ref = db.collection(collection);
                    
                    // 應用查詢條件
                    if (query) {
                        if (query.where) {
                            query.where.forEach(condition => {
                                ref = ref.where(...condition);
                            });
                        }
                        if (query.orderBy) {
                            ref = ref.orderBy(...query.orderBy);
                        }
                        if (query.limit) {
                            ref = ref.limit(query.limit);
                        }
                    }
                    
                    const snapshot = await ref.get();
                    const result = {
                        empty: snapshot.empty,
                        size: snapshot.size,
                        docs: snapshot.docs.map(doc => ({
                            id: doc.id,
                            data: doc.data()
                        }))
                    };
                    
                    // 根據集合類型設置TTL
                    const ttl = this.TTL[collection] || 60000;
                    this.set(key, result, ttl);
                    
                    return result;
                } catch (error) {
                    console.error(`Firebase緩存集合獲取失敗 ${collection}:`, error);
                    throw error;
                }
            },
            
            // 清除特定集合的緩存
            clearCollection(collection) {
                const keysToDelete = [];
                for (const [key] of this.cache) {
                    if (key.startsWith(collection)) {
                        keysToDelete.push(key);
                    }
                }
                keysToDelete.forEach(key => this.cache.delete(key));
            },
            
            // 清除所有緩存
            clearAll() {
                this.cache.clear();
            },
            
            // 診斷緩存狀態
            diagnose() {
                return {
                    size: this.cache.size,
                    keys: Array.from(this.cache.keys()),
                    details: Array.from(this.cache.entries()).map(([key, value]) => ({
                        key,
                        size: JSON.stringify(value.data).length,
                        timeLeft: Math.max(0, value.expiry - Date.now()),
                        created: new Date(value.timestamp).toLocaleString()
                    }))
                };
            }
        };

        /* 統一資源載入系統（移除重複的LazyLoader）
         * 使用SuperLazyLoader作為唯一載入系統 */

        /* 簡化錯誤處理系統
         * 減少冗餘的try-catch，統一錯誤處理流程 */
        const ErrorHandler = {
            // 安全執行函數（自動錯誤處理）
            async safe(fn, context = '操作') {
                try {
                    return await fn();
                } catch (error) {
                    console.error(`${context}失敗:`, error);
                    return null;
                }
            },
            
            // 安全執行同步函數
            safeSync(fn, context = '操作') {
                try {
                    return fn();
                } catch (error) {
                    console.error(`${context}失敗:`, error);
                    return null;
                }
            },
            
            // DOM操作安全執行
            safeDom(fn, context = 'DOM操作') {
                try {
                    return fn();
                } catch (error) {
                    console.error(`${context}失敗:`, error);
                    return false;
                }
            },
            
            // Firebase操作安全執行
            async safeFirebase(fn, context = 'Firebase操作') {
                try {
                    return await fn();
                } catch (error) {
                    console.error(`${context}失敗:`, error);
                    if (error.code) {
                        console.error('錯誤代碼:', error.code);
                    }
                    return null;
                }
            }
        };

        /* 表單驗證簡化系統
         * 統一處理表單驗證，減少重複代碼 */
        const FormValidator = {
            // 快速驗證配置
            quick: {
                phone: (value) => /^1[3-9]\d{9}$/.test(value) ? null : '請輸入有效的手機號碼',
                required: (value, name) => value?.trim() ? null : `${name}不能為空`,
                positive: (value, name) => value > 0 ? null : `${name}必須大於0`,
                url: (value) => {
                    try { new URL(value); return null; } 
                    catch { return '請輸入有效的網址'; }
                }
            },
            
            // 批量驗證
            validate(config) {
                const errors = [];
                Object.entries(config).forEach(([elementId, rules]) => {
                    const value = DOMManager.getValue(elementId);
                    rules.forEach(rule => {
                        const error = typeof rule === 'function' ? rule(value) : this.quick[rule]?.(value, elementId);
                        if (error) errors.push(error);
                    });
                });
                return { isValid: errors.length === 0, errors, first: errors[0] };
            }
        };

        /* 異步錯誤處理標準化系統
         * 統一的錯誤處理機制，提升用戶體驗和調試能力 */
        const AsyncErrorHandler = {
            // 錯誤類型分類
            ErrorTypes: {
                NETWORK: 'network',
                PERMISSION: 'permission',
                VALIDATION: 'validation',
                FIREBASE: 'firebase',
                UNKNOWN: 'unknown'
            },
            
            // 錯誤計數器
            errorCounts: new Map(),
            
            // 分類Firebase錯誤
            classifyFirebaseError(error) {
                if (!error) return this.ErrorTypes.UNKNOWN;
                
                const errorCode = error.code || '';
                const errorMessage = error.message || '';
                
                // 網路相關錯誤
                if (errorCode.includes('unavailable') || errorCode.includes('timeout') || 
                    errorMessage.includes('network') || errorMessage.includes('offline')) {
                    return this.ErrorTypes.NETWORK;
                }
                
                // 權限相關錯誤
                if (errorCode.includes('permission') || errorCode.includes('unauthenticated') ||
                    errorMessage.includes('permission') || errorMessage.includes('unauthorized')) {
                    return this.ErrorTypes.PERMISSION;
                }
                
                // 數據驗證錯誤
                if (errorCode.includes('invalid') || errorCode.includes('not-found') ||
                    errorMessage.includes('invalid') || errorMessage.includes('not found')) {
                    return this.ErrorTypes.VALIDATION;
                }
                
                return this.ErrorTypes.FIREBASE;
            },
            
            // 獲取用戶友好的錯誤訊息
            getUserFriendlyMessage(error, context = '') {
                const errorType = this.classifyFirebaseError(error);
                const contextPrefix = context ? `${context}：` : '';
                
                switch (errorType) {
                    case this.ErrorTypes.NETWORK:
                        return `${contextPrefix}網路連線異常，請檢查網路後重試`;
                    case this.ErrorTypes.PERMISSION:
                        return `${contextPrefix}權限不足，請重新登入`;
                    case this.ErrorTypes.VALIDATION:
                        return `${contextPrefix}數據格式錯誤，請檢查輸入內容`;
                    case this.ErrorTypes.FIREBASE:
                        return `${contextPrefix}資料庫操作失敗，請稍後重試`;
                    default:
                        return `${contextPrefix}操作失敗，請稍後重試`;
                }
            },
            
            // 統一的錯誤處理函數
            async handleError(error, context = '', options = {}) {
                const {
                    showAlert = true,
                    logToConsole = true,
                    retryable = false,
                    fallbackValue = null
                } = options;
                
                // 記錄錯誤次數
                const errorKey = `${context}_${this.classifyFirebaseError(error)}`;
                this.errorCounts.set(errorKey, (this.errorCounts.get(errorKey) || 0) + 1);
                
                // 控制台日誌
                if (logToConsole) {
                    console.error(`AsyncError [${context}]:`, {
                        type: this.classifyFirebaseError(error),
                        code: error.code,
                        message: error.message,
                        count: this.errorCounts.get(errorKey),
                        error
                    });
                }
                
                // 用戶提示
                if (showAlert) {
                    const userMessage = this.getUserFriendlyMessage(error, context);
                    alert(userMessage);
                }
                
                // 清理相關緩存（如果是Firebase錯誤）
                if (this.classifyFirebaseError(error) === this.ErrorTypes.FIREBASE) {
                    FirebaseCache.clearAll();
                }
                
                return fallbackValue;
            },
            
            // 包裝異步函數以自動處理錯誤
            wrapAsync(asyncFn, context = '', options = {}) {
                return async (...args) => {
                    try {
                        return await asyncFn(...args);
                    } catch (error) {
                        return await this.handleError(error, context, options);
                    }
                };
            },
            
            // 重試機制
            async retry(asyncFn, maxRetries = 3, delay = 1000, context = '') {
                let lastError;
                
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        return await asyncFn();
                    } catch (error) {
                        lastError = error;
                        
                        if (attempt < maxRetries) {
                            console.warn(`重試 ${attempt}/${maxRetries} [${context}]:`, error.message);
                            await new Promise(resolve => setTimeout(resolve, delay * attempt));
                        }
                    }
                }
                
                throw lastError;
            },
            
            // 診斷錯誤統計
            diagnose() {
                return {
                    totalErrors: Array.from(this.errorCounts.values()).reduce((a, b) => a + b, 0),
                    errorDistribution: Object.fromEntries(this.errorCounts)
                };
            }
        };

        /* 數據驗證統一系統
         * 標準化的數據驗證機制，確保數據一致性和安全性 */
        const DataValidator = {
            // 驗證規則
            ValidationRules: {
                POSITIVE_NUMBER: 'positive_number',
                PHONE: 'phone',
                MEMBER_LEVEL: 'member_level',
                MEMBER_STATUS: 'member_status',
                DECIMAL_PLACES: 'decimal_places',
                REQUIRED: 'required'
            },
            
            // 數字驗證
            validateNumber(value, options = {}) {
                const {
                    min = -Infinity,
                    max = Infinity,
                    maxDecimals = 4,
                    allowZero = false,
                    required = true
                } = options;
                
                // 必填檢查
                if (required && (value === null || value === undefined || value === '')) {
                    return { valid: false, error: '此欄位為必填項目' };
                }
                
                // 如果不是必填且為空，視為有效
                if (!required && (value === null || value === undefined || value === '')) {
                    return { valid: true, value: null };
                }
                
                // 數字轉換
                const numValue = parseFloat(value);
                
                // NaN檢查
                if (isNaN(numValue)) {
                    return { valid: false, error: '請輸入有效的數字' };
                }
                
                // 正數檢查
                if (!allowZero && numValue <= 0) {
                    return { valid: false, error: '請輸入大於零的數值' };
                }
                
                if (allowZero && numValue < 0) {
                    return { valid: false, error: '請輸入大於等於零的數值' };
                }
                
                // 範圍檢查
                if (numValue < min || numValue > max) {
                    return { valid: false, error: `數值必須在 ${min} 到 ${max} 之間` };
                }
                
                // 小數位數檢查
                const valueStr = value.toString();
                const decimalPart = valueStr.split('.')[1];
                if (decimalPart && decimalPart.length > maxDecimals) {
                    return { valid: false, error: `小數位數最多 ${maxDecimals} 位` };
                }
                
                return { valid: true, value: numValue };
            },
            
            // 電話號碼驗證
            validatePhone(phone, options = {}) {
                const { required = true } = options;
                
                if (!required && !phone) {
                    return { valid: true, value: null };
                }
                
                if (!phone || typeof phone !== 'string') {
                    return { valid: false, error: '請輸入電話號碼' };
                }
                
                const trimmedPhone = phone.trim();
                
                // 基本格式檢查
                if (!/^\d+$/.test(trimmedPhone)) {
                    return { valid: false, error: '電話號碼只能包含數字' };
                }
                
                // 長度檢查
                if (trimmedPhone.length < 8 || trimmedPhone.length > 15) {
                    return { valid: false, error: '電話號碼長度必須在8-15位之間' };
                }
                
                return { valid: true, value: trimmedPhone };
            },
            
            // 會員等級驗證
            validateMemberLevel(level) {
                const validLevels = ['basic', 'tenThousand', 'fiftyThousand', 'negotiable'];
                
                if (!level || !validLevels.includes(level)) {
                    return { valid: false, error: '無效的會員等級' };
                }
                
                return { valid: true, value: level };
            },
            
            // 會員狀態驗證
            validateMemberStatus(status) {
                const validStatuses = ['pending', 'active', 'suspended'];
                
                if (!status || !validStatuses.includes(status)) {
                    return { valid: false, error: '無效的會員狀態' };
                }
                
                return { valid: true, value: status };
            },
            
            // 日期驗證
            validateDate(dateStr, options = {}) {
                const { required = true, futureOnly = false, pastOnly = false } = options;
                
                if (!required && !dateStr) {
                    return { valid: true, value: null };
                }
                
                if (!dateStr) {
                    return { valid: false, error: '請選擇日期' };
                }
                
                const date = new Date(dateStr);
                
                if (isNaN(date.getTime())) {
                    return { valid: false, error: '無效的日期格式' };
                }
                
                const now = new Date();
                
                if (futureOnly && date <= now) {
                    return { valid: false, error: '日期必須是未來時間' };
                }
                
                if (pastOnly && date >= now) {
                    return { valid: false, error: '日期必須是過去時間' };
                }
                
                return { valid: true, value: date };
            },
            
            // 批量驗證
            validateBatch(data, validationSchema) {
                const errors = {};
                const validatedData = {};
                let hasErrors = false;
                
                for (const [field, rules] of Object.entries(validationSchema)) {
                    const value = data[field];
                    let fieldResult = { valid: true, value };
                    
                    // 按順序執行驗證規則
                    for (const rule of rules) {
                        if (rule.type === this.ValidationRules.POSITIVE_NUMBER) {
                            fieldResult = this.validateNumber(value, rule.options || {});
                        } else if (rule.type === this.ValidationRules.PHONE) {
                            fieldResult = this.validatePhone(value, rule.options || {});
                        } else if (rule.type === this.ValidationRules.MEMBER_LEVEL) {
                            fieldResult = this.validateMemberLevel(value);
                        } else if (rule.type === this.ValidationRules.MEMBER_STATUS) {
                            fieldResult = this.validateMemberStatus(value);
                        }
                        
                        // 如果驗證失敗，停止後續驗證
                        if (!fieldResult.valid) {
                            break;
                        }
                    }
                    
                    if (fieldResult.valid) {
                        validatedData[field] = fieldResult.value;
                    } else {
                        errors[field] = fieldResult.error;
                        hasErrors = true;
                    }
                }
                
                return {
                    valid: !hasErrors,
                    errors,
                    data: validatedData
                };
            },
            
            // 表單驗證助手
            validateForm(formSelector, validationSchema) {
                const form = document.querySelector(formSelector);
                if (!form) return { valid: false, errors: { form: '找不到表單' } };
                
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                return this.validateBatch(data, validationSchema);
            }
        };

        /* ================================================================
        * === DOM元素統一管理系統 ===
        * 統一DOM獲取、緩存和操作，減少重複代碼
        ================================================================ */
        const DOMManager = {
            // 元素緩存映射
            cache: new Map(),
            
            // 元素ID映射表（預定義常用元素）
            elements: {
                // 訂單相關
                orderModal: 'orderModal',
                ordersList: 'ordersList',
                modalImages: 'modalImages',
                modalAmount: 'modalAmount',
                modalExpectedDateTime: 'modalExpectedDateTime',
                
                // 其他平台信息
                othersInfoSection: 'othersInfoSection',
                othersProductLinkItem: 'othersProductLinkItem',
                othersDescriptionItem: 'othersDescriptionItem',
                othersProductLinkValue: 'othersProductLinkValue',
                othersDescriptionValue: 'othersDescriptionValue',
                
                // 操作按鈕
                orderActionsSection: 'orderActionsSection',
                acceptOrderBtn: 'acceptOrderBtn',
                completeOrderBtn: 'completeOrderBtn',
                
                // 會員相關
                membersList: 'membersList',
                memberSearch: 'memberSearch',
                editMemberModal: 'editMemberModal',
                editMemberPhone: 'editMemberPhone',
                editMemberLevel: 'editMemberLevel',
                editMemberStatus: 'editMemberStatus',
                editMemberExpiry: 'editMemberExpiry',
                editMemberRemark: 'editMemberRemark',
                
                // 設置相關
                settingsModal: 'settingsModal',
                statusFilter: 'statusFilter',
                
                // 預覽相關
                imagePreview: 'imagePreview',
                previewImage: 'previewImage',
                
                // 確認模態框
                confirmModal: 'confirmModal',
                confirmButton: 'confirmButton',
                
                // 登錄相關
                adminPassword: 'adminPassword',
                loginError: 'loginError',
                lockoutMessage: 'lockoutMessage'
            },
            
            // 獲取元素（帶緩存）
            get(elementId) {
                // 支持直接傳入ID字符串或使用預定義映射
                const id = this.elements[elementId] || elementId;
                
                if (this.cache.has(id)) {
                    const cached = this.cache.get(id);
                    // 檢查元素是否仍在DOM中
                    if (cached && document.contains(cached)) {
                        return cached;
                    }
                    // 如果元素不在DOM中，清除緩存
                    this.cache.delete(id);
                }
                
                const element = document.getElementById(id);
                if (element) {
                    this.cache.set(id, element);
                }
                return element;
            },
            
            // 批量獲取元素
            getMultiple(elementIds) {
                const result = {};
                elementIds.forEach(id => {
                    result[id] = this.get(id);
                });
                return result;
            },
            
            // 顯示元素
            show(elementId, displayType = 'block') {
                const element = this.get(elementId);
                if (!element) return false;
                
                ElementVisibility.show(element, displayType);
                return true;
            },
            
            // 隱藏元素
            hide(elementId) {
                const element = this.get(elementId);
                if (!element) return false;
                
                ElementVisibility.hide(element);
                return true;
            },
            
            // 批量顯示
            showMultiple(elementIds, displayType = 'block') {
                elementIds.forEach(id => this.show(id, displayType));
            },
            
            // 批量隱藏
            hideMultiple(elementIds) {
                elementIds.forEach(id => this.hide(id));
            },
            
            // 設置文本內容
            setText(elementId, text) {
                const element = this.get(elementId);
                if (element) {
                    element.textContent = text;
                    return true;
                }
                return false;
            },
            
            // 設置HTML內容
            setHTML(elementId, html) {
                const element = this.get(elementId);
                if (element) {
                    element.innerHTML = html;
                    return true;
                }
                return false;
            },
            
            // 設置值
            setValue(elementId, value) {
                const element = this.get(elementId);
                if (element) {
                    element.value = value;
                    return true;
                }
                return false;
            },
            
            // 獲取值
            getValue(elementId) {
                const element = this.get(elementId);
                return element ? element.value : null;
            },
            
            // 清除緩存
            clearCache() {
                this.cache.clear();
            },
            
            // 清除特定元素緩存
            clearElement(elementId) {
                const id = this.elements[elementId] || elementId;
                this.cache.delete(id);
            }
        };

        /* ================================================================
        * === 元素顯示/隱藏統一管理系統 ===
        * 使用CSS類而非內聯樣式，提升性能和可維護性
        ================================================================ */
        const ElementVisibility = {
            // 顯示元素
            show(elementOrId, displayType = 'block') {
                const element = typeof elementOrId === 'string' ? document.getElementById(elementOrId) : elementOrId;
                if (!element) return false;
                
                // 移除隱藏類
                element.classList.remove('order-section-hidden', 'order-item-hidden', 'order-btn-hidden', 'form-group-hidden', 'preview-image-hidden');
                
                // 如果需要特殊的display類型，設置內聯樣式
                if (displayType !== 'block') {
                    element.style.display = displayType;
                } else {
                    element.style.display = '';
                }
                
                return true;
            },
            
            // 隱藏元素
            hide(elementOrId) {
                const element = typeof elementOrId === 'string' ? document.getElementById(elementOrId) : elementOrId;
                if (!element) return false;
                
                // 根據元素類型添加對應的隱藏類
                if (element.id && element.id.includes('Section')) {
                    element.classList.add('order-section-hidden');
                } else if (element.id && element.id.includes('Item')) {
                    element.classList.add('order-item-hidden');
                } else if (element.id && element.id.includes('Btn')) {
                    element.classList.add('order-btn-hidden');
                } else if (element.classList.contains('form-group') || element.classList.contains('delete-button-container')) {
                    element.classList.add('form-group-hidden');
                } else if (element.id === 'previewImage') {
                    element.classList.add('preview-image-hidden');
                } else {
                    // 通用隱藏
                    element.style.display = 'none';
                }
                
                return true;
            },
            
            // 切換顯示狀態
            toggle(elementOrId, displayType = 'block') {
                const element = typeof elementOrId === 'string' ? document.getElementById(elementOrId) : elementOrId;
                if (!element) return false;
                
                const isHidden = element.style.display === 'none' || 
                               element.classList.contains('order-section-hidden') ||
                               element.classList.contains('order-item-hidden') ||
                               element.classList.contains('order-btn-hidden') ||
                               element.classList.contains('form-group-hidden') ||
                               element.classList.contains('preview-image-hidden');
                
                if (isHidden) {
                    this.show(element, displayType);
                } else {
                    this.hide(element);
                }
                
                return true;
            },
            
            // 批量操作
            showMultiple(elements, displayType = 'block') {
                elements.forEach(elementOrId => this.show(elementOrId, displayType));
            },
            
            hideMultiple(elements) {
                elements.forEach(elementOrId => this.hide(elementOrId));
            }
        };

        /* ================================================================
        * === 訂單狀態管理系統 ===
        * 統一處理訂單狀態相關的UI更新邏輯
        ================================================================ */
        const OrderStatusManager = {
            // 狀態配置映射
            statusConfig: {
                pending: {
                    showSection: true,
                    showAccept: true,
                    showComplete: true,
                    description: '待處理狀態'
                },
                processing: {
                    showSection: true,
                    showAccept: false,
                    showComplete: true,
                    description: '處理中狀態'
                },
                completed: {
                    showSection: false,
                    showAccept: false,
                    showComplete: false,
                    description: '已完成狀態'
                }
            },
            
            // 更新操作按鈕顯示
            updateActionButtons(status, elements) {
                const config = this.statusConfig[status] || this.statusConfig.completed;
                const { orderActionsSection, acceptOrderBtn, completeOrderBtn } = elements;
                
                // 根據配置更新顯示狀態
                if (config.showSection) {
                    ElementVisibility.show(orderActionsSection);
                } else {
                    ElementVisibility.hide(orderActionsSection);
                }
                
                if (config.showAccept) {
                    ElementVisibility.show(acceptOrderBtn);
                } else {
                    ElementVisibility.hide(acceptOrderBtn);
                }
                
                if (config.showComplete) {
                    ElementVisibility.show(completeOrderBtn);
                } else {
                    ElementVisibility.hide(completeOrderBtn);
                }
            },
            
            // 獲取狀態顯示名稱
            getStatusName(status) {
                const statusNames = {
                    pending: '待處理',
                    processing: '處理中',
                    completed: '已完成'
                };
                return statusNames[status] || '未知狀態';
            },
            
            // 獲取狀態CSS類
            getStatusClass(status) {
                const statusClasses = {
                    pending: 'status-pending',
                    processing: 'status-processing', 
                    completed: 'status-completed'
                };
                return statusClasses[status] || 'status-unknown';
            }
        };

        /* ================================================================
        * === 事件監聽器管理系統 ===
        * 避免重複綁定事件監聽器，統一管理事件處理
        ================================================================ */
        const EventManager = {
            // 存儲已綁定的事件監聽器
            listeners: new Map(),
            
            // 安全添加事件監聽器（自動移除舊的）
            addListener(elementId, eventType, handler, options = {}) {
                const element = DOMCache.get(elementId);
                if (!element) {
                    console.warn(`EventManager: 元素 ${elementId} 不存在`);
                    return false;
                }
                
                const key = `${elementId}_${eventType}`;
                
                // 移除舊的監聽器（如果存在）
                this.removeListener(elementId, eventType);
                
                // 添加新的監聽器
                element.addEventListener(eventType, handler, options);
                
                // 記錄監聽器信息
                this.listeners.set(key, {
                    element,
                    handler,
                    options,
                    timestamp: Date.now()
                });
                
                return true;
            },
            
            // 移除事件監聽器
            removeListener(elementId, eventType) {
                const key = `${elementId}_${eventType}`;
                const listenerInfo = this.listeners.get(key);
                
                if (listenerInfo) {
                    listenerInfo.element.removeEventListener(eventType, listenerInfo.handler, listenerInfo.options);
                    this.listeners.delete(key);
                    return true;
                }
                return false;
            },
            
            // 移除元素的所有事件監聽器
            removeAllListeners(elementId) {
                const keysToRemove = [];
                for (const [key] of this.listeners) {
                    if (key.startsWith(`${elementId}_`)) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => {
                    const [id, eventType] = key.split('_');
                    this.removeListener(id, eventType);
                });
            },
            
            // 清除所有事件監聽器
            clearAll() {
                for (const [key, listenerInfo] of this.listeners) {
                    listenerInfo.element.removeEventListener(
                        key.split('_')[1], 
                        listenerInfo.handler, 
                        listenerInfo.options
                    );
                }
                this.listeners.clear();
            },
            
            // 診斷事件監聽器狀態
            diagnose() {
                return {
                    count: this.listeners.size,
                    keys: Array.from(this.listeners.keys())
                };
            }
        };

        // 全域變數
        let currentMemberSearch = ''; // 目前的搜索關鍵字

        // 初始化列表配置並註冊到統一管理器
        function initializeListConfigs() {
            // 避免重複初始化
            if (typeof listManager._configsInitialized !== 'undefined' && listManager._configsInitialized) {
                return;
            }
            
            // 註冊會員列表配置
            listManager.registerList('members', {
                listElementId: 'membersList',
                filterElementId: 'memberSearch',
                collection: 'members',
                primaryOrderBy: 'joinDate',  // 改用 joinDate，因為新會員可能沒有 lastUpdated
                fallbackOrderBy: 'joinDate',
                emptyMessage: '暫無會員資料',
                loadingMessage: '載入中...',
                errorMessage: '載入會員列表失敗，請稍後重試',
                columns: 8,
                renderFunction: renderMembersList
            });

            // 註冊訂單列表配置
            listManager.registerList('orders', {
                listElementId: 'ordersList',
                filterElementId: 'statusFilter',
                collection: 'orders',
                primaryOrderBy: 'createdAt',  // 使用 createdAt 避免索引問題
                fallbackOrderBy: 'createdAt',
                emptyMessage: '暫無訂單資料',
                loadingMessage: '載入中...',
                errorMessage: '載入訂單列表失敗，請稍後重試',
                columns: 7,
                renderFunction: renderOrdersList
            });

            // 標記為已初始化
            listManager._configsInitialized = true;
                                // ListManager 配置初始化完成
        }

        // 初始化會員列表（統一使用管理器）
        function initializeMembersList() {
            // 強制停止現有監聽器，確保重新建立最新連接
            listManager.stopListening('members');
            
            // 重置搜索狀態
            currentMemberSearch = '';
            const searchInput = DOMCache.get('memberSearch');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // 使用統一管理器開始監聽會員資料
            listManager.startListening('members');
        }

        // 移除無用的別名函數，統一使用 initializeMembersList

        // 渲染會員列表
        function renderMembersList(snapshot) {            
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '';

            if (snapshot.empty) {
                membersList.innerHTML = '<tr><td colspan="8" class="table-empty">暫無會員資料</td></tr>';
                return;
            }

            // 取得目前的搜尋關鍵字
            const searchQuery = currentMemberSearch.toLowerCase().trim();
            
            // 過濾會員資料 - 廣義搜尋（電話號碼、會員等級、狀態、備註等）
            let filteredDocs = [];
            snapshot.forEach(doc => {
                if (!searchQuery) {
                    filteredDocs.push(doc);
                } else {
                    const member = doc.data();
                    const phone = doc.id.toLowerCase();
                    const level = getMemberLevelName(member.level).toLowerCase();
                    const status = getMemberStatusName(member.status).toLowerCase();
                    const expiry = (member.expiry || '').toLowerCase();
                    const remark = (member.remark || '').toLowerCase();
                    const joinDate = formatDateTime(member.joinDate).toLowerCase();
                    const lastLogin = formatDateTime(member.lastLogin).toLowerCase();
                    
                    // 廣義搜尋：只要任一欄位包含搜尋關鍵字就顯示
                    if (phone.includes(searchQuery) || 
                        level.includes(searchQuery) || 
                        status.includes(searchQuery) || 
                        expiry.includes(searchQuery) || 
                        remark.includes(searchQuery) || 
                        joinDate.includes(searchQuery) || 
                        lastLogin.includes(searchQuery)) {
                        filteredDocs.push(doc);
                    }
                }
            });

            // 快速客戶端排序 - 確保最新的會員排在前面
            filteredDocs.sort((a, b) => {
                const memberA = a.data();
                const memberB = b.data();
                
                // 優先使用 lastUpdated，如果沒有則使用 joinDate，最後使用空字符串
                const timeA = memberA.lastUpdated || memberA.joinDate || '1970-01-01';
                const timeB = memberB.lastUpdated || memberB.joinDate || '1970-01-01';
                
                // 字符串比較比 Date 物件更快
                return timeB.localeCompare(timeA);
            });

            // 如果有搜尋條件但沒有結果
            if (searchQuery && filteredDocs.length === 0) {
                membersList.innerHTML = '<tr><td colspan="8" class="table-empty">找不到符合條件的會員</td></tr>';
                return;
            }

            // 如果沒有搜尋條件但也沒有會員
            if (!searchQuery && filteredDocs.length === 0) {
                membersList.innerHTML = '<tr><td colspan="8" class="table-empty">暫無會員資料</td></tr>';
                return;
            }

            filteredDocs.forEach(doc => {
                const member = doc.data();
                const row = document.createElement('tr');
                const statusCell = document.createElement('td');
                const actionsCell = document.createElement('td');
                
                if (member.status === 'suspended') {
                    statusCell.innerHTML = `<span class="member-status status-suspended member-status-clickable" title="點擊查看詳情" onclick="showMemberDetails('${doc.id}')">${getMemberStatusName(member.status)}</span>`;
                } else {
                    statusCell.innerHTML = `<span class="member-status status-${member.status}">${getMemberStatusName(member.status)}</span>`;
                }
                
                // 根據會員狀態顯示不同的操作按鈕
                let actionButtons = '';
                if (member.status === 'pending') {
                    actionButtons = `
                        <button class="member-action-btn btn-success btn-xs" onclick="authorizeMember('${doc.id}')" title="授權">✓</button>
                    `;
                } else if (member.status === 'active') {
                    actionButtons = `
                        <button class="member-action-btn btn-primary btn-xs" onclick="editMemberDirect('${doc.id}')" title="編輯">✎</button>
                    `;
                } else if (member.status === 'suspended') {
                    actionButtons = `
                        <button class="member-action-btn btn-success btn-xs" onclick="authorizeMember('${doc.id}')" title="授權恢復">⟳</button>
                    `;
                }
                
                actionsCell.innerHTML = actionButtons;
                
                row.innerHTML = `
                    <td>${doc.id}</td>
                    <td>${getMemberLevelName(member.level)}</td>
                    <td>${member.expiry || '-'}</td>
                    <td>${formatDateTime(member.joinDate)}</td>
                    <td>${formatDateTime(member.lastLogin)}</td>
                    <td class="member-last-updated">${formatDateTime(member.lastUpdated) || '未設定'}</td>
                `;
                
                row.appendChild(statusCell);
                row.appendChild(actionsCell);
                membersList.appendChild(row);
            });
        }

        // 搜尋會員（改為使用統一管理器）
        function searchMembers() {
            const searchText = DOMCache.get('memberSearch').value.toLowerCase();
            // 更新目前的搜索關鍵字
            currentMemberSearch = searchText;
            // 使用統一管理器重新開始監聽
            listManager.startListening('members', currentMemberSearch);
        }



        // 顯示會員詳情
        async function showMemberDetails(phone) {
            if (!phone || typeof phone !== 'string' || phone.trim() === '') {
                console.error('showMemberDetails called with invalid or empty phone ID:', phone);
                alert('無法載入會員詳情：會員ID無效或為空。');
                return;
            }
            try {
                // 使用統一緩存系統獲取會員資料
                const memberResult = await FirebaseCache.getDoc('members', phone);
                if (!memberResult.exists) {
                    alert('會員不存在');
                    return;
                }

                const member = memberResult.data;

                // 更新電話號碼顯示
                document.getElementById('detailMemberPhone').textContent = phone;

                // 處理備註歷史記錄顯示
                const remarkHistoryList = document.getElementById('remarkHistoryList');
                
                if (remarkHistoryList) {
                    if (member.remarkHistory && member.remarkHistory.length > 0) {
                        remarkHistoryList.innerHTML = '';
                        
                        // 按時間倒序排列（最新的在前）
                        const sortedHistory = [...member.remarkHistory].sort((a, b) => 
                            new Date(b.timestamp) - new Date(a.timestamp)
                        );
                        
                        // 只顯示暫停記錄，過濾掉恢復記錄
                        const suspendedHistory = sortedHistory.filter(history => history.action === 'suspended');
                        
                        suspendedHistory.forEach(history => {
                            const historyItem = document.createElement('div');
                            historyItem.className = `history-item action-${history.action}`;
                            
                            const formattedTime = formatDateTime(history.timestamp);
                            
                            historyItem.innerHTML = `
                                <div class="history-header">
                                    <div class="history-action action-${history.action}">停權</div>
                                    <div class="history-timestamp">${formattedTime}</div>
                                </div>
                                <div class="history-remark">${history.remark}</div>
                                <div class="history-details">
                                    由 ${getMemberStatusName(history.previousStatus)} 變更為暫停
                                    ${history.previousRemark ? `（原備註：${history.previousRemark}）` : ''}
                                </div>
                            `;
                            
                            remarkHistoryList.appendChild(historyItem);
                        });
                    } else {
                        remarkHistoryList.innerHTML = '<div class="member-details-empty">此會員無暫停歷史記錄</div>';
                    }
                    
                    // 如果過濾後沒有暫停記錄，顯示空狀態
                    if (member.remarkHistory && member.remarkHistory.length > 0) {
                        const suspendedCount = member.remarkHistory.filter(h => h.action === 'suspended').length;
                        if (suspendedCount === 0) {
                            remarkHistoryList.innerHTML = '<div class="member-details-empty">此會員無暫停歷史記錄</div>';
                        }
                    }
                }

                // 顯示模態框
                ModalManager.show('memberDetailsModal');
            } catch (error) {
                console.error('Error loading member details:', error);
                alert('載入會員詳情失敗');
            }
        }



        // 處理狀態變更 (使用統一控制器)
        function handleStatusChange(status) {
            if (formController) {
                const currentLevel = document.getElementById('editMemberLevel')?.value || 'basic';
                formController.applyStateRules(status, currentLevel);
                formController.clearRelatedFields(status);
            }
        }

        // 更新會員資料 (使用統一狀態管理器)
        async function updateMember(phone, updates) {
            // 從表單獲取額外資料
            if (updates.status === 'suspended') {
                updates.remark = document.getElementById('editMemberRemark').value;
            }

            const result = await MemberStateManager.updateMemberState(phone, updates);
            
            if (!result.success) {
                console.error('會員資料更新失敗:', result.error);
            }
            
            return result.success;
        }

        // 獲取會員狀態名稱
        function getMemberStatusName(status) {
            const statuses = {
                'pending': '未審核',
                'active': '正常',
                'suspended': '暫停'
            };
            return statuses[status] || '未審核';
        }

        // 授權會員 (使用統一狀態管理器)
        async function authorizeMember(phone) {
            const result = await MemberStateManager.updateMemberState(phone, {
                status: 'active'
            });
            
            if (result.success) {
                // 如果詳情模態框已開啟則關閉
                if (document.getElementById('memberDetailsModal').classList.contains('show')) {
                    closeMemberDetails();
                }
                // 實時監聽會自動更新列表，不需要手動重新載入
            } else {
                console.error('Error authorizing member:', result.error);
                alert('授權會員失敗');
            }
        }



        // 直接編輯會員 (使用統一管理器)
        async function editMemberDirect(phone) {
            const memberData = await MemberStateManager.getNormalizedMemberData(phone);
            if (!memberData) {
                alert('會員不存在');
                return;
            }

            // 使用 UI 管理器初始化模態框（異步處理）
            memberData.phone = phone; // 確保 phone 資料存在
            
            try {
                const success = await EditModalManager.initializeModal(memberData);
                if (success) {
                    // 顯示會員電話號碼在標題中
                    document.getElementById('editMemberPhoneDisplay').textContent = `(${phone})`;
                    ModalManager.show('editMemberModal');
                } else {
                    alert('載入會員資料失敗');
                }
            } catch (error) {
                console.error('會員編輯模態框初始化失敗:', error);
                alert('載入會員資料失敗');
            }
        }

        // 處理編輯表單提交（異步）
        setTimeout(() => {
            const editMemberForm = document.getElementById('editMemberForm');
            if (editMemberForm) {
                editMemberForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const phone = document.getElementById('editMemberPhone').value;
                    const level = document.getElementById('editMemberLevel').value;
                    const expiry = document.getElementById('editMemberExpiry').value;
                    const status = document.getElementById('editMemberStatus').value;

                    // 如果不是一般會員，則需要填寫到期日
                    if (level !== 'basic' && !expiry) {
                        alert('請填寫到期日期');
                        return;
                    }

                    // 如果是暫停狀態，則需要填寫備註
                    if (status === 'suspended') {
                        const remark = document.getElementById('editMemberRemark').value;
                        if (!remark.trim()) {
                            alert('請填寫備註');
                            return;
                        }
                    }

                    const updates = {
                        level: level,
                        expiry: level === 'basic' ? (expiry || '') : expiry,
                        status: status
                    };

                    try {
                        await updateMember(phone, updates);
            ModalManager.hide('editMemberModal');
                        // 實時監聽會自動更新列表，不需要手動重新載入
                    } catch (error) {
                        console.error('Error updating member:', error);
                        alert('更新失敗，請稍後再試。');
                    }
                });
            }
        }, 0);



        // 格式化日期時間函數 (24小時制)
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            
            try {
                const date = new Date(dateString);
                // 檢查日期是否有效
                if (isNaN(date.getTime())) {
                    console.warn('Invalid date string:', dateString);
                    return '-';
                }
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
            } catch (error) {
                console.error('Error formatting date:', error, dateString);
                return '-';
            }
        }

        // 格式化日期時間函數 (兩行顯示格式)
        function formatDateTimeTwoLines(dateString) {
            if (!dateString) return '-';
            
            try {
                const date = new Date(dateString);
                // 檢查日期是否有效
                if (isNaN(date.getTime())) {
                    console.warn('Invalid date string:', dateString);
                    return '-';
                }
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${year}-${month}-${day}<br/>${hours}：${minutes}：${seconds}`;
            } catch (error) {
                console.error('Error formatting date (two lines):', error, dateString);
                return '-';
            }
        }

        function handleMemberLevelChange(level) {
            if (formController) {
                const currentStatus = document.getElementById('editMemberStatus')?.value || 'pending';
                formController.applyStateRules(currentStatus, level);
            }
        }

        // Firestore 訂單即時監聽
        // 系統狀態管理物件（統一管理所有初始化狀態）
        const SystemState = {
            orderManagementInitialized: false,
            statusFilterInitialized: false,
            lastOrdersRenderTime: 0,
            lastOrdersHash: '',
            
            // 重置所有狀態
            reset() {
                try {
                    this.orderManagementInitialized = false;
                    this.statusFilterInitialized = false;
                    this.lastOrdersRenderTime = 0;
                    this.lastOrdersHash = '';
                } catch (error) {
                    console.error('SystemState reset error:', error);
                }
            },
            
            // 診斷系統狀態
            diagnose() {
                return {
                    orderManagementInitialized: this.orderManagementInitialized,
                    statusFilterInitialized: this.statusFilterInitialized,
                    hasRecentRender: (Date.now() - this.lastOrdersRenderTime) < 5000,
                    listManagerActive: typeof listManager !== 'undefined' && listManager.listeners.size > 0
                };
            }
        };
        
        // 統一的訂單管理初始化函數（防重複初始化）
        function initializeOrderManagement() {
            try {
                const ordersList = DOMCache.get('ordersList');
                const statusFilter = DOMCache.get('statusFilter');
                
                if (!ordersList || !statusFilter) {
                    // 訂單管理DOM元素未就緒，延遲重試
                    setTimeout(initializeOrderManagement, 100);
                    return;
                }
                
                // 防止重複初始化
                if (SystemState.orderManagementInitialized) {
                    // 確保狀態篩選器事件監聽器正常工作
                    if (!SystemState.statusFilterInitialized) {
                        initializeStatusFilter();
                    }
                    // 重新啟動監聽器
                    listManager.startListening('orders');
                    return;
                }
            } catch (error) {
                console.error('訂單管理初始化錯誤:', error);
                return;
            }
            
            // 確保統一管理器已初始化
            if (typeof listManager === 'undefined') {
                initializeListConfigs();
            }
            
            // 初始化狀態篩選器（只初始化一次）
            initializeStatusFilter();
            
            // 開始監聽訂單列表
            listManager.startListening('orders');
            
            // 標記為已初始化
            SystemState.orderManagementInitialized = true;
        }
        
        // 重置系統狀態（僅供內部使用）
        function resetSystemState() {
            SystemState.reset();
        }

        // 訂單列表監聽函數（相容性保留）
        function listenOrdersList() {
            // 直接重新啟動監聽器
            if (typeof listManager !== 'undefined') {
                listManager.startListening('orders');
            }
        }

        // 防重複渲染邏輯已整合到 SystemState 中
        
        async function renderOrdersList(uniqueOrders) {
            const ordersList = DOMCache.get('ordersList');
            
            if (!ordersList) {
                console.error('❌ renderOrdersList: ordersList元素不存在');
                return;
            }
            
            // 統一獲取statusFilter，避免重複
            const statusFilter = DOMCache.get('statusFilter');
            const currentFilter = statusFilter ? statusFilter.value : 'unknown';
            // 開始渲染訂單列表
            
            // 生成當前訂單數據的簡單雜湊值
            const currentHash = JSON.stringify(Object.keys(uniqueOrders).sort());
            const currentTime = Date.now();
            
            // 防止短時間內重複渲染相同數據
            if (currentHash === SystemState.lastOrdersHash && (currentTime - SystemState.lastOrdersRenderTime) < 1000) {
                return;
            }
            
            SystemState.lastOrdersHash = currentHash;
            SystemState.lastOrdersRenderTime = currentTime;
            ordersList.innerHTML = '';
            
            // 如果沒有訂單數據
            if (Object.keys(uniqueOrders).length === 0) {
                // 使用已獲取的statusFilter
                const selectedStatus = statusFilter ? statusFilter.value : 'all';
                const message = selectedStatus === 'all' ? '暫無訂單資料' : `暫無「${getStatusName(selectedStatus)}」狀態的訂單`;
                ordersList.innerHTML = `<tr><td colspan="7" class="table-empty">${message}</td></tr>`;
                return;
            }
            
            try {
                // 批量獲取所有需要的會員資料
                const phoneNumbers = [...new Set(Object.values(uniqueOrders).map(order => order.phone).filter(phone => phone))];
                const memberDataMap = new Map();
                
                if (phoneNumbers.length > 0) {
                    try {
                        // 使用 Promise.all 並行獲取會員資料
                        const memberPromises = phoneNumbers.map(phone => 
                            db.collection('members').doc(phone).get()
                        );
                        const memberDocs = await Promise.all(memberPromises);
                        
                        memberDocs.forEach((doc, index) => {
                            if (doc.exists) {
                                memberDataMap.set(phoneNumbers[index], doc.data());
                            }
                        });
                    } catch (error) {
                        // 批量載入會員資料失敗，使用預設值
                    }
                }
                
                // 轉換為數組並按時間排序（前端排序）
                const ordersArray = Object.entries(uniqueOrders).map(([id, order]) => ({
                    id,
                    ...order
                }));
                
                // 按創建時間降序排序（最新的在前）
                ordersArray.sort((a, b) => {
                    const timeA = a.createdAt ? (
                        typeof a.createdAt.toDate === 'function' ? 
                        a.createdAt.toDate().getTime() : 
                        new Date(a.createdAt).getTime()
                    ) : 0;
                    
                    const timeB = b.createdAt ? (
                        typeof b.createdAt.toDate === 'function' ? 
                        b.createdAt.toDate().getTime() : 
                        new Date(b.createdAt).getTime()
                    ) : 0;
                    
                    return timeB - timeA; // 降序排列
                });
                
                // 渲染訂單列表
                for (const order of ordersArray) {
                    const { id } = order;
                    const memberData = memberDataMap.get(order.phone) || null;
                    
                    // 計算最終金額（使用會員等級）
                    const finalAmount = await calculateFinalAmount(order.amount, memberData?.level || 'basic', memberData);
                    
                    const row = document.createElement('tr');
                    let actionButtons = '';
                    if (order.status === 'completed') {
                        actionButtons = `<td>
                            <button class="order-action-btn btn-info btn-sm" onclick="showOrderDetails('${id}')">查看</button>
                        </td>`;
                    } else {
                        actionButtons = `<td>
                            <button class="order-action-btn btn-primary btn-sm" onclick="showOrderDetails('${id}')">查看</button>
                        </td>`;
                    }
                    
                    row.innerHTML = `
                        <td>${order.orderNumber || id}</td> <!-- id 現在就是訂單編號 -->
                        <td>${order.phone}</td>
                        <td>${getPaymentTypeName(order.paymentType)}</td>
                        <td>${order.amount.toFixed(2)}</td>
                        <td>${Math.round(finalAmount)}</td>
                        <td>${getStatusName(order.status)}</td>
                        ${actionButtons}
                    `;
                    ordersList.appendChild(row);
                }
            } catch (error) {
                console.error('Error rendering orders:', error);
                ordersList.innerHTML = '<tr><td colspan="7">載入訂單時發生錯誤</td></tr>';
            }
        }

        // 手動刷新訂單列表
        function refreshOrdersList() {
            // 直接重新啟動監聽器，不重複初始化
            if (typeof listManager !== 'undefined') {
                listManager.startListening('orders');
            }
        }























        // 狀態過濾功能，切換時重新監聽（改進版）
        function initializeStatusFilter() {
            if (SystemState.statusFilterInitialized) {
                // 狀態篩選器已初始化，跳過
                return;
            }
            
            // 使用EventManager統一管理事件監聽器
            const success = EventManager.addListener('statusFilter', 'change', statusFilterHandler);
            if (success) {
                SystemState.statusFilterInitialized = true;
                // 狀態篩選器初始化完成
            } else {
                console.error('❌ 無法找到狀態篩選器元素');
            }
        }

        // 狀態篩選處理函數（強制重新渲染）
        function statusFilterHandler() {
            const statusFilter = DOMCache.get('statusFilter');
            const selectedStatus = statusFilter ? statusFilter.value : 'unknown';
            // 狀態篩選器變更
            
            // 清除快取的雜湊值，強制重新渲染
            SystemState.lastOrdersHash = null;
            SystemState.lastOrdersRenderTime = 0;
            
            // 重新啟動監聽器並觸發重新渲染
            if (typeof listManager !== 'undefined') {
                // 停止現有訂單監聽器
                listManager.stopListening('orders');
                
                // 短暫延遲後重新啟動，確保查詢被重建
                setTimeout(() => {
                    // 重新啟動訂單監聽器
                    listManager.startListening('orders');
                }, 100);
            } else {
                console.error('❌ listManager 未定義');
            }
        }

        // 注意：狀態篩選器將在initializeOrderManagement函數中統一初始化



        // 獲取設定（使用統一的FirebaseCache系統）
        async function getSettings() {
            try {
                const settingsResult = await FirebaseCache.getDoc('settings', 'procurement');
                return settingsResult.exists ? settingsResult.data : {};
            } catch (error) {
                console.error('Error fetching settings:', error);
                return {};
            }
        }
        
        // 清除設定快取（使用統一的FirebaseCache系統）
        function clearSettingsCache() {
            FirebaseCache.clearCollection('settings');
        }

        // 檢查會員到期日
        async function checkMemberExpiry() {
            try {
                const now = new Date();
                const membersSnapshot = await db.collection('members')
                    .where('level', 'in', ['tenThousand', 'fiftyThousand', 'negotiable'])
                    .get();

                const updatePromises = [];
                membersSnapshot.forEach(doc => {
                    const member = doc.data();
                    if (member.expiry) {
                        const expiryDate = new Date(member.expiry);
                        if (expiryDate < now) {
                            // 會員已到期，更新為基礎會員
                            updatePromises.push(
                                db.collection('members').doc(doc.id).update({
                                    level: 'basic',
                                    expiry: '',
                                    updatedAt: new Date().toISOString(),
                                    lastUpdated: new Date().toISOString() // 添加最後更新時間戳
                                })
                            );
                        }
                    }
                });

                if (updatePromises.length > 0) {
                    await Promise.all(updatePromises);
                }
            } catch (error) {
                console.error('檢查會員到期日時發生錯誤:', error);
            }
        }

        // 初始化現有資料的 lastUpdated 字段（僅需執行一次）
        async function initializeLastUpdatedFields() {
            try {
                // 初始化會員資料
                const membersSnapshot = await db.collection('members').get();
                const memberUpdatePromises = [];
                
                membersSnapshot.forEach(doc => {
                    const member = doc.data();
                    if (!member.lastUpdated) {
                        // 使用現有的 updatedAt 或 joinDate 作為初始值
                        const lastUpdated = member.updatedAt || member.joinDate || new Date().toISOString();
                        memberUpdatePromises.push(
                            db.collection('members').doc(doc.id).update({
                                lastUpdated: lastUpdated
                            })
                        );
                    }
                });

                // 初始化訂單資料
                const ordersSnapshot = await db.collection('orders').get();
                const orderUpdatePromises = [];
                
                ordersSnapshot.forEach(doc => {
                    const order = doc.data();
                    if (!order.lastUpdated) {
                        // 使用現有的 completedAt、updatedAt 或 createdAt 作為初始值
                        const lastUpdated = order.completedAt || order.updatedAt || order.createdAt || new Date().toISOString();
                        orderUpdatePromises.push(
                            db.collection('orders').doc(doc.id).update({
                                lastUpdated: lastUpdated
                            })
                        );
                    }
                });

                // 執行所有更新
                if (memberUpdatePromises.length > 0) {
                    await Promise.all(memberUpdatePromises);
    
                }
                
                if (orderUpdatePromises.length > 0) {
                    await Promise.all(orderUpdatePromises);
    
                }
                
            } catch (error) {
                console.error('初始化 lastUpdated 字段時發生錯誤:', error);
            }
        }

        // 保存預計完成時間
        async function saveExpectedTime(dateTime) {
            try {
                await db.collection('orders').doc(currentOrderId).update({
                    expectedCompletionTime: dateTime.toISOString(),
                    lastUpdated: new Date().toISOString() // 添加最後更新時間戳
                });
                
                // 更新顯示
                const expectedTimeDisplay = document.getElementById('modalExpectedDateTime');
                if (expectedTimeDisplay) {
                    expectedTimeDisplay.innerHTML = formatDateTimeTwoLines(dateTime.toISOString());
                }
                
                // 訂單列表會通過實時監聽自動更新
            } catch (error) {
                console.error('Error updating expected time:', error);
                alert('更新預計完成時間失敗');
            }
        }

        // 快速時間編輯功能
        async function openQuickTimeEdit() {
            try {
                if (!currentOrderId) {
                    alert('無法確定訂單ID');
                    return;
                }
                
                // 關閉訂單詳情模態框並打開時間選擇模態框
                ModalManager.hide('orderModal');
                await showTimeSelectionModal(currentOrderId);
            } catch (error) {
                console.error('快速時間編輯失敗:', error);
                alert('開啟時間編輯視窗失敗，請重試。');
            }
        }


    </script>
    <!-- 添加彈出視窗結構 -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('orderModal')">&times;</span>
            <h2>詳情</h2>
            <div class="order-modal-content">
            <div class="order-details">
                <div class="order-header">
                    <div class="order-status">
                        <span id="modalStatus" class="status-badge"></span>
                    </div>
                    <div class="order-number">
                        訂單編號：<span id="modalOrderId"></span>
                    </div>
                </div>
                
                <div class="order-info-grid">
                    <div class="info-card order-info-highlight">
                        <div class="info-value order-info-member">
                            <div class="order-info-member-level" id="modalMemberLevel">-</div>
                            <div class="order-info-member-phone" id="modalMemberPhone">-</div>
                        </div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">建立時間</div>
                        <div class="info-value" id="modalCreatedAt"></div>
                    </div>
                    <div class="info-card order-time-card" id="expectedTimeCard" onclick="openQuickTimeEdit()" title="點擊修改時間">
                        <div class="info-label">預計完成時間</div>
                        <div class="info-value" id="modalExpectedTime">
                            <div id="modalExpectedDateTime" class="datetime-display"></div>
                        </div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">支付類型</div>
                        <div class="info-value" id="modalPaymentType"></div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">申請金額</div>
                        <div class="info-value" id="modalAmount"></div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">實付金額</div>
                        <div class="info-value highlight" id="modalFinalAmount"></div>
                    </div>
                </div>

                <!-- 其他平台連結資訊 -->
                <div id="othersInfoSection" class="order-info-section order-section-hidden">
                    <h3>其他平台資訊</h3>
                    <div class="info-grid">
                        <div class="info-item order-item-hidden" id="othersProductLinkItem">
                            <div class="info-label">商品連結</div>
                            <div class="info-value">
                                <a id="othersProductLinkValue" href="#" target="_blank" class="link-display">查看連結</a>
                            </div>
                        </div>
                        <div class="info-item order-item-hidden" id="othersDescriptionItem">
                            <div class="info-label">備註說明</div>
                            <div class="info-value" id="othersDescriptionValue"></div>
                        </div>
                    </div>
                </div>

                <div class="order-images-section">
                    <h3>圖片</h3>
                    <div id="modalImages" class="image-gallery"></div>
                </div>

                <!-- 訂單操作區域 - 位於最底部 -->
                <div id="orderActionsSection" class="order-actions-section order-section-hidden">
                    <div class="order-actions-buttons">
                        <!-- 待處理狀態顯示接收按鈕 -->
                        <button id="acceptOrderBtn" class="btn-primary btn-lg order-btn-width order-btn-hidden" onclick="showTimeSelectionForCurrentOrder()">
                            <span class="order-btn-icon">📨</span>
                            接收訂單
                        </button>
                        <!-- 處理中狀態顯示完成按鈕 -->
                        <button id="completeOrderBtn" class="btn-success btn-lg order-btn-width order-btn-hidden" onclick="completeCurrentOrder()">
                            <span class="order-btn-icon">✓</span>
                            完成訂單
                        </button>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 設定預計完成時間模態框 - 現代設計 -->
    <div id="timeSelectionModal" class="modal time-selection-modal">
        <div class="modal-content time-selection-content">
            <div class="modal-header">
                <h2 class="modal-title">設定預計完成時間</h2>
                <span class="close-btn" onclick="closeTimeSelectionModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="time-selection-wrapper">
                    <div class="date-time-group">
                        <div class="input-group date-group">
                            <label class="input-label">
                                <i class="icon-calendar">📅</i>
                                完成日期
                            </label>
                            <input type="text" id="expectedDate" class="date-time-input date-picker" placeholder="請選擇日期" readonly>
                        </div>
                        <div class="input-group time-group">
                            <label class="input-label">
                                <i class="icon-clock">🕐</i>
                                完成時間
                            </label>
                            <input type="text" id="expectedTime" class="date-time-input time-picker" placeholder="請選擇時間" readonly>
                        </div>
                    </div>
                    <div class="selected-datetime-display" id="selectedDateTimeDisplay">
                        <span class="display-label">預計完成時間：</span>
                        <span class="display-value">請選擇日期和時間</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="submitExpectedTime()" class="btn-confirm">
                    <i class="icon-check">✓</i>
                    設定
                </button>
                <button onclick="closeTimeSelectionModal()" class="btn-cancel">
                    取消
                </button>
            </div>
        </div>
    </div>
    <!-- 簡化的圖片預覽容器 -->
    <div id="imagePreview" class="image-preview">
        <span class="close" onclick="closeImagePreview()">&times;</span>
        <img id="previewImage" src="" alt="預覽圖片" class="preview-image-hidden">
    </div>
    <!-- 暫停歷史記錄模態框 - 小巧精美型 -->
    <div id="memberDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMemberDetails()">&times;</span>
            <h2>暫停記錄</h2>
            <div class="member-details-content">
                <div class="member-header">
                    <div class="member-phone">
                    <span id="detailMemberPhone"></span>
                    </div>
                </div>
                <div id="remarkHistorySection" class="member-history-section">
                    <div id="remarkHistoryList" class="history-list"></div>
                </div>
            </div>
        </div>
    </div>
        <!-- 編輯會員模態框 -->
    <div id="editMemberModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditMemberModal()">&times;</span>
            <h2>編輯會員資料</h2>
            <div class="edit-member-content">
            <form id="editMemberForm" class="member-form">
                <input type="hidden" id="editMemberPhone">
                <div class="form-group">
                    <label for="editMemberLevel">會員等級 <span id="editMemberPhoneDisplay" class="edit-member-phone-display"></span></label>
                    <select id="editMemberLevel" onchange="handleMemberLevelChange(this.value)">
                        <option value="basic">基礎會員</option>
                        <option value="tenThousand">滿萬會員</option>
                        <option value="fiftyThousand">五萬會員</option>
                        <option value="negotiable">議價會員</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editMemberExpiry">到期日期</label>
                    <input type="text" id="editMemberExpiry" class="date-picker" required>
                </div>
                <div class="form-group">
                    <label for="editMemberStatus">會員狀態</label>
                    <select id="editMemberStatus" onchange="handleStatusChange(this.value)">
                        <option value="pending">未審核</option>
                        <option value="active">核准</option>
                        <option value="suspended">暫停</option>
                    </select>
                </div>
                <div class="form-group form-group-hidden" id="remarkGroup">
                    <label for="editMemberRemark">備註</label>
                    <textarea id="editMemberRemark" rows="3"></textarea>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn-primary">保存</button>
                    <button type="button" onclick="closeEditMemberModal()">取消</button>
                </div>
                <!-- 刪除按鈕 - 僅未審核狀態顯示 -->
                <div class="delete-button-container form-group-hidden" id="deleteMemberContainer">
                    <button type="button" class="delete-member-btn" onclick="deleteMember()">
                        刪除會員
                    </button>
                </div>
            </form>
            </div>
        </div>
    </div>

    <!-- 確認模態框 -->
    <div id="confirmModal" class="modal confirm-modal">
        <div class="modal-content">
            <div class="confirm-icon">
                ⚠️
            </div>
            <div class="confirm-title" id="confirmTitle">確認操作</div>
            <div class="confirm-message" id="confirmMessage">您確定要執行此操作嗎？</div>
            <div class="confirm-buttons">
                <button class="confirm-btn confirm-btn-primary" id="confirmButton" onclick="confirmAction()">確認</button>
                <button class="confirm-btn confirm-btn-secondary" onclick="closeConfirmModal()">取消</button>
            </div>
        </div>
    </div>






    <!-- ===== 會員狀態管理器 (統一處理所有會員狀態變更) ===== -->
    <script>
        class MemberStateManager {
            // 統一的會員狀態更新方法
            static async updateMemberState(phone, newState) {
                try {
                    // 先獲取當前會員資料以處理歷史記錄
                    const currentMemberDoc = await db.collection('members').doc(phone).get();
                    const currentMember = currentMemberDoc.exists ? currentMemberDoc.data() : {};

                    const now = new Date().toISOString();
                    const updateData = {
                        updatedAt: now,
                        lastUpdated: now, // 添加用於排序的時間戳
                        ...newState
                    };

                    // 處理備註歷史記錄
                    await this.handleRemarkHistory(updateData, currentMember);

                    // 根據狀態自動清理相關欄位，確保資料一致性
                    this.enforceDataConsistency(updateData);

                    await db.collection('members').doc(phone).update(updateData);
                    return { success: true };
                } catch (error) {
                    console.error('Error updating member state:', error);
                    return { success: false, error };
                }
            }

            // 處理備註歷史記錄 - 最多保留5筆
            static async handleRemarkHistory(updateData, currentMember) {
                const currentTime = new Date().toISOString();
                let remarkHistory = currentMember.remarkHistory || [];

                // 如果狀態從其他狀態變為暫停，且有備註
                if (updateData.status === 'suspended' && updateData.remark) {
                    const historyEntry = {
                        action: 'suspended',
                        remark: updateData.remark,
                        timestamp: currentTime,
                        previousStatus: currentMember.status || 'unknown'
                    };
                    
                    // 只保留暫停記錄（過濾掉其他記錄）
                    remarkHistory = remarkHistory.filter(entry => entry.action === 'suspended');
                    
                    // 添加新記錄
                    remarkHistory.push(historyEntry);
                    
                    // 按時間排序（最新的在前）
                    remarkHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    // 只保留最新的5筆記錄，超過的刪除
                    if (remarkHistory.length > 5) {
                        remarkHistory = remarkHistory.slice(0, 5);
                    }
                }

                // 更新歷史記錄
                updateData.remarkHistory = remarkHistory;
            }

            // 獲取狀態中文名稱
            static getStatusName(status) {
                const statusNames = {
                    'pending': '未審核',
                    'active': '正常',
                    'suspended': '暫停'
                };
                return statusNames[status] || status;
            }

            // 強制資料一致性
            static enforceDataConsistency(updateData) {
                // 非暫停狀態時清空當前備註（但保留歷史記錄）
                if (updateData.status && updateData.status !== 'suspended') {
                    updateData.remark = '';
                }

                // 基礎會員時清空到期日
                if (updateData.level === 'basic') {
                    updateData.expiry = '';
                }

                // 未授權會員強制為基礎會員
                if (updateData.status === 'pending' || updateData.status === 'suspended') {
                    updateData.level = 'basic';
                    updateData.expiry = '';
                }
            }

            // 獲取會員的完整規範化資料
            static async getNormalizedMemberData(phone) {
                try {
                    const memberDoc = await db.collection('members').doc(phone).get();
                    if (!memberDoc.exists) return null;

                    const memberData = memberDoc.data();
                    this.enforceDataConsistency(memberData);
                    return memberData;
                } catch (error) {
                    console.error('Error getting member data:', error);
                    return null;
                }
            }
        }

        // ===== 統一表單狀態控制器 (根本性解決方案) =====
        class FormStateController {
            constructor() {
                this.elements = {
                    phone: document.getElementById('editMemberPhone'),
                    level: document.getElementById('editMemberLevel'), 
                    status: document.getElementById('editMemberStatus'),
                    expiry: document.getElementById('editMemberExpiry'),
                    remark: document.getElementById('editMemberRemark'),
                    remarkGroup: document.getElementById('remarkGroup'),
                    deleteContainer: document.getElementById('deleteMemberContainer')
                };
                this.isUpdating = false; // 防止循環更新
            }

            // 統一的狀態規則定義
            static getStateRules(status, level) {
                const rules = {
                    levelEditable: status === 'active',
                    expiryEditable: status === 'active' && level !== 'basic',
                    expiryRequired: status === 'active' && level !== 'basic',
                    remarkVisible: status === 'suspended',
                    remarkRequired: status === 'suspended',
                    deleteVisible: status === 'pending', // 只有未審核狀態才顯示刪除按鈕
                    forcedLevel: (status === 'pending' || status === 'suspended') ? 'basic' : level,
                    forcedExpiry: (status === 'pending' || status === 'suspended' || level === 'basic') ? '' : null
                };
                return rules;
            }

            // 統一應用所有狀態規則
            applyStateRules(status, level) {
                if (this.isUpdating) return; // 防止循環更新
                this.isUpdating = true;

                try {
                    const rules = FormStateController.getStateRules(status, level);
                    
                    // 1. 強制值更新
                    if (rules.forcedLevel !== level) {
                        this.elements.level.value = rules.forcedLevel;
                        level = rules.forcedLevel; // 更新本地變數
                    }
                    
                    if (rules.forcedExpiry !== null) {
                        this.elements.expiry.value = rules.forcedExpiry;
                    } else if (rules.expiryRequired && !this.elements.expiry.value) {
                        // 自動設置一年後到期日
                        const oneYearLater = new Date();
                        oneYearLater.setDate(oneYearLater.getDate() + 365);
                        this.elements.expiry.value = oneYearLater.toISOString().split('T')[0];
                    }

                    // 2. 可編輯性控制
                    this.setFieldEditable(this.elements.level, rules.levelEditable);
                    this.setFieldEditable(this.elements.expiry, rules.expiryEditable);

                    // 3. 必填狀態控制
                    this.setFieldRequired(this.elements.expiry, rules.expiryRequired);
                    this.setFieldRequired(this.elements.remark, rules.remarkRequired);

                    // 4. 顯示/隱藏控制
                    this.setGroupVisible(this.elements.remarkGroup, rules.remarkVisible);
                    this.setGroupVisible(this.elements.deleteContainer, rules.deleteVisible);

                    // 5. 標籤更新
                    this.updateLabels();

                } finally {
                    this.isUpdating = false;
                }
            }

            // 設置欄位可編輯性
            setFieldEditable(element, editable) {
                if (!element) return;
                
                element.disabled = !editable;
                element.style.backgroundColor = editable ? '' : '#f5f5f5';
                element.style.color = editable ? '' : '#999';
                element.title = '';
            }

            // 設置欄位必填狀態
            setFieldRequired(element, required) {
                if (!element) return;
                
                if (required) {
                    element.setAttribute('required', '');
                } else {
                    element.removeAttribute('required');
                }
            }

            // 設置群組顯示/隱藏
            setGroupVisible(group, visible) {
                if (!group) return;
                group.style.display = visible ? 'block' : 'none';
            }

            // 更新標籤文字
            updateLabels() {
                const expiryLabel = this.elements.expiry?.previousElementSibling;
                if (!expiryLabel) return;

                expiryLabel.textContent = '到期日期';
            }

            // 清理相關欄位值
            clearRelatedFields(status) {
                if (status !== 'suspended') {
                    this.elements.remark.value = '';
                }
            }

            // 初始化表單（修復異步處理）
            async initializeForm(memberData) {
                if (!memberData) return false;

                try {
                    // 設置基本值
                    this.elements.phone.value = memberData.phone || '';
                    this.elements.level.value = memberData.level || 'basic';
                    this.elements.status.value = memberData.status || 'pending';
                    this.elements.remark.value = memberData.remark || '';
                    this.elements.expiry.value = memberData.expiry || '';

                    // 應用狀態規則
                    this.applyStateRules(memberData.status || 'pending', memberData.level || 'basic');

                    // 異步初始化日期選擇器
                    await this.initializeDatePicker();

                    return true;
                } catch (error) {
                    console.error('表單初始化失敗:', error);
                    return false;
                }
            }

            // 初始化日期選擇器（修復異步處理）
            async initializeDatePicker() {
                try {
                    if (window.editMemberDatePicker) {
                        window.editMemberDatePicker.destroy();
                        window.editMemberDatePicker = null;
                    }

                    // 等待 Flatpickr 載入
                    await this.waitForFlatpickr();

                    // 初始化日期選擇器
                    const picker = createSafeFlatpickr("#editMemberExpiry", {
                        locale: "zh_tw",
                        dateFormat: "Y-m-d",
                        minDate: "today",
                        disableMobile: true
                    });

                    // 處理異步返回的結果
                    if (!picker && typeof picker !== 'object') {
                        // 等待異步初始化完成
                        await new Promise((resolve) => {
                            let attempts = 0;
                            const checkPicker = () => {
                                if (window.editMemberDatePicker || attempts > 20) {
                                    resolve();
                                } else {
                                    attempts++;
                                    setTimeout(checkPicker, 100);
                                }
                            };
                            checkPicker();
                        });
                    } else {
                        window.editMemberDatePicker = picker;
                    }

                    // 最終檢查
                    if (!window.editMemberDatePicker) {
                        console.warn('日期選擇器初始化未完成，使用基本輸入框');
                        const input = document.getElementById('editMemberExpiry');
                        if (input) {
                            input.type = 'date';
                            input.min = new Date().toISOString().split('T')[0];
                        }
                    } else {
                        console.info('會員到期日選擇器初始化成功');
                    }
                } catch (error) {
                    console.error('日期選擇器初始化失敗:', error);
                    // 降級到原生日期輸入
                    const input = document.getElementById('editMemberExpiry');
                    if (input) {
                        input.type = 'date';
                        input.min = new Date().toISOString().split('T')[0];
                    }
                }
            }

            // 等待 Flatpickr 載入完成
            async waitForFlatpickr(maxAttempts = 50) {
                return new Promise((resolve) => {
                    let attempts = 0;
                    const checkFlatpickr = () => {
                        if (typeof flatpickr !== 'undefined') {
                            resolve();
                        } else if (attempts < maxAttempts) {
                            attempts++;
                            setTimeout(checkFlatpickr, 100);
                        } else {
                            console.warn('Flatpickr 載入超時');
                            resolve(); // 即使超時也要繼續
                        }
                    };
                    checkFlatpickr();
                });
            }
        }

        // 全域表單控制器實例
        let formController = null;

        // ===== 簡化的 UI 管理器 =====
        class EditModalManager {
            static async initializeModal(memberData) {
                if (!memberData) return false;
                
                try {
                    // 創建或獲取表單控制器
                    if (!formController) {
                        formController = new FormStateController();
                    }
                    
                    return await formController.initializeForm(memberData);
                } catch (error) {
                    console.error('模態框初始化失敗:', error);
                    return false;
                }
            }
        }


    </script>
    </div> <!-- 關閉主要內容容器 -->

    <script>
        // 登錄相關功能
        // 身份驗證狀態管理 - 統一由 AuthManager 控制
        // ⚠️ 不再使用全局 isAuthenticated 變數，改用 AuthManager 統一管理
        let isAuthenticated = false; // 保留變數以維持向後兼容，但僅作為狀態同步
        
        // ⚠️ 安全提醒：客戶端密碼僅用於基本訪問控制，重要操作需要服務端驗證
        const ADMIN_PASSWORD = (function() {
            // 簡單的密碼混淆（不是真正的安全措施，僅防止直接查看）
            const encoded = '303835393738'; // hex encoded
            return Array.from({length: encoded.length/2}, (_, i) => 
                String.fromCharCode(parseInt(encoded.substr(i*2, 2), 16))
            ).join('');
        })();
        
        // 安全鎖定相關
        let loginAttempts = 0;
        let isTemporaryLocked = false;
        let isPermanentlyBlocked = false;
        let lockoutTimer = null;

        // 檢查登錄狀態 - 使用 Firebase 會話管理（修正版）
        async function checkAuthenticationStatus() {
            const hash = window.location.hash.replace('#', '');
            
            // ⚠️ 修正邏輯：先檢查實際登錄狀態，再決定是否顯示登錄頁面
            console.info('🔍 開始身份驗證檢查...');
            
            // 優先檢查本地登錄狀態（最快速的檢查）
            const localAuthStatus = AuthManager.checkAuthenticated();
            if (localAuthStatus) {
                console.info('✅ 本地登錄狀態有效，清除 #Login 並顯示主內容');
                // 清除可能存在的 #Login hash
                if (hash === 'Login') {
                    history.replaceState(null, null, window.location.pathname + window.location.search);
                }
                isAuthenticated = true;
                showMainContent();
                return true;
            }
            
            // 如果本地狀態無效，檢查 Firebase 中的會話狀態
            try {
                // 先檢查 Firebase 是否可用
                if (!isFirebaseAvailable()) {
                    throw new Error('Firebase 不可用，跳過 Firebase 會話檢查');
                }
                
                const deviceId = getUserFingerprint();
                const sessionDoc = await db.collection('adminSessions').doc(`session_${deviceId}`).get();
                
                if (sessionDoc.exists) {
                    const sessionData = sessionDoc.data();
                    const now = Date.now();
                    const sessionCreated = sessionData.createdAt?.toMillis() || 0;
                    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小時過期
                    
                    // 檢查會話是否有效且未過期
                    if (sessionData.isAuthenticated && (now - sessionCreated < sessionTimeout)) {
                        // 使用 AuthManager 設置本地狀態
                        AuthManager.setAuthenticated();
                        isAuthenticated = true; // 同步舊變數
                        showMainContent();
                        
                        // 更新最後活動時間
                        await db.collection('adminSessions').doc(`session_${deviceId}`).update({
                            lastActivity: firebase.firestore.Timestamp.now()
                        });
                        
                        return true;
                    } else {
                        // 會話過期，清除記錄
                        await db.collection('adminSessions').doc(`session_${deviceId}`).delete();
                    }
                }
                
                // 備用檢查本地登錄狀態（持久化）
                if (AuthManager.checkAuthenticated()) {
                    isAuthenticated = true; // 同步舊變數
                    showMainContent();
                    console.info('✅ 使用本地 localStorage 恢復登錄狀態');
                    
                    // 延長登錄時間並同步到 Firebase
                    AuthManager.extendSession();
                    await createFirebaseSession(deviceId);
                    return true;
                }
                
            } catch (error) {
                console.error('檢查 Firebase 會話狀態失敗:', error);
                console.error('錯誤詳情:', {
                    code: error.code,
                    message: error.message,
                    stack: error.stack
                });
                
                // 檢查是否為權限錯誤
                if (error.code === 'permission-denied') {
                    console.warn('Firebase 權限不足，建議檢查 Firestore 安全規則是否正確部署');
                    console.info('請確認以下 Firestore 規則已正確設置:');
                    console.info(`
                    match /adminSessions/{sessionId} {
                      allow read: if sessionId.matches('session_.*');
                      allow create: if sessionId.matches('session_.*') &&
                                       request.resource.data.keys().hasAll(['isAuthenticated', 'createdAt', 'lastActivity']);
                      allow update: if sessionId.matches('session_.*') &&
                                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastActivity']);
                      allow delete: if sessionId.matches('session_.*');
                    }
                    `);
                }
                
                // Firebase 失敗時使用本地狀態作為備用
                if (AuthManager.checkAuthenticated()) {
                    console.info('✅ 使用本地 localStorage 作為備用認證方式');
                    isAuthenticated = true; // 同步舊變數
                    showMainContent();
                    return true;
                } else {
                    console.warn('本地 localStorage 也沒有有效的認證狀態');
                }
            }
            
            // 最終檢查：如果所有方式都失敗，顯示登錄頁面
            console.warn('🚫 所有身份驗證方式都失敗，顯示登錄頁面');
            
            // 只有在當前不是登錄頁面時才設置 hash
            if (hash !== 'Login') {
                window.location.hash = 'Login';
            }
            
            isAuthenticated = false;
            await showLoginPage();
            return false;
        }

        // 顯示登錄頁面
        async function showLoginPage() {
            console.info('🔐 顯示登錄頁面，隱藏主要內容');
            const { loginContainer, mainContent, adminPassword } = DOMManager.getMultiple([
                'loginContainer', 'mainContent', 'adminPassword'
            ]);
            
            if (loginContainer) {
                loginContainer.style.display = 'flex';
            }
            if (mainContent) {
                mainContent.classList.remove('authenticated');
            }
            
            // 檢查設備鎖定狀態
            await checkIPBlocking();
            
            if (!isPermanentlyBlocked && !isTemporaryLocked) {
                adminPassword?.focus();
                setupPasswordListener();
            }
            
            console.info('✅ 登錄頁面已顯示');
        }

        // 顯示主要內容
        function showMainContent() {
            console.info('🏠 顯示主要內容，隱藏登錄頁面');
            const { loginContainer, mainContent } = DOMManager.getMultiple([
                'loginContainer', 'mainContent'
            ]);
            
            if (loginContainer) {
                loginContainer.style.display = 'none';
            }
            if (mainContent) {
                mainContent.classList.add('authenticated');
            }
            
            console.info('✅ 主要內容已顯示');
        }

        // 檢查設備鎖定狀態（使用Firebase）
        async function checkIPBlocking() {
            try {
                // 先檢查 Firebase 是否可用
                if (!isFirebaseAvailable()) {
                    console.info('Firebase 不可用，跳過設備鎖定狀態檢查');
                    isTemporaryLocked = false;
                    isPermanentlyBlocked = false;
                    return;
                }
                
                const deviceId = getUserFingerprint();
                const securityDoc = await db.collection('security').doc(`device_${deviceId}`).get();
                
                if (securityDoc.exists) {
                    const data = securityDoc.data();
                    loginAttempts = data.attempts || 0;
                    
                    // 檢查永久封禁
                    if (data.permanentBlock) {
                        isPermanentlyBlocked = true;
                        showPermanentBlock();
                        return;
                    }
                    
                    // 檢查臨時鎖定（1分鐘）
                    if (loginAttempts >= 3 && loginAttempts < 5) {
                        const now = Date.now();
                        const lastAttemptTime = data.lastAttempt?.toMillis() || 0;
                        const lockDuration = 60 * 1000; // 1分鐘
                        
                        if (now - lastAttemptTime < lockDuration) {
                            isTemporaryLocked = true;
                            const remainingTime = Math.ceil((lockDuration - (now - lastAttemptTime)) / 1000);
                            showTemporaryLock(remainingTime);
                            return;
                        } else {
                            // 鎖定時間已過，重置嘗試次數
                            await db.collection('security').doc(`device_${deviceId}`).delete();
                            loginAttempts = 0;
                        }
                    }
                } else {
                    loginAttempts = 0;
                }
                
                isTemporaryLocked = false;
            } catch (error) {
                console.error('檢查安全狀態失敗:', error);
                // 如果Firebase連接失敗，允許正常使用但記錄錯誤
                isTemporaryLocked = false;
                isPermanentlyBlocked = false;
            }
        }

        // 創建 Firebase 會話記錄
        async function createFirebaseSession(deviceId) {
            try {
                // 先檢查 Firebase 是否可用
                if (!isFirebaseAvailable()) {
                    console.info('Firebase 不可用，跳過會話記錄創建');
                    return;
                }
                
                await db.collection('adminSessions').doc(`session_${deviceId}`).set({
                    isAuthenticated: true,
                    createdAt: firebase.firestore.Timestamp.now(),
                    lastActivity: firebase.firestore.Timestamp.now(),
                    deviceInfo: {
                        userAgent: navigator.userAgent,
                        platform: navigator.platform,
                        language: navigator.language,
                        screen: `${window.screen.width}x${window.screen.height}`,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    }
                });
            } catch (error) {
                console.error('創建 Firebase 會話失敗:', error);
            }
        }

        // 清除 Firebase 會話記錄
        async function clearFirebaseSession(deviceId) {
            try {
                // 先檢查 Firebase 是否可用
                if (!isFirebaseAvailable()) {
                    console.info('Firebase 不可用，跳過會話記錄清除');
                    return;
                }
                
                await db.collection('adminSessions').doc(`session_${deviceId}`).delete();
            } catch (error) {
                console.error('清除 Firebase 會話失敗:', error);
            }
        }

        // 獲取用戶標識（結合多種指紋技術）
        function getUserFingerprint() {
            // 創建設備指紋（結合多種瀏覽器特徵）
            const screen = `${window.screen.width}x${window.screen.height}x${window.screen.colorDepth}`;
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const language = navigator.language;
            const platform = navigator.platform;
            const userAgent = navigator.userAgent;
            
            // Canvas指紋
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Device fingerprint', 2, 2);
            const canvasFingerprint = canvas.toDataURL();
            
            // 組合所有特徵生成唯一標識
            const combined = `${screen}_${timezone}_${language}_${platform}_${canvasFingerprint.slice(-20)}`;
            
            // 生成簡短的哈希值
            let hash = 0;
            for (let i = 0; i < combined.length; i++) {
                const char = combined.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // 轉換為32位整數
            }
            return Math.abs(hash).toString(36);
        }

        // 設置密碼輸入監聽器
        function setupPasswordListener() {
            const passwordInput = document.getElementById('adminPassword');
            
            // 移除舊的事件監聽器
            passwordInput.removeEventListener('input', handlePasswordInput);
            
            // 添加新的事件監聽器
            passwordInput.addEventListener('input', handlePasswordInput);
        }

        // 處理密碼輸入
        function handlePasswordInput(event) {
            if (isTemporaryLocked || isPermanentlyBlocked) {
                return;
            }
            
            // 確保只允許數字輸入
            const originalValue = event.target.value;
            const filteredValue = originalValue.replace(/[^0-9]/g, '');
            
            if (originalValue !== filteredValue) {
                event.target.value = filteredValue;
            }
            
            const enteredPassword = filteredValue;
            
            // 當輸入長度達到密碼長度時自動驗證
            if (enteredPassword.length === ADMIN_PASSWORD.length) {
                setTimeout(() => {
                    validatePassword(enteredPassword);
                }, 100);
            }
        }

        // 驗證密碼
        async function validatePassword(enteredPassword) {
            const passwordInput = document.getElementById('adminPassword');
            const errorDiv = document.getElementById('loginError');
            const deviceId = getUserFingerprint();
            
            if (enteredPassword === ADMIN_PASSWORD) {
                // 登錄成功 - 清除所有記錄
                await clearLoginAttempts(deviceId);
                
                // 使用 AuthManager 設置持久化登錄狀態
                AuthManager.setAuthenticated();
                isAuthenticated = true; // 同步舊變數
                await createFirebaseSession(deviceId);
                
                // 清除密碼輸入和錯誤訊息
                passwordInput.value = '';
                errorDiv.style.display = 'none';
                document.getElementById('lockoutMessage').style.display = 'none';
                
                // 移除Login hash並顯示主要內容
                console.info('🎉 登錄成功，清除 #Login hash 並顯示主內容');
                history.replaceState(null, null, window.location.pathname + window.location.search);
                showMainContent();
                
                // 初始化主要內容
                setTimeout(() => {
                    if (typeof initializeAfterLogin === 'function') {
                        initializeAfterLogin();
                    }
                }, 100);
                
            } else {
                // 登錄失敗
                await handleLoginFailure(deviceId);
            }
        }

        // 處理登錄失敗（使用Firebase）
        async function handleLoginFailure(deviceId) {
            const passwordInput = document.getElementById('adminPassword');
            const errorDiv = document.getElementById('loginError');
            
            try {
                loginAttempts++;
                
                // 更新Firebase中的記錄
                const securityData = {
                    attempts: loginAttempts,
                    lastAttempt: firebase.firestore.Timestamp.now(),
                    deviceInfo: {
                        userAgent: navigator.userAgent,
                        platform: navigator.platform,
                        language: navigator.language,
                        screen: `${window.screen.width}x${window.screen.height}`,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    },
                    updatedAt: firebase.firestore.Timestamp.now()
                };
                
                if (loginAttempts >= 5) {
                    // 第5次錯誤 - 永久封禁
                    securityData.permanentBlock = true;
                    securityData.blockedAt = firebase.firestore.Timestamp.now();
                }
                
                await db.collection('security').doc(`device_${deviceId}`).set(securityData);
                
                // 清除密碼輸入
                passwordInput.value = '';
                
                if (loginAttempts >= 5) {
                    isPermanentlyBlocked = true;
                    showPermanentBlock();
                } else if (loginAttempts >= 3) {
                    // 第3-4次錯誤 - 臨時鎖定1分鐘
                    isTemporaryLocked = true;
                    showTemporaryLock(60);
                } else {
                    // 前2次錯誤 - 顯示錯誤訊息
                    errorDiv.textContent = `密碼錯誤 (${loginAttempts}/5)`;
                    errorDiv.style.display = 'block';
                    passwordInput.focus();
                    
                    // 添加錯誤動畫
                    passwordInput.style.borderColor = 'var(--error-color)';
                    setTimeout(() => {
                        passwordInput.style.borderColor = '';
                        errorDiv.style.display = 'none';
                    }, 2000);
                }
            } catch (error) {
                console.error('記錄登錄失敗狀態時發生錯誤:', error);
                // 如果Firebase寫入失敗，仍然顯示本地錯誤訊息
                errorDiv.textContent = `密碼錯誤 (${loginAttempts}/5)`;
                errorDiv.style.display = 'block';
                passwordInput.focus();
            }
        }

        // 顯示臨時鎖定
        function showTemporaryLock(seconds) {
            const passwordInput = document.getElementById('adminPassword');
            const errorDiv = document.getElementById('loginError');
            const lockoutDiv = document.getElementById('lockoutMessage');
            
            passwordInput.disabled = true;
            passwordInput.style.backgroundColor = '#f5f5f5';
            errorDiv.style.display = 'none';
            
            function updateLockMessage() {
                if (seconds > 0) {
                    lockoutDiv.textContent = `連續錯誤，請等待 ${seconds} 秒後重試`;
                    lockoutDiv.style.display = 'block';
                    seconds--;
                    lockoutTimer = setTimeout(updateLockMessage, 1000);
                } else {
                    // 解除鎖定
                    isTemporaryLocked = false;
                    passwordInput.disabled = false;
                    passwordInput.style.backgroundColor = '';
                    lockoutDiv.style.display = 'none';
                    passwordInput.focus();
                }
            }
            
            updateLockMessage();
        }

        // 顯示永久封禁
        function showPermanentBlock() {
            const passwordInput = document.getElementById('adminPassword');
            const errorDiv = document.getElementById('loginError');
            const lockoutDiv = document.getElementById('lockoutMessage');
            
            passwordInput.disabled = true;
            passwordInput.style.backgroundColor = '#f5f5f5';
            errorDiv.style.display = 'none';
            
            lockoutDiv.textContent = '該IP已被永久封禁，請聯繫管理員';
            lockoutDiv.style.display = 'block';
            lockoutDiv.style.color = 'var(--error-color)';
        }

        // 清除登錄嘗試記錄（使用Firebase）
        async function clearLoginAttempts(deviceId) {
            try {
                await db.collection('security').doc(`device_${deviceId}`).delete();
                loginAttempts = 0;
            } catch (error) {
                console.error('清除安全記錄失敗:', error);
                // 即使清除失敗也重置本地計數器
                loginAttempts = 0;
            }
        }

        // 登出功能 - 同時清除 Firebase 會話
        async function logout() {
            // 使用 AuthManager 清除登錄狀態
            AuthManager.clearAuthenticated();
            isAuthenticated = false; // 同步舊變數
            const deviceId = getUserFingerprint();
            await clearFirebaseSession(deviceId);
            
            // 清理統一管理器的所有監聽器
            if (typeof listManager !== 'undefined') {
                listManager.stopAllListening();
            }
            
            // 注意：系統級的訂單自動狀態檢查不會因為登出而停止
            // 這是獨立於登錄狀態的系統功能
            
            // 清理訂單詳情監聽器
            if (orderDetailsListener) {
                orderDetailsListener();
                orderDetailsListener = null;
            }
            
            // 清理所有事件監聽器
            EventManager.clearAll();
            
            // 清理DOM緩存
            DOMCache.clearAll();
            
            // 清理Firebase緩存
            FirebaseCache.clearAll();
            
            // 重置所有系統狀態
            if (typeof resetSystemState === 'function') {
                resetSystemState();
            }
            
            // 清理定時器
            if (lockoutTimer) {
                clearTimeout(lockoutTimer);
                lockoutTimer = null;
            }
            
            // 重置鎖定狀態
            isTemporaryLocked = false;
            
            window.location.hash = 'Login';
            showLoginPage();
        }

        // 載入狀態管理
        function showLoadingStatus(message) {
            let loadingDiv = document.getElementById('globalLoadingStatus');
            if (!loadingDiv) {
                loadingDiv = document.createElement('div');
                loadingDiv.id = 'globalLoadingStatus';
                loadingDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #3b82f6, #2563eb);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                    z-index: 8888;
                    font-weight: 500;
                    font-size: 14px;
                    transition: all 0.3s ease;
                    opacity: 0;
                `;
                document.body.appendChild(loadingDiv);
            }
            
            loadingDiv.textContent = message;
            loadingDiv.style.opacity = '1';
        }

        function hideLoadingStatus() {
            const loadingDiv = document.getElementById('globalLoadingStatus');
            if (loadingDiv) {
                loadingDiv.style.opacity = '0';
                setTimeout(() => {
                    if (loadingDiv.parentNode) {
                        loadingDiv.parentNode.removeChild(loadingDiv);
                    }
                }, 300);
            }
        }

        // 設置頁面載入邏輯（移除重複的認證檢查，統一使用DOMContentLoaded）

        // 高性能數據預載入系統（支援持久化快取）
        const DataPreloader = {
            cache: new Map(),
            loadingStatus: new Map(),
            persistentCache: {
                // 持久化快取管理
                set(key, data, expireMinutes = 10) {
                    const item = {
                        data: data,
                        timestamp: Date.now(),
                        expires: Date.now() + (expireMinutes * 60 * 1000)
                    };
                    try {
                        localStorage.setItem(`admin_cache_${key}`, JSON.stringify(item));
                    } catch (error) {
                        console.warn('快取儲存失敗:', error);
                    }
                },
                
                get(key) {
                    try {
                        const item = localStorage.getItem(`admin_cache_${key}`);
                        if (!item) return null;
                        
                        const parsed = JSON.parse(item);
                        if (Date.now() > parsed.expires) {
                            this.remove(key);
                            return null;
                        }
                        
                        return parsed.data;
                    } catch (error) {
                        console.warn('快取讀取失敗:', error);
                        return null;
                    }
                },
                
                remove(key) {
                    try {
                        localStorage.removeItem(`admin_cache_${key}`);
                    } catch (error) {
                        console.warn('快取清除失敗:', error);
                    }
                },
                
                clear() {
                    try {
                        Object.keys(localStorage).forEach(key => {
                            if (key.startsWith('admin_cache_')) {
                                localStorage.removeItem(key);
                            }
                        });
                    } catch (error) {
                        console.warn('快取全清失敗:', error);
                    }
                }
            },
            
            // 並行預載入所有數據（支援快取恢復）
            async preloadAllData() {
                if (!isFirebaseAvailable()) {
                    console.warn('Firebase 不可用，嘗試使用快取數據...');
                    return this.loadFromCache();
                }
                
                console.info('🚀 開始並行預載入所有數據...');
                const startTime = performance.now();
                
                try {
                    // 首先嘗試從快取載入（重新整理優化）
                    const cacheLoadSuccess = this.loadFromCache();
                    if (cacheLoadSuccess) {
                        console.info('⚡ 從快取快速載入數據成功');
                        // 在背景中更新數據
                        this.updateDataInBackground();
                        return true;
                    }
                    
                    // 並行載入所有核心數據
                    const dataPromises = [
                        this.preloadDashboardData(),
                        this.preloadMembersData(),
                        this.preloadOrdersData()
                    ];
                    
                    const results = await Promise.allSettled(dataPromises);
                    
                    // 記錄載入結果
                    results.forEach((result, index) => {
                        const dataType = ['儀表板', '會員', '訂單'][index];
                        if (result.status === 'fulfilled') {
                            console.info(`✅ ${dataType}數據預載入成功`);
                        } else {
                            console.warn(`⚠️ ${dataType}數據預載入失敗:`, result.reason);
                        }
                    });
                    
                    const loadTime = performance.now() - startTime;
                    console.info(`📊 數據預載入完成，耗時: ${Math.round(loadTime)}ms`);
                    
                    return true;
                } catch (error) {
                    console.error('❌ 數據預載入失敗:', error);
                    // 嘗試從快取恢復
                    return this.loadFromCache();
                }
            },
            
            // 從快取載入數據（重新整理時立即可用）
            loadFromCache() {
                try {
                    const dashboardData = this.persistentCache.get('dashboard');
                    const membersData = this.persistentCache.get('members');
                    const ordersData = this.persistentCache.get('orders');
                    
                    let hasAnyCache = false;
                    
                    if (dashboardData) {
                        this.cache.set('dashboard', dashboardData);
                        this.updateDashboardUI(dashboardData);
                        hasAnyCache = true;
                        console.info('📦 儀表板快取載入成功');
                    }
                    
                    if (membersData) {
                        this.cache.set('members', membersData);
                        hasAnyCache = true;
                        console.info('📦 會員快取載入成功');
                    }
                    
                    if (ordersData) {
                        this.cache.set('orders', ordersData);
                        hasAnyCache = true;
                        console.info('📦 訂單快取載入成功');
                    }
                    
                    if (hasAnyCache) {
                        console.info('⚡ 快取數據載入完成，頁面立即可用');
                    }
                    
                    return hasAnyCache;
                } catch (error) {
                    console.error('快取載入失敗:', error);
                    return false;
                }
            },
            
            // 在背景中更新數據
            async updateDataInBackground() {
                console.info('🔄 在背景中更新數據...');
                
                try {
                    // 延遲 1 秒後開始背景更新，不影響使用者體驗
                    setTimeout(async () => {
                        const dataPromises = [
                            this.preloadDashboardData(),
                            this.preloadMembersData(),
                            this.preloadOrdersData()
                        ];
                        
                        await Promise.allSettled(dataPromises);
                        console.info('🔄 背景數據更新完成');
                    }, 1000);
                } catch (error) {
                    console.error('背景更新失敗:', error);
                }
            },
            
            // 預載入儀表板數據
            async preloadDashboardData() {
                const dashboardData = {};
                
                // 並行載入儀表板統計數據
                const [todayOrders, pendingOrders, completedOrders, totalMembers] = await Promise.all([
                    this.getTodayOrdersCount(),
                    this.getPendingOrdersCount(),
                    this.getCompletedTodayCount(),
                    this.getTotalMembersCount()
                ]);
                
                dashboardData.todayOrders = todayOrders;
                dashboardData.pendingOrders = pendingOrders;
                dashboardData.completedOrders = completedOrders;
                dashboardData.totalMembers = totalMembers;
                
                this.cache.set('dashboard', dashboardData);
                
                // 保存到持久化快取
                this.persistentCache.set('dashboard', dashboardData, 10);
                
                // 立即更新 UI
                this.updateDashboardUI(dashboardData);
                
                return dashboardData;
            },
            
            // 預載入會員數據
            async preloadMembersData() {
                const snapshot = await db.collection('members').get();
                const membersData = [];
                
                snapshot.forEach(doc => {
                    membersData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                this.cache.set('members', membersData);
                
                // 保存到持久化快取
                this.persistentCache.set('members', membersData, 15);
                
                return membersData;
            },
            
            // 預載入訂單數據（限制數量以提升性能）
            async preloadOrdersData() {
                const snapshot = await db.collection('orders')
                    .orderBy('createdAt', 'desc')
                    .limit(100) // 限制載入數量
                    .get();
                    
                const ordersData = [];
                snapshot.forEach(doc => {
                    ordersData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                this.cache.set('orders', ordersData);
                
                // 保存到持久化快取
                this.persistentCache.set('orders', ordersData, 5);
                
                return ordersData;
            },
            
            // 取得今日訂單數
            async getTodayOrdersCount() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const snapshot = await db.collection('orders')
                    .where('createdAt', '>=', firebase.firestore.Timestamp.fromDate(today))
                    .get();
                    
                return snapshot.size;
            },
            
            // 取得待處理訂單數
            async getPendingOrdersCount() {
                const snapshot = await db.collection('orders')
                    .where('status', 'in', ['pending', 'processing'])
                    .get();
                    
                return snapshot.size;
            },
            
            // 取得今日完成訂單數
            async getCompletedTodayCount() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const snapshot = await db.collection('orders')
                    .where('status', '==', 'completed')
                    .get();
                    
                let count = 0;
                snapshot.forEach(doc => {
                    const order = doc.data();
                    if (order.completedAt) {
                        const completedDate = new Date(order.completedAt);
                        if (completedDate >= today) {
                            count++;
                        }
                    }
                });
                
                return count;
            },
            
            // 取得總會員數
            async getTotalMembersCount() {
                const snapshot = await db.collection('members').get();
                return snapshot.size;
            },
            
            // 立即更新儀表板 UI
            updateDashboardUI(data) {
                const elements = {
                    'todayOrders': data.todayOrders || 0,
                    'pendingOrders': data.pendingOrders || 0,
                    'processingOrders': data.completedOrders || 0,
                    'totalMembers': data.totalMembers || 0
                };
                
                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                        element.classList.add('data-loaded'); // 添加載入完成樣式
                    }
                });
            },
            
            // 取得快取數據
            getCache(key) {
                return this.cache.get(key);
            },
            
            // 檢查數據是否已載入
            isDataLoaded(key) {
                return this.cache.has(key);
            }
        };

        // 創建在登錄後執行的初始化函數（全面重構）
        async function initializeAfterLogin() {
            try {
                // 1. 初始化DOM緩存系統
                DOMCache.preload();
                
                // 2. 初始化統一列表管理器配置
                initializeListConfigs();
                
                // 3. 立即顯示首頁
                handleHashChange();
                
                // 4. 並行預載入所有數據（關鍵優化）
                const dataPreloadTimer = PerformanceMonitor.measureDataPreload();
                const preloadSuccess = await DataPreloader.preloadAllData();
                dataPreloadTimer();
                
                // 5. 基於預載入數據同步初始化所有組件
                if (preloadSuccess) {
                    // 同步初始化所有組件（不使用 setTimeout）
                    initializeDashboardSync();
                    initializeMembersListSync();
                    
                    // 設置實時監聽器（用於數據更新）
                    setTimeout(() => {
                        setupRealtimeListeners();
                    }, 1000);
                } else {
                    // 回退到原有的異步載入方式
                    console.warn('數據預載入失敗，使用回退載入方式');
                    initializeDashboard();
                    setTimeout(() => initializeMembersList(), 100);
                }
                
                // 6. 延遲初始化訂單管理（僅在需要時）
                const currentHash = window.location.hash.replace('#', '');
                if (currentHash === 'order') {
                    setTimeout(() => initializeOrderManagement(), 200);
                }
                
                // 7. 延遲執行會員到期檢查
                setTimeout(() => {
                    checkMemberExpiry();
                    setInterval(checkMemberExpiry, 60 * 60 * 1000);
                }, 300000);
                
            } catch (error) {
                console.error('頁面初始化失敗:', error);
                alert('頁面初始化失敗: ' + error.message);
            }
        }
        
        // 同步初始化儀表板（使用預載入數據）
        function initializeDashboardSync() {
            const dashboardData = DataPreloader.getCache('dashboard');
            if (dashboardData) {
                console.info('✅ 使用預載入數據同步顯示儀表板');
                DataPreloader.updateDashboardUI(dashboardData);
            }
            
            // 延遲載入圖表
            setTimeout(() => {
                if (typeof Chart !== 'undefined') {
                    initializeCharts();
                } else {
                    const waitForChart = () => {
                        if (typeof Chart !== 'undefined') {
                            initializeCharts();
                        } else {
                            setTimeout(waitForChart, 200);
                        }
                    };
                    setTimeout(waitForChart, 1000);
                }
            }, 500);
        }
        
        // 同步初始化會員列表（使用預載入數據）
        function initializeMembersListSync() {
            const membersData = DataPreloader.getCache('members');
            if (membersData) {
                console.info('✅ 使用預載入數據同步顯示會員列表');
                // 轉換為 Firestore snapshot 格式以兼容現有邏輯
                const mockSnapshot = {
                    empty: membersData.length === 0,
                    size: membersData.length,
                    forEach: (callback) => {
                        membersData.forEach(member => {
                            callback({
                                id: member.id,
                                data: () => member
                            });
                        });
                    }
                };
                
                // 如果目前在會員頁面，立即渲染
                if (window.location.hash.replace('#', '') === 'member') {
                    renderMembersList(mockSnapshot);
                }
            }
        }
        
        // 設置實時監聽器（用於數據更新）
        function setupRealtimeListeners() {
            console.info('🔄 設置實時數據監聽器');
            setupDashboardListeners();
            listManager.startListening('members');
        }

        // 監聽hash變化（包括登錄頁面）
        window.addEventListener('hashchange', async function() {
            const hash = window.location.hash.replace('#', '');
            if (hash === 'Login') {
                logout(); // 如果手動導航到登錄頁面，執行登出
            } else if (isAuthenticated) {
                handleHashChange(); // 只有在已認證的情況下才處理其他hash變化
            }
        });

        // 代碼完整性檢查和衝突預防
        function validateCodeIntegrity() {
            const issues = [];
            
            // 檢查身份驗證函數是否存在
            if (typeof checkAuthenticationStatus !== 'function') {
                issues.push('❌ checkAuthenticationStatus 函數未定義');
            }
            if (typeof AuthManager === 'undefined') {
                issues.push('❌ AuthManager 未定義');
            }
            
            // 檢查 DOM 元素是否存在
            if (!document.getElementById('loginContainer')) {
                issues.push('❌ loginContainer 元素不存在');
            }
            if (!document.getElementById('mainContent')) {
                issues.push('❌ mainContent 元素不存在');
            }
            
            // 檢查是否有重複的 DOMContentLoaded 監聽器
            const scripts = document.querySelectorAll('script');
            let domContentLoadedCount = 0;
            scripts.forEach(script => {
                if (script.textContent.includes('DOMContentLoaded')) {
                    domContentLoadedCount++;
                }
            });
            
            if (domContentLoadedCount > 1) {
                issues.push(`⚠️ 發現 ${domContentLoadedCount} 個 DOMContentLoaded 監聽器，可能導致重複初始化`);
            }
            
            // 輸出檢查結果
            if (issues.length === 0) {
                console.info('✅ 代碼完整性檢查通過');
                return true;
            } else {
                console.group('⚠️ 代碼完整性檢查發現問題');
                issues.forEach(issue => console.warn(issue));
                console.groupEnd();
                return false;
            }
        }
        
        // 代碼衝突預防和版本管理
        if (typeof window.AdminSystem !== 'undefined') {
            console.warn('⚠️ AdminSystem 命名空間已存在，可能存在代碼衝突');
            console.info('當前版本:', window.AdminSystem.version);
        }
        
        // 重新整理優化檢測
        const RefreshOptimizer = {
            isRefresh: performance.navigation?.type === 1 || 
                      performance.getEntriesByType('navigation')[0]?.type === 'reload',
            
            cacheHitRate: 0,
            loadMethod: 'unknown',
            
            init() {
                if (this.isRefresh) {
                    console.info('🔄 檢測到頁面重新整理，啟用快速載入模式');
                    this.loadMethod = 'refresh-optimized';
                } else {
                    console.info('🆕 首次載入頁面');
                    this.loadMethod = 'first-load';
                }
                
                // 檢測快取命中率
                this.measureCachePerformance();
            },
            
            measureCachePerformance() {
                // 檢測資源載入來源
                const entries = performance.getEntriesByType('resource');
                let cacheHits = 0;
                let totalResources = 0;
                
                entries.forEach(entry => {
                    if (entry.transferSize === 0 && entry.decodedBodySize > 0) {
                        cacheHits++;
                    }
                    totalResources++;
                });
                
                this.cacheHitRate = totalResources > 0 ? (cacheHits / totalResources * 100).toFixed(1) : 0;
                console.info(`📊 快取命中率: ${this.cacheHitRate}%`);
            }
        };

        // 身份驗證狀態管理器（重新整理持久化）
        const AuthManager = {
            SESSION_TIMEOUT: 24 * 60 * 60 * 1000, // 24小時
            
            // 設置登錄狀態
            setAuthenticated() {
                const now = Date.now();
                localStorage.setItem('adminAuthenticated', 'true');
                localStorage.setItem('adminLoginTime', now.toString());
                console.info('✅ 登錄狀態已設置', new Date(now).toLocaleString());
            },
            
            // 檢查登錄狀態
            checkAuthenticated() {
                const authStatus = localStorage.getItem('adminAuthenticated');
                const loginTime = localStorage.getItem('adminLoginTime');
                
                if (authStatus !== 'true' || !loginTime) {
                    return false;
                }
                
                const now = Date.now();
                const loginTimestamp = parseInt(loginTime);
                const isValid = now - loginTimestamp < this.SESSION_TIMEOUT;
                
                if (!isValid) {
                    this.clearAuthenticated();
                    console.info('🔄 登錄狀態已過期');
                    return false;
                }
                
                return true;
            },
            
            // 清除登錄狀態
            clearAuthenticated() {
                localStorage.removeItem('adminAuthenticated');
                localStorage.removeItem('adminLoginTime');
                console.info('🔄 登錄狀態已清除');
            },
            
            // 延長登錄時間
            extendSession() {
                if (this.checkAuthenticated()) {
                    const now = Date.now();
                    localStorage.setItem('adminLoginTime', now.toString());
                    console.info('⏰ 登錄時間已延長', new Date(now).toLocaleString());
                }
            },
            
            // 取得登錄資訊
            getLoginInfo() {
                const authStatus = localStorage.getItem('adminAuthenticated');
                const loginTime = localStorage.getItem('adminLoginTime');
                
                if (authStatus === 'true' && loginTime) {
                    const loginTimestamp = parseInt(loginTime);
                    const now = Date.now();
                    const elapsed = now - loginTimestamp;
                    const remaining = this.SESSION_TIMEOUT - elapsed;
                    
                    return {
                        isAuthenticated: this.checkAuthenticated(),
                        loginTime: new Date(loginTimestamp),
                        elapsedTime: elapsed,
                        remainingTime: remaining,
                        expiryTime: new Date(loginTimestamp + this.SESSION_TIMEOUT)
                    };
                }
                
                return {
                    isAuthenticated: false,
                    loginTime: null,
                    elapsedTime: 0,
                    remainingTime: 0,
                    expiryTime: null
                };
            }
        };

        // 設置版本信息和初始化狀態
        window.AdminSystem = {
            version: '2.4.2', // 身份驗證修正版本
            lastUpdated: new Date().toISOString(),
            isInitialized: false,
            firebaseAvailable: false,
            autoProcessorVersion: '1.0.0',
            features: {
                systemAutoProcessor: true,
                userAutoProcessorDisabled: true,
                parallelLoading: true, // 並行載入功能
                criticalPathOptimization: true, // 關鍵路徑優化
                refreshOptimization: true, // 重新整理優化
                persistentCache: true, // 持久化快取
                serviceWorkerCache: true // Service Worker 快取
            },
            performance: {
                startTime: performance.now(),
                firebaseLoadTime: 0,
                firstContentfulPaint: 0,
                loadComplete: 0,
                cacheHitRate: 0,
                loadMethod: 'unknown'
            },
            refresh: RefreshOptimizer
        };
        
        // 效能監控（增強版）
        const PerformanceMonitor = {
            logMetric(name, value) {
                window.AdminSystem.performance[name] = value;
                console.info(`📊 ${name}: ${Math.round(value)}ms`);
            },
            
            measureFirebaseLoad() {
                const start = performance.now();
                return () => {
                    this.logMetric('firebaseLoadTime', performance.now() - start);
                };
            },
            
            measureDataPreload() {
                const start = performance.now();
                return () => {
                    this.logMetric('dataPreloadTime', performance.now() - start);
                };
            },
            
            measureTotalLoad() {
                window.addEventListener('load', () => {
                    this.logMetric('loadComplete', performance.now() - window.AdminSystem.performance.startTime);
                    this.generateLoadReport();
                });
            },
            
            // 生成載入效能報告（增強版）
            generateLoadReport() {
                const perf = window.AdminSystem.performance;
                const report = {
                    載入方式: perf.loadMethod === 'refresh-optimized' ? '重新整理優化' : '首次載入',
                    總載入時間: Math.round(perf.loadComplete) + 'ms',
                    Firebase載入: Math.round(perf.firebaseLoadTime || 0) + 'ms',
                    數據預載入: Math.round(perf.dataPreloadTime || 0) + 'ms',
                    首屏渲染: Math.round(perf.firstContentfulPaint || 0) + 'ms',
                    快取命中率: perf.cacheHitRate + '%'
                };
                
                console.group('🚀 頁面載入效能報告');
                Object.entries(report).forEach(([key, value]) => {
                    const icon = this.getMetricIcon(key);
                    console.info(`${icon} ${key}: ${value}`);
                });
                console.groupEnd();
                
                // 評估載入效能（針對重新整理優化）
                const totalTime = perf.loadComplete;
                const isRefresh = perf.loadMethod === 'refresh-optimized';
                const cacheRate = parseFloat(perf.cacheHitRate);
                
                let grade = this.calculateGrade(totalTime, isRefresh, cacheRate);
                let performance = this.getPerformanceAnalysis(totalTime, isRefresh, cacheRate);
                
                console.info(`⭐ 載入效能評級: ${grade} (${Math.round(totalTime)}ms)`);
                console.info(`📈 ${performance}`);
                
                // Service Worker 狀態檢查
                this.checkServiceWorkerStatus();
            },
            
            getMetricIcon(key) {
                const icons = {
                    '載入方式': '🔄',
                    '總載入時間': '⏱️',
                    'Firebase載入': '🔥',
                    '數據預載入': '📊',
                    '首屏渲染': '🎨',
                    '快取命中率': '💾'
                };
                return icons[key] || '📋';
            },
            
            calculateGrade(totalTime, isRefresh, cacheRate) {
                let grade = 'A+';
                
                if (isRefresh) {
                    // 重新整理時的評分標準更嚴格
                    if (totalTime > 2000 || cacheRate < 30) grade = 'C';
                    else if (totalTime > 1000 || cacheRate < 50) grade = 'B';
                    else if (totalTime > 500 || cacheRate < 70) grade = 'A';
                } else {
                    // 首次載入的評分標準
                    if (totalTime > 3000) grade = 'C';
                    else if (totalTime > 2000) grade = 'B';
                    else if (totalTime > 1000) grade = 'A';
                }
                
                return grade;
            },
            
            getPerformanceAnalysis(totalTime, isRefresh, cacheRate) {
                if (isRefresh) {
                    if (totalTime < 500 && cacheRate > 70) {
                        return '重新整理優化效果優秀！快取策略運作良好。';
                    } else if (cacheRate < 30) {
                        return '快取命中率偏低，建議檢查 Service Worker 狀態。';
                    } else {
                        return '重新整理性能良好，仍有優化空間。';
                    }
                } else {
                    if (totalTime < 1000) {
                        return '首次載入速度優秀！';
                    } else {
                        return '首次載入性能良好，快取建立後會更快。';
                    }
                }
            },
            
            async checkServiceWorkerStatus() {
                try {
                    const status = await ServiceWorkerManager.getCacheStatus();
                    if (status) {
                        console.info(`🔧 Service Worker: 已快取 ${status.cachedResourcesCount} 個資源 (${status.cacheSize}KB)`);
                    } else {
                        console.warn('⚠️ Service Worker 未啟用或不支援');
                    }
                } catch (error) {
                    console.warn('Service Worker 狀態檢查失敗:', error);
                }
            }
        };
        
        PerformanceMonitor.measureTotalLoad();

        // Service Worker 註冊（重新整理優化）
        const ServiceWorkerManager = {
            async register() {
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register('/sw.js');
                        console.info('🔧 Service Worker 註冊成功');
                        
                        // 監聽更新
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.info('🔄 Service Worker 已更新，將在下次載入時生效');
                                }
                            });
                        });
                        
                        return registration;
                    } catch (error) {
                        console.warn('⚠️ Service Worker 註冊失敗:', error);
                        return null;
                    }
                } else {
                    console.warn('瀏覽器不支援 Service Worker');
                    return null;
                }
            },
            
            async getCacheStatus() {
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    return new Promise((resolve) => {
                        const channel = new MessageChannel();
                        channel.port1.onmessage = (event) => {
                            resolve(event.data.payload);
                        };
                        
                        navigator.serviceWorker.controller.postMessage(
                            { type: 'GET_CACHE_STATUS' },
                            [channel.port2]
                        );
                    });
                }
                return null;
            },
            
            async clearCache() {
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'CLEAR_CACHE' });
                }
            }
        };

        // 統一頁面初始化 - 徹底清理，避免代碼衝突
        document.addEventListener('DOMContentLoaded', async function() {
            // 防止重複初始化
            if (window.AdminSystem?.isInitialized) {
                console.warn('系統已初始化，跳過重複執行');
                return;
            }
            
            try {
                // 0. 初始化重新整理優化檢測
                RefreshOptimizer.init();
                window.AdminSystem.performance.cacheHitRate = RefreshOptimizer.cacheHitRate;
                window.AdminSystem.performance.loadMethod = RefreshOptimizer.loadMethod;
                
                // 1. 註冊 Service Worker（最高優先級）
                ServiceWorkerManager.register();
                
                // 2. 清理載入畫面
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    setTimeout(() => loadingScreen.remove(), 100);
                }
                
                // 3. 驗證代碼完整性
                if (!validateCodeIntegrity()) {
                    throw new Error('代碼完整性檢查失敗');
                }
                
                // 3. 初始化Firebase（優化載入）
                const firebaseTimer = PerformanceMonitor.measureFirebaseLoad();
                await SuperLazyLoader.loadFirebase();  
                firebaseTimer();
                const firebaseReady = initializeFirebase();
                if (!firebaseReady) {
                    console.warn('Firebase初始化失敗，部分功能可能無法使用');
                }
                
                // 4. 記錄Firebase狀態
                window.AdminSystem.firebaseAvailable = isFirebaseAvailable();
                
                // 5. 認證檢查 - 支援重新整理恢復
                console.info('🔄 檢查身份驗證狀態...');
                
                // 先檢查本地登錄狀態
                const localAuth = AuthManager.checkAuthenticated();
                if (localAuth) {
                    console.info('✅ 發現本地登錄狀態，嘗試恢復...');
                    const loginInfo = AuthManager.getLoginInfo();
                    console.info('📊 登錄資訊:', {
                        登錄時間: loginInfo.loginTime?.toLocaleString(),
                        剩餘時間: Math.round(loginInfo.remainingTime / 1000 / 60) + ' 分鐘',
                        過期時間: loginInfo.expiryTime?.toLocaleString()
                    });
                }
                
                const isAuth = await checkAuthenticationStatus();
                if (isAuth) {
                    console.info('🎉 身份驗證成功，初始化管理面板');
                    // 初始化主要功能
                    initializeAfterLogin();
                    
                    // 啟動自動處理器
                    if (window.AdminSystem.firebaseAvailable) {
                        setTimeout(startOrderAutoStatusCheck, 2000);
                    }
                } else {
                    console.info('❌ 身份驗證失敗，顯示登錄頁面');
                }
                
                // 6. 延遲載入非關鍵功能模組
                SuperLazyLoader.loadDatePicker();
                SuperLazyLoader.loadNonCritical();
                
                // 7. 初始化事件委託系統
                initializeEventDelegation();
                
                // 8. 標記初始化完成
                window.AdminSystem.isInitialized = true;
                console.info('✅ 系統初始化完成');
                
            } catch (error) {
                console.error('❌ 系統初始化失敗:', error);
                alert('系統初始化失敗: ' + error.message);
            }
        });

        // 登錄調試工具（管理員專用）- 升級版
        window.AuthDebug = {
            // 查看登錄狀態
            status() {
                const info = AuthManager.getLoginInfo();
                console.table({
                    '登錄狀態': info.isAuthenticated ? '✅ 已登錄' : '❌ 未登錄',
                    '登錄時間': info.loginTime ? info.loginTime.toLocaleString() : '無',
                    '已登錄時間': info.elapsedTime ? Math.round(info.elapsedTime / 1000 / 60) + ' 分鐘' : '無',
                    '剩餘時間': info.remainingTime > 0 ? Math.round(info.remainingTime / 1000 / 60) + ' 分鐘' : '無',
                    '過期時間': info.expiryTime ? info.expiryTime.toLocaleString() : '無'
                });
                return info;
            },
            
            // 延長登錄時間
            extend() {
                AuthManager.extendSession();
                console.info('✅ 登錄時間已延長');
                this.status();
            },
            
            // 清除登錄狀態
            clear() {
                AuthManager.clearAuthenticated();
                console.info('🔄 登錄狀態已清除');
            },
            
            // 模擬重新整理測試
            async testRefresh() {
                console.info('🧪 測試重新整理恢復...');
                const beforeRefresh = AuthManager.checkAuthenticated();
                console.info('重新整理前狀態:', beforeRefresh ? '✅ 已登錄' : '❌ 未登錄');
                
                // 模擬頁面重新載入的認證檢查
                const afterRefresh = await checkAuthenticationStatus();
                console.info('重新整理後狀態:', afterRefresh ? '✅ 已登錄' : '❌ 未登錄');
                
                return {
                    beforeRefresh,
                    afterRefresh,
                    success: beforeRefresh === afterRefresh
                };
            },
            
            // 診斷身份驗證問題
            async diagnose() {
                console.group('🔍 身份驗證診斷報告');
                
                // 檢查本地儲存
                const localAuth = localStorage.getItem('adminAuthenticated');
                const loginTime = localStorage.getItem('adminLoginTime');
                console.info('📱 本地儲存:', {
                    adminAuthenticated: localAuth,
                    adminLoginTime: loginTime ? new Date(parseInt(loginTime)).toLocaleString() : null
                });
                
                // 檢查 AuthManager 狀態
                const authStatus = AuthManager.checkAuthenticated();
                console.info('🔐 AuthManager 狀態:', authStatus ? '✅ 有效' : '❌ 無效');
                
                // 檢查全域變數
                console.info('🌐 全域變數 isAuthenticated:', isAuthenticated);
                
                // 檢查 URL hash
                const currentHash = window.location.hash;
                console.info('🔗 當前 URL hash:', currentHash || '(無)');
                
                // 檢查 DOM 元素顯示狀態
                const loginContainer = document.getElementById('loginContainer');
                const mainContent = document.getElementById('mainContent');
                console.info('🎨 DOM 顯示狀態:', {
                    loginContainer: loginContainer ? getComputedStyle(loginContainer).display : '(不存在)',
                    mainContent: mainContent ? mainContent.classList.contains('authenticated') : '(不存在)'
                });
                
                console.groupEnd();
                
                return {
                    localStorage: { localAuth, loginTime },
                    authManager: authStatus,
                    globalVar: isAuthenticated,
                    urlHash: currentHash,
                    dom: {
                        loginVisible: loginContainer?.style.display !== 'none',
                        mainAuthenticated: mainContent?.classList.contains('authenticated')
                    }
                };
            },
            
            // 強制重置身份驗證
            async reset() {
                console.info('🔄 強制重置身份驗證狀態...');
                
                // 清除所有狀態
                AuthManager.clearAuthenticated();
                isAuthenticated = false;
                
                // 清除 URL hash
                history.replaceState(null, null, window.location.pathname + window.location.search);
                
                // 顯示登錄頁面
                await showLoginPage();
                
                console.info('✅ 身份驗證狀態已重置');
            }
        };

        // 統一事件委託系統 - 替代內聯onclick
        function initializeEventDelegation() {
            // 處理導航點擊
            document.querySelectorAll('.nav-item[data-function]').forEach(nav => {
                nav.addEventListener('click', (e) => {
                    e.preventDefault();
                    const functionName = nav.getAttribute('data-function');
                    if (typeof switchFunction === 'function') {
                        switchFunction(functionName);
                    }
                });
            });
            
            // 處理按鈕點擊
            const buttonHandlers = {
                'settingsBtn': () => typeof showSettingsModal === 'function' && showSettingsModal(),
                'logoutBtn': () => typeof logout === 'function' && logout()
            };
            
            Object.entries(buttonHandlers).forEach(([id, handler]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('click', handler);
                }
            });
            
            console.info('事件委託系統已初始化');
        }


    </script>
</body>
</html> 